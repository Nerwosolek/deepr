<!doctype html>
<html class="no-js" lang="en">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />
<meta content="Deep R Programming" name="citation_title" />
<meta content="Marek Gagolewski" name="citation_author" />
<meta content="2023" name="citation_date" />
<meta content="2023" name="citation_publication_date" />
<meta content="https://deepr.gagolewski.com/deepr.pdf" name="citation_pdf_url" />
<meta content="https://deepr.gagolewski.com" name="citation_public_url" />
<meta content="10.5281/zenodo.7490464" name="citation_doi" />
<meta content="Deep R Programming is comprehensive course on one of the most popular languages in data science (statistical computing, graphics, machine learning, data wrangling and analytics). It introduces the base language in-depth and is aimed at ambitious students, practitioners, and researchers who would like to become independent users of this powerful environment. This textbook is a non-profit project. Its online and PDF versions are freely available at https://deepr.gagolewski.com/." name="citation_abstract" />
<meta content="summary" name="twitter:card" />
<meta content="Deep R Programming" name="twitter:title" />
<meta content="Deep R Programming" name="og:title" />
<meta content="Deep R Programming is comprehensive course on one of the most popular languages in data science (statistical computing, graphics, machine learning, data wrangling and analytics). It introduces the base language in-depth and is aimed at ambitious students, practitioners, and researchers who would like to become independent users of this powerful environment. This textbook is a non-profit project. Its online and PDF versions are freely available at https://deepr.gagolewski.com/." name="twitter:description" />
<meta content="Deep R Programming is comprehensive course on one of the most popular languages in data science (statistical computing, graphics, machine learning, data wrangling and analytics). It introduces the base language in-depth and is aimed at ambitious students, practitioners, and researchers who would like to become independent users of this powerful environment. This textbook is a non-profit project. Its online and PDF versions are freely available at https://deepr.gagolewski.com/." name="og:description" />
<meta content="gagolews/deepr" name="og:site_name" />
<meta content="https://deepr.gagolewski.com" name="og:url" />
<meta content="https://deepr.gagolewski.com/_images/cover.png" name="twitter:image" />
<meta content="https://deepr.gagolewski.com/_images/cover.png" name="og:image" />
<meta content="https://deepr.gagolewski.com" name="DC.identifier" />
<meta content="Marek Gagolewski" name="DC.publisher" />
<meta content="INDEX,FOLLOW" name="robots" />
<meta content="book" name="og:type" />
<meta content="9780645571929" name="og:book:isbn" />
<link rel="index" title="Index" href="../genindex.html" /><link rel="search" title="Search" href="../search.html" /><link rel="next" title="Changelog" href="998-changelog.html" /><link rel="prev" title="15. 🚧 Unevaluated expressions (**)" href="320-language.html" />
        <link rel="canonical" href="https://deepr.gagolewski.com/chapter/330-environment.html" />

    <link rel="shortcut icon" href="../_static/favicon.png"/><!-- Generated with Sphinx 5.3.0 and Furo 2022.12.07 -->
        <title>16. 🚧🚧 Environments and evaluation (**) - Deep R Programming</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?digest=91d0f0d1c444bdcb17a68e833c7a53903343c195" />
    <link rel="stylesheet" type="text/css" href="../_static/proof.css" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?digest=30d1aed668e5c3a91c3e3bf6a60b675221979f0e" />
    <link rel="stylesheet" type="text/css" href="../_static/css/custom.css" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  --admonition-font-size: 95%;
  --admonition-title-font-size: 95%;
  --color-brand-primary: red;
  --color-brand-content: #CC3333;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  --admonition-font-size: 95%;
  --admonition-title-font-size: 95%;
  --color-brand-primary: #ff2b53;
  --color-brand-content: #dd3333;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  --admonition-font-size: 95%;
  --admonition-title-font-size: 95%;
  --color-brand-primary: #ff2b53;
  --color-brand-content: #dd3333;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">Deep R Programming</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto colour theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky">

<span class="sidebar-brand-text">
<a class="sidebar-brand" href="../index.html">Deep R Programming</a>
</span>
<div class="sidebar-brand">
An open-access textbook<br />
by <a href='https://www.gagolewski.com' style="display: contents">Marek Gagolewski</a><br />
v0.1.13.9001 (draft)
</div>
<form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul>
<li class="toctree-l1"><a class="reference internal" href="../index.html">About</a></li>
<li class="toctree-l1"><a class="reference external" href="https://www.gagolewski.com/">Author</a></li>
<li class="toctree-l1"><a class="reference external" href="https://deepr.gagolewski.com/deepr.pdf">This Book in PDF</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/gagolews/deepr/">Report Bugs or Typos (GitHub)</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/gagolews/teaching-data">Datasets</a></li>
<li class="toctree-l1"><a class="reference external" href="https://datawranglingpy.gagolewski.com">Data Wrangling with Python</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Start Here</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="000-preface.html">Preface</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Deep</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="110-basics.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="120-numeric.html">2. Numeric vectors</a></li>
<li class="toctree-l1"><a class="reference internal" href="130-logical.html">3. Logical vectors</a></li>
<li class="toctree-l1"><a class="reference internal" href="140-list.html">4. Lists and attributes</a></li>
<li class="toctree-l1"><a class="reference internal" href="150-indexing.html">5. Vector indexing</a></li>
<li class="toctree-l1"><a class="reference internal" href="160-character.html">6. Character vectors</a></li>
<li class="toctree-l1"><a class="reference internal" href="170-function.html">7. Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="180-flow.html">8. Flow of execution</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Deeper</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="210-design.html">9. Designing functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="220-s3.html">10. S3 classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="230-matrix.html">11. Matrices and other arrays</a></li>
<li class="toctree-l1"><a class="reference internal" href="240-data-frame.html">12. Data frames</a></li>
<li class="toctree-l1"><a class="reference internal" href="250-graphics.html">13. 🚧🚧 Graphics</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Deepest</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="310-compiled.html">14. 🚧🚧 Interfacing compiled code (*)</a></li>
<li class="toctree-l1"><a class="reference internal" href="320-language.html">15. 🚧 Unevaluated expressions (**)</a></li>
<li class="toctree-l1 current current-page"><a class="current reference internal" href="#">16. 🚧🚧 Environments and evaluation (**)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Appendix</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="998-changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="999-bibliography.html">References</a></li>
</ul>

</div></div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="edit-this-page">
  <a class="muted-link" href="https://github.com/gagolews/deepr/issues/" title="Edit this page">
    <svg aria-hidden="true" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <path d="M4 20h4l10.5 -10.5a1.5 1.5 0 0 0 -4 -4l-10.5 10.5v4" />
      <line x1="13.5" y1="6.5" x2="17.5" y2="10.5" />
    </svg>
    <span class="visually-hidden">Edit this page</span>
  </a>
</div><div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto colour theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <section class="tex2jax_ignore mathjax_ignore" id="environments-and-evaluation">
<span id="chap-environment"></span><h1><span class="section-number">16. </span>🚧🚧 Environments and evaluation (**)<a class="headerlink" href="#environments-and-evaluation" title="Permalink to this heading">#</a></h1>
<blockquote>
<div><p><em>The open-access textbook</em>
Deep R Programming <em>by <a class="reference external" href="https://www.gagolewski.com">Marek Gagolewski</a>
is, and will remain, freely available for everyone’s enjoyment
(also in <a class="reference external" href="https://deepr.gagolewski.com/deepr.pdf">PDF</a>).
It is a non-profit project.</em>
<strong>This book is still a work in progress. Beta versions
of Chapters 1–12 are already complete, but there will be more.
In the meantime, any
<a class="reference external" href="https://github.com/gagolews/deepr/issues">bug/typos reports/fixes</a>
are appreciated.</strong>
<em>Although available online, it is a whole course;
it should be read from the beginning to the end.
Refer to the <a class="reference internal" href="000-preface.html#chap-preface"><span class="std std-ref">Preface</span></a> for general introductory remarks.</em>
<em>Also, check out my other book,
<a class="reference external" href="https://datawranglingpy.gagolewski.com/"><em>Minimalist Data Wrangling with Python</em></a>
<span id="id1">[<a class="reference internal" href="999-bibliography.html#id3" title="Gagolewski, M. (2022).  Minimalist Data Wrangling with Python. Zenodo, Melbourne. URL: https://datawranglingpy.gagolewski.com/, DOI: 10.5281/zenodo.6451068.">21</a>]</span>.</em></p>
</div></blockquote>
<p>In the first part of our book, we have discussed quite a few
<em>basic</em> object types: numeric, logical, and character vectors,
lists (generic vectors), and functions.</p>
<p><em>Environments</em>, which we introduce in this chapter, just like
lists, are instances of recursive types
(compare the diagram in <a class="reference internal" href="#fig-data-types-full"><span class="std std-numref">Figure 16.3</span></a>).</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Each object of type <em>environment</em> consists of:</p>
<ul class="simple">
<li><p>a <em>frame</em><a class="footnote-reference brackets" href="#footdf" id="id2" role="doc-noteref"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></a> (<a class="reference internal" href="#sec-frame-env"><span class="std std-numref">Section 16.1</span></a>), which
stores a set of <em>bindings</em>,
which associate variable names with their corresponding values;
it can be thought of as a container of named R objects of any type;</p></li>
<li><p>a reference to an <em>enclosing environment</em><a class="footnote-reference brackets" href="#footencpar" id="id3" role="doc-noteref"><span class="fn-bracket">[</span>2<span class="fn-bracket">]</span></a>
(<a class="reference internal" href="#sec-enclos-env"><span class="std std-numref">Section 16.2.2</span></a>), which might be queried (recursively!) in the
case where a requested named variable is not found in the current frame.</p></li>
</ul>
</div>
<p>Even though we rarely interact with them directly (unless we need
a hash table-like data structure with quick by-name element look-up),
they are crucial for the R interpreter itself.
Namely, they form the basis of the <em>environment model of evaluation</em>
which governs how expressions are computed (<a class="reference internal" href="#sec-env-mod-eval"><span class="std std-numref">Section 16.2</span></a>).</p>
<blockquote>
<div><p>🚧 <strong>This chapter is under construction. Please come back later.</strong></p>
</div></blockquote>
<section id="frames-environments-as-object-containers">
<span id="sec-frame-env"></span><h2><span class="section-number">16.1. </span>Frames: Environments as object containers<a class="headerlink" href="#frames-environments-as-object-containers" title="Permalink to this heading">#</a></h2>
<p>To create a new, empty environment,
we can call the <strong class="command">new.env</strong> function:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">e1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">new.env</span><span class="p">()</span>
<span class="nf">typeof</span><span class="p">(</span><span class="n">e1</span><span class="p">)</span>
<span class="c1">## [1] &quot;environment&quot;</span>
</pre></div>
</div>
<p>In this section, we treat environments merely as
containers for named objects of any kind, i.e.,
we deal with the <em>frame</em> part thereof.</p>
<p>Let us insert some elements into <code class="docutils literal notranslate"><span class="pre">e1</span></code>:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">e1</span><span class="p">[[</span><span class="s">&quot;x&quot;</span><span class="p">]]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s">&quot;x in e1&quot;</span>
<span class="n">e1</span><span class="p">[[</span><span class="s">&quot;y&quot;</span><span class="p">]]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="m">3</span>
</pre></div>
</div>
<p>The `<strong class="command">[[</strong>` operator provides us with a <em>named list</em>-like
look-and-feel. This is also the case with element extraction:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">e1</span><span class="p">[[</span><span class="s">&quot;x&quot;</span><span class="p">]]</span>
<span class="c1">## [1] &quot;x in e1&quot;</span>
<span class="n">e1</span><span class="p">[[</span><span class="s">&quot;spam&quot;</span><span class="p">]]</span><span class="w">  </span><span class="c1"># does not exist</span>
<span class="c1">## NULL</span>
<span class="n">e1</span><span class="p">[[</span><span class="s">&quot;y&quot;</span><span class="p">]]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">e1</span><span class="p">[[</span><span class="s">&quot;y&quot;</span><span class="p">]]</span><span class="o">*</span><span class="m">10</span><span class="w">  </span><span class="c1"># replace with new content</span>
<span class="n">e1</span><span class="p">[[</span><span class="s">&quot;z&quot;</span><span class="p">]]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="kc">NULL</span><span class="w">  </span><span class="c1"># unlike in the case of lists, creates a new element</span>
</pre></div>
</div>
<section id="printing">
<h3><span class="section-number">16.1.1. </span>Printing<a class="headerlink" href="#printing" title="Permalink to this heading">#</a></h3>
<p>Let us note that the printing of an environment is quite awkward:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">print</span><span class="p">(</span><span class="n">e1</span><span class="p">)</span><span class="w">  </span><span class="c1"># same with str(e1)</span>
<span class="c1">## &lt;environment: 0x563031e1b420&gt;</span>
</pre></div>
</div>
<p>This is the address where <code class="docutils literal notranslate"><span class="pre">e1</span></code> is stored
in computer’s memory, which can serve as the environment’s
unique identifier.</p>
<p>As we have said, these objects are rather of <em>internal</em> interest,
so nobody cared<a class="footnote-reference brackets" href="#footdiscourage" id="id4" role="doc-noteref"><span class="fn-bracket">[</span>3<span class="fn-bracket">]</span></a> about making the interaction therewith
particularly smooth.</p>
<p>However, we can easily get the list of objects stored
inside the container by calling <strong class="command">names</strong><a class="footnote-reference brackets" href="#footnamesattr" id="id5" role="doc-noteref"><span class="fn-bracket">[</span>4<span class="fn-bracket">]</span></a>:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">names</span><span class="p">(</span><span class="n">e1</span><span class="p">)</span><span class="w">  </span><span class="c1"># compare attr(e1, &quot;names&quot;) – it is not set</span>
<span class="c1">## [1] &quot;x&quot; &quot;y&quot; &quot;z&quot;</span>
</pre></div>
</div>
<p>Moreover, <strong class="command">length</strong> gives the number of objects in the container:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">length</span><span class="p">(</span><span class="n">e1</span><span class="p">)</span>
<span class="c1">## [1] 3</span>
</pre></div>
</div>
</section>
<section id="environments-vs-named-lists">
<span id="sec-env-vs-list"></span><h3><span class="section-number">16.1.2. </span>Environments vs named lists<a class="headerlink" href="#environments-vs-named-lists" title="Permalink to this heading">#</a></h3>
<p>Environment frames, in some sense, can be thought of
as named lists, but the set of admissible operations is severely restricted.
In particular, we cannot extract more than one element
at the same time with the index operator:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">e1</span><span class="p">[</span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;x&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;y&quot;</span><span class="p">)]</span><span class="w">  </span><span class="c1"># but see the mget function</span>
<span class="c1">## Error in e1[c(&quot;x&quot;, &quot;y&quot;)]: object of type &#39;environment&#39; is not subsettable</span>
</pre></div>
</div>
<p>nor can we refer to the elements by position:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">e1</span><span class="p">[[</span><span class="m">1</span><span class="p">]]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s">&quot;bad key&quot;</span>
<span class="c1">## Error in e1[[1]] &lt;- &quot;bad key&quot;: wrong args for environment subassignment</span>
</pre></div>
</div>
<div class="proof proof-type-exercise" id="id32">

    <div class="proof-title">
        <span class="proof-type">Exercise 16.1</span>
        
    </div><div class="proof-content">
<p>Check if <strong class="command">lapply</strong> and <strong class="command">Map</strong> can be applied
directly on environments.
Also, can we iterate over their elements using a <strong class="command">for</strong> loop?</p>
</div></div><p>Still, named lists can be converted to environments
and vice versa using <strong class="command">as.list</strong> and <strong class="command">as.environment</strong>.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">as.list</span><span class="p">(</span><span class="n">e1</span><span class="p">)</span>
<span class="c1">## $x</span>
<span class="c1">## [1] &quot;x in e1&quot;</span>
<span class="c1">##</span>
<span class="c1">## $y</span>
<span class="c1">## [1] 10 20 30</span>
<span class="c1">##</span>
<span class="c1">## $z</span>
<span class="c1">## NULL</span>
<span class="nf">as.environment</span><span class="p">(</span><span class="nf">list</span><span class="p">(</span><span class="n">u</span><span class="o">=</span><span class="m">42</span><span class="p">,</span><span class="w"> </span><span class="n">whatever</span><span class="o">=</span><span class="s">&quot;it&#39;s not going to be printed anyway&quot;</span><span class="p">))</span>
<span class="c1">## &lt;environment: 0x563031a72838&gt;</span>
<span class="nf">as.list</span><span class="p">(</span><span class="nf">as.environment</span><span class="p">(</span><span class="nf">list</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="o">=</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="o">=</span><span class="m">3</span><span class="p">)))</span><span class="w">  </span><span class="c1"># no duplicates allowed</span>
<span class="c1">## $y</span>
<span class="c1">## [1] 2</span>
<span class="c1">##</span>
<span class="c1">## $x</span>
<span class="c1">## [1] 3</span>
</pre></div>
</div>
</section>
<section id="hash-maps-fast-element-look-up-by-name">
<h3><span class="section-number">16.1.3. </span>Hash maps: Fast element look-up by name<a class="headerlink" href="#hash-maps-fast-element-look-up-by-name" title="Permalink to this heading">#</a></h3>
<p>Environment frames are internally implemented
using hash tables (hash maps; see, e.g., <span id="id6">[<a class="reference internal" href="999-bibliography.html#id58" title="Cormen, T.H., Leiserson, C.E., Rivest, R.L., and Stein, C. (2009).  Introduction to Algorithms. MIT Press and McGraw-Hill.">10</a>, <a class="reference internal" href="999-bibliography.html#id33" title="Knuth, D.E. (1997).  The Art of Computer Programming III: Sorting and Searching. Addison-Wesley.">34</a>]</span>)
with keys being character strings.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>A <em>hash table</em> is a data structure that allows for
a very quick<a class="footnote-reference brackets" href="#footquickhash" id="id7" role="doc-noteref"><span class="fn-bracket">[</span>5<span class="fn-bracket">]</span></a> lookup and insertion
of individual elements <em>by name</em>.</p>
</div>
<p>This comes at a price, including what we have already observed above:</p>
<ul class="simple">
<li><p>the elements are not particularly unordered:
they cannot be referred to with a numeric index;</p></li>
<li><p>all element names must be unique.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>A list may be considered a <em>sequence</em>,
but an environment frame is only in fact a <em>set</em> (a bag) of key–value pairs.
In the majority of numerical computing applications,
we would rather store, iterate over, and process all the elements
<em>in order</em>, hence the greater popularity of the former.
Lists still allow for an element look-up by name, even though this
is slightly slower<a class="footnote-reference brackets" href="#footlisttime" id="id8" role="doc-noteref"><span class="fn-bracket">[</span>6<span class="fn-bracket">]</span></a>. Hence, they are much more universal.</p>
</div>
<div class="proof proof-type-example" id="id33">

    <div class="proof-title">
        <span class="proof-type">Example 16.2</span>
        
    </div><div class="proof-content">
<p>A natural use case of manually-created environment frames
deals with grouping a series of objects identified by character string keys.</p>
<p>Consider a simple pseudocode for counting the number of occurrences
of objects in a given container:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">for </span><span class="p">(</span><span class="n">key</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">some_container</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nf">if </span><span class="p">(</span><span class="o">!</span><span class="nf">is.null</span><span class="p">(</span><span class="n">counter</span><span class="p">[[</span><span class="s">&quot;key&quot;</span><span class="p">]]))</span>
<span class="w">        </span><span class="n">counter</span><span class="p">[[</span><span class="s">&quot;key&quot;</span><span class="p">]]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">counter</span><span class="p">[[</span><span class="s">&quot;key&quot;</span><span class="p">]]</span><span class="m">+1</span>
<span class="w">    </span><span class="n">else</span>
<span class="w">        </span><span class="n">counter</span><span class="p">[[</span><span class="s">&quot;key&quot;</span><span class="p">]]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">1</span>
<span class="p">}</span>
</pre></div>
</div>
<p>If <code class="docutils literal notranslate"><span class="pre">some_container</span></code> is large, say, of size <span class="math notranslate nohighlight">\(n\)</span>
(let us say it is generated on the fly by reading some data stream),
then the run-time of the above will depend on the type of the data structure
used.
If <code class="docutils literal notranslate"><span class="pre">counter</span></code> is a list, then, theoretically, the worst-case performance
will be <span class="math notranslate nohighlight">\(O(n^2)\)</span> (if all keys are unique).
However, for environments, it is faster by an order of magnitude:
down to amortised <span class="math notranslate nohighlight">\(O(n)\)</span>.</p>
</div></div><div class="proof proof-type-exercise" id="id34">

    <div class="proof-title">
        <span class="proof-type">Exercise 16.3</span>
        
    </div><div class="proof-content">
<p>(*)
Implement the above pseudocode and benchmark the two data structures
using <strong class="command">proc.time</strong> on some example data.</p>
</div></div><div class="proof proof-type-exercise" id="id35">

    <div class="proof-title">
        <span class="proof-type">Exercise 16.4</span>
        
    </div><div class="proof-content">
<p>(*)
Determine the number of unique text lines in a very large file
(assuming that the set of unique text lines fits into memory,
but the file itself does not).
Also, determine the five most frequently occurring text lines.</p>
</div></div></section>
<section id="pass-by-value-copy-on-demand-not-for-environments">
<span id="sec-copy-on-demand"></span><h3><span class="section-number">16.1.4. </span>Pass-by-value, copy on demand: Not for environments<a class="headerlink" href="#pass-by-value-copy-on-demand-not-for-environments" title="Permalink to this heading">#</a></h3>
<p>Given any R object, say, <code class="docutils literal notranslate"><span class="pre">x</span></code>,
when we issue:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">y</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">x</span>
</pre></div>
</div>
<p>its copy<a class="footnote-reference brackets" href="#footdelayed" id="id9" role="doc-noteref"><span class="fn-bracket">[</span>7<span class="fn-bracket">]</span></a> is made so that <code class="docutils literal notranslate"><span class="pre">y</span></code> and <code class="docutils literal notranslate"><span class="pre">x</span></code> are independent
of each other. In other words, any change in the state of <code class="docutils literal notranslate"><span class="pre">x</span></code> (or <code class="docutils literal notranslate"><span class="pre">y</span></code>)
is not reflected in the state of <code class="docutils literal notranslate"><span class="pre">y</span></code> (or <code class="docutils literal notranslate"><span class="pre">x</span></code>).</p>
<p>For instance:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">x</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="m">1</span><span class="p">)</span>
<span class="n">y</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">x</span>
<span class="n">y</span><span class="p">[[</span><span class="s">&quot;a&quot;</span><span class="p">]]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">y</span><span class="p">[[</span><span class="s">&quot;a&quot;</span><span class="p">]]</span><span class="m">+1</span>
<span class="nf">print</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<span class="c1">## $a</span>
<span class="c1">## [1] 2</span>
<span class="nf">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w">  </span><span class="c1"># not affected – `x` and `y` are independent</span>
<span class="c1">## $a</span>
<span class="c1">## [1] 1</span>
</pre></div>
</div>
<p>The same happens with arguments that we feed to the functions:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">mod</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">function</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="p">)</span><span class="w">  </span><span class="c1"># it&#39;s like: local_y &lt;- passed_argument</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">y</span><span class="p">[[</span><span class="n">key</span><span class="p">]]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">y</span><span class="p">[[</span><span class="n">key</span><span class="p">]]</span><span class="m">+1</span>
<span class="w">    </span><span class="n">y</span>
<span class="p">}</span>

<span class="nf">mod</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;a&quot;</span><span class="p">)</span><span class="w">  </span><span class="c1"># returns a modified copy of `x`</span>
<span class="c1">## $a</span>
<span class="c1">## [1] 2</span>
<span class="nf">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w">  </span><span class="c1"># not affected</span>
<span class="c1">## $a</span>
<span class="c1">## [1] 1</span>
</pre></div>
</div>
<p>We thus say that R has a <em>pass-by-value</em> semantic.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Environments are the only<a class="footnote-reference brackets" href="#foottrickery" id="id10" role="doc-noteref"><span class="fn-bracket">[</span>8<span class="fn-bracket">]</span></a> R objects that have
an assign- and pass-by-reference semantics.</p>
</div>
<p>In other words, if we perform:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">x</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.environment</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">y</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">x</span>
</pre></div>
</div>
<p>then the names <code class="docutils literal notranslate"><span class="pre">x</span></code> and <code class="docutils literal notranslate"><span class="pre">y</span></code> are bound with exactly the same object
in computer’s memory:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="c1">## &lt;environment: 0x5630315b7b30&gt;</span>
<span class="nf">print</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<span class="c1">## &lt;environment: 0x5630315b7b30&gt;</span>
</pre></div>
</div>
<p>Therefore:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">y</span><span class="p">[[</span><span class="s">&quot;a&quot;</span><span class="p">]]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">y</span><span class="p">[[</span><span class="s">&quot;a&quot;</span><span class="p">]]</span><span class="m">+1</span>
<span class="nf">print</span><span class="p">(</span><span class="n">y</span><span class="p">[[</span><span class="s">&quot;a&quot;</span><span class="p">]])</span>
<span class="c1">## [1] 2</span>
<span class="nf">print</span><span class="p">(</span><span class="n">x</span><span class="p">[[</span><span class="s">&quot;a&quot;</span><span class="p">]])</span><span class="w">  </span><span class="c1"># `x` is `y`, `y` is `x`</span>
<span class="c1">## [1] 2</span>
</pre></div>
</div>
<p>The same happens when we pass them to a function:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">mod</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;a&quot;</span><span class="p">)</span><span class="w">  </span><span class="c1"># pass-by-reference (`y` is `x`, remember?)</span>
<span class="c1">## &lt;environment: 0x5630315b7b30&gt;</span>
<span class="n">x</span><span class="p">[[</span><span class="s">&quot;a&quot;</span><span class="p">]]</span><span class="w">   </span><span class="c1"># `x` has changed (names `y` and `x` are bound to the same object)</span>
<span class="c1">## [1] 3</span>
</pre></div>
</div>
<p>Thus, any changes we make to an environment passed as an
argument to a function will be visible <em>outside</em> the call.
This minimises time and memory use in certain situations.
If this sounds complicated, we should rather be avoiding
these data structures whatsoever. As we have said, an R user
can live without them.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>(*)
For efficiency reasons, when we write “<code class="docutils literal notranslate"><span class="pre">y</span> <span class="pre">&lt;-</span> <span class="pre">x</span></code>” ,
a copy of `<code class="docutils literal notranslate"><span class="pre">x</span></code>` (unless it is an environment)
is only created if absolutely necessary.</p>
<p>Here is some benchmarking of the <em>copy-on-demand</em> mechanism.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">n</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">100000000</span><span class="w">  </span><span class="c1"># like, a lot</span>
</pre></div>
</div>
<p>Creation of a new large numeric vector:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">t0</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">proc.time</span><span class="p">();</span><span class="w">           </span><span class="n">x</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">numeric</span><span class="p">(</span><span class="n">n</span><span class="p">);</span><span class="w">                </span><span class="nf">proc.time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">t0</span>
<span class="c1">##    user  system elapsed</span>
<span class="c1">##   0.105   0.215   0.321</span>
</pre></div>
</div>
<p>Creation of a (delayed) copy:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">t0</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">proc.time</span><span class="p">();</span><span class="w">           </span><span class="n">y</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">x</span><span class="p">;</span><span class="w">                         </span><span class="nf">proc.time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">t0</span>
<span class="c1">##    user  system elapsed</span>
<span class="c1">##   0.000   0.000   0.001</span>
</pre></div>
</div>
<p>This was instant. Thus, we definitely did not clone the <code class="docutils literal notranslate"><span class="pre">n</span></code> data cells.</p>
<p>Copy-on-demand is implemented using some quite simple <em>reference counting</em>;
compare <a class="reference internal" href="310-compiled.html#sec-memory-management"><span class="std std-numref">Section 14.4</span></a>. That, temporarily,
<code class="docutils literal notranslate"><span class="pre">x</span></code> and <code class="docutils literal notranslate"><span class="pre">y</span></code> point to the same address in memory can be inspected by calling:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">.Internal</span><span class="p">(</span><span class="nf">inspect</span><span class="p">(</span><span class="n">x</span><span class="p">))</span><span class="w">  </span><span class="c1"># internal function - do not use it</span>
<span class="c1">## @7f0d40a1c010 14 REALSXP g0c7 [REF(4)] (len=100000000, tl=0) 0,0,0,0,0,...</span>
<span class="nf">.Internal</span><span class="p">(</span><span class="nf">inspect</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
<span class="c1">## @7f0d40a1c010 14 REALSXP g0c7 [REF(5)] (len=100000000, tl=0) 0,0,0,0,0,...</span>
</pre></div>
</div>
<p>The real copying is only triggered when we try to modify <code class="docutils literal notranslate"><span class="pre">x</span></code> or <code class="docutils literal notranslate"><span class="pre">y</span></code>.
This is when they need to be separated.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">t0</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">proc.time</span><span class="p">();</span><span class="w">           </span><span class="n">y</span><span class="p">[</span><span class="m">1</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">1</span><span class="p">;</span><span class="w">                      </span><span class="nf">proc.time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">t0</span>
<span class="c1">##    user  system elapsed</span>
<span class="c1">##   0.140   0.184   0.325</span>
</pre></div>
</div>
<p>Now <code class="docutils literal notranslate"><span class="pre">x</span></code> and <code class="docutils literal notranslate"><span class="pre">y</span></code> are different objects.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">.Internal</span><span class="p">(</span><span class="nf">inspect</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
<span class="c1">## @7f0d40a1c010 14 REALSXP g0c7 [MARK,REF(5)] (len=100000000, tl=0) 0,0,0,0…</span>
<span class="nf">.Internal</span><span class="p">(</span><span class="nf">inspect</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
<span class="c1">## @7f0d10f2b010 14 REALSXP g0c7 [MARK,REF(1)] (len=100000000, tl=0) 1,0,0,0…</span>
</pre></div>
</div>
<p>Note that the elapsed time  is similar to that needed to create
<code class="docutils literal notranslate"><span class="pre">x</span></code> from scratch.</p>
<p>Further modifications will already be quick:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">t0</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">proc.time</span><span class="p">();</span><span class="w">           </span><span class="n">y</span><span class="p">[</span><span class="m">2</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">2</span><span class="p">;</span><span class="w">                      </span><span class="nf">proc.time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">t0</span>
<span class="c1">##    user  system elapsed</span>
<span class="c1">##   0.143   0.235   0.378</span>
</pre></div>
</div>
</div>
</section>
<section id="a-note-on-reference-classes">
<span id="sec-refclass"></span><h3><span class="section-number">16.1.5. </span>A note on reference classes (**)<a class="headerlink" href="#a-note-on-reference-classes" title="Permalink to this heading">#</a></h3>
<p>In <a class="reference internal" href="230-matrix.html#sec-s4"><span class="std std-numref">Section 11.5</span></a>, we briefly mentioned the S4 system
for object-oriented programming.</p>
<p>It turns out that we also have access to its variant,
called <em>reference classes</em><a class="footnote-reference brackets" href="#footr5" id="id11" role="doc-noteref"><span class="fn-bracket">[</span>9<span class="fn-bracket">]</span></a>).
Their experimental version was added in R 2.12.0.</p>
<p>Reference classes are implemented using S4 classes with the data part
being of type <code class="docutils literal notranslate"><span class="pre">environment</span></code>.
Thanks to this, we get a more typical object-oriented experience,
where methods can modify the data they act upon in-place.</p>
<p>Even though they are a theoretically interesting concept on its own,
and quite appealing to package developers with C++ or Java background,
in the current author’s opinion, such classes are alien citizens
of our environment, breaking its <em>functional</em> nature.
Therefore, we will not be discussing them here.</p>
<p>A curious reader is referred to <strong class="command">help</strong><code class="code docutils literal notranslate"><span class="pre">(&quot;ReferenceClasses&quot;)</span></code>
and Chapters 9 and 11 of <span id="id12">[<a class="reference internal" href="999-bibliography.html#id20" title="Chambers, J.M. (2016).  Extending R. Chapman &amp; Hall.">7</a>]</span> for more details.</p>
</section>
</section>
<section id="the-environment-model-of-evaluation">
<span id="sec-env-mod-eval"></span><h2><span class="section-number">16.2. </span>The environment model of evaluation<a class="headerlink" href="#the-environment-model-of-evaluation" title="Permalink to this heading">#</a></h2>
<p>Recall that in <a class="reference internal" href="320-language.html#chap-language"><span class="std std-numref">Chapter 15</span></a>, we said that
there are three types of expressions: constants  (e.g., <code class="docutils literal notranslate"><span class="pre">1</span></code> and <code class="docutils literal notranslate"><span class="pre">&quot;spam&quot;</span></code>),
names (e.g., `<code class="docutils literal notranslate"><span class="pre">x</span></code>` and `<code class="docutils literal notranslate"><span class="pre">spam</span></code>`),
and calls (like <strong class="command">f</strong><code class="code docutils literal notranslate"><span class="pre">(x,</span> <span class="pre">1)</span></code>).</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>The <em>meaning</em> of all names (symbols) always depends on the context,
as specified by a given environment.</p>
</div>
<p>In other words, names have no meaning by themselves.
They can only be interpreted in the context of a specific environment.</p>
<div style="margin-top: 1em"></div><p>Consider a simple expression merely consisting of a name, `<code class="docutils literal notranslate"><span class="pre">x</span></code>`:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">expr_x</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">quote</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
<p>Let us define two environments, binding the name <code class="docutils literal notranslate"><span class="pre">x</span></code> with
different constants.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">e1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.environment</span><span class="p">(</span><span class="nf">list</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="m">1</span><span class="p">))</span>
<span class="n">e2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.environment</span><span class="p">(</span><span class="nf">list</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s">&quot;spam&quot;</span><span class="p">))</span>
</pre></div>
</div>
<p>An expression can only be evaluated <em>within</em> some well-defined environment.
We can do that by calling <strong class="command">eval</strong>:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">eval</span><span class="p">(</span><span class="n">expr_x</span><span class="p">,</span><span class="w"> </span><span class="n">envir</span><span class="o">=</span><span class="n">e1</span><span class="p">)</span><span class="w">  </span><span class="c1"># evaluate `x` within environment e1</span>
<span class="c1">## [1] 1</span>
<span class="nf">eval</span><span class="p">(</span><span class="n">expr_x</span><span class="p">,</span><span class="w"> </span><span class="n">envir</span><span class="o">=</span><span class="n">e2</span><span class="p">)</span><span class="w">  </span><span class="c1"># evaluate the same `x` within environment e2</span>
<span class="c1">## [1] &quot;spam&quot;</span>
</pre></div>
</div>
<p>Note that the very same expression has two different meanings,
depending on the context.
This is quite like in the so-called real life:
“I’m good” can mean “I don’t need anything” but also
“My virtues are plentiful”. It all depends who and when is asking, i.e.,
in which <em>environment</em> we <em>evaluate</em> the said sentence.</p>
<p>We call the above the <em>environment model of evaluation</em>
(see Section 3.2 in <span id="id13">[<a class="reference internal" href="999-bibliography.html#id15" title="Abelson, H., Sussman, G.J., and Sussman, J. (1996).  Structure and Interpretation of Computer Programs. MIT Press.">1</a>]</span> and Section 6 in <span id="id14">[<a class="reference internal" href="999-bibliography.html#id10" title="R Development Core Team. (2023).  R Language Definition. URL: https://CRAN.R-project.org/doc/manuals/r-release/R-lang.html.">52</a>]</span>).</p>
<section id="getting-the-current-environment-here-the-global-one">
<h3><span class="section-number">16.2.1. </span>Getting the current environment (here: the global one)<a class="headerlink" href="#getting-the-current-environment-here-the-global-one" title="Permalink to this heading">#</a></h3>
<p>By default, expressions are evaluated in the <em>current</em> environment,
which we can fetch by calling:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">sys.frame</span><span class="p">(</span><span class="nf">sys.nframe</span><span class="p">())</span><span class="w">  </span><span class="c1"># get the current environment</span>
<span class="c1">## &lt;environment: R_GlobalEnv&gt;</span>
</pre></div>
</div>
<p>We are working <em>on the R console</em>, hence the current one is the <em>global</em>
environment (user workspace), which we can access anywhere by calling
<strong class="command">globalenv</strong> or referring to the `<code class="docutils literal notranslate"><span class="pre">.GlobalEnv</span></code>` object.</p>
<div class="proof proof-type-example" id="id36">

    <div class="proof-title">
        <span class="proof-type">Example 16.5</span>
        
    </div><div class="proof-content">
<p>Calling any operation, for instance<a class="footnote-reference brackets" href="#footassign" id="id15" role="doc-noteref"><span class="fn-bracket">[</span>10<span class="fn-bracket">]</span></a>:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">x</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s">&quot;spammity spam&quot;</span>
</pre></div>
</div>
<p>means evaluating it <em>within the current environment</em>:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">eval</span><span class="p">(</span><span class="nf">quote</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s">&quot;spam&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">envir</span><span class="o">=</span><span class="nf">sys.frame</span><span class="p">(</span><span class="nf">sys.nframe</span><span class="p">()))</span>
</pre></div>
</div>
<p>Here, we bound the string <code class="docutils literal notranslate"><span class="pre">&quot;spam&quot;</span></code> with name `<code class="docutils literal notranslate"><span class="pre">x</span></code>` in
the current environment’s frame:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">sys.frame</span><span class="p">(</span><span class="nf">sys.nframe</span><span class="p">())[[</span><span class="s">&quot;x&quot;</span><span class="p">]]</span><span class="w">  </span><span class="c1"># yes, `x` is in the current environment now</span>
<span class="c1">## [1] &quot;spam&quot;</span>
<span class="nf">globalenv</span><span class="p">()[[</span><span class="s">&quot;x&quot;</span><span class="p">]]</span><span class="w">  </span><span class="c1"># because global environment is the current one here</span>
<span class="c1">## [1] &quot;spam&quot;</span>
</pre></div>
</div>
<p>Therefore, when we now refer to `<code class="docutils literal notranslate"><span class="pre">x</span></code>` (from within
the current environment):</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">x</span><span class="w">  </span><span class="c1"># eval(quote(x), envir=sys.frame(sys.nframe()))</span>
<span class="c1">## [1] &quot;spam&quot;</span>
</pre></div>
</div>
<p>exactly the above named object is fetched.</p>
</div></div><div class="proof proof-type-exercise" id="id37">

    <div class="proof-title">
        <span class="proof-type">Exercise 16.6</span>
        
    </div><div class="proof-content">
<p><strong class="command">save.image</strong> can be used to save the current workspace,
i.e., the global environment,
by default, to the file named <code class="file docutils literal notranslate"><span class="pre">.Rdata</span></code> in the current working
directory. Test this function in combination with <strong class="command">load</strong>.</p>
</div></div><div class="admonition note">
<p class="admonition-title">Note</p>
<p>Names starting with a dot are <em>hidden</em>.
<strong class="command">ls</strong>, a function to fetch all names registered within
a given environment, does not list them by default.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">.test</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s">&quot;spam&quot;</span>
<span class="nf">ls</span><span class="p">()</span><span class="w">  </span><span class="c1"># list all names in the current environment, i.e., the global one</span>
<span class="c1">## [1] &quot;e1&quot;     &quot;e2&quot;     &quot;expr_x&quot; &quot;mod&quot;    &quot;t0&quot;     &quot;x&quot;</span>
</pre></div>
</div>
<p>Compare the above with:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">ls</span><span class="p">(</span><span class="n">all.names</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span>
<span class="c1">## [1] &quot;.Random.seed&quot; &quot;.test&quot;        &quot;e1&quot;           &quot;e2&quot;</span>
<span class="c1">## [5] &quot;expr_x&quot;       &quot;mod&quot;          &quot;t0&quot;           &quot;x&quot;</span>
</pre></div>
</div>
<p>On a side note, <code class="docutils literal notranslate"><span class="pre">.Random.seed</span></code> stores the current pseudorandom
generator’s seed; compare <a class="reference internal" href="120-numeric.html#sec-pseudorandom"><span class="std std-numref">Section 2.1.5</span></a>.</p>
</div>
</section>
<section id="enclosures-enclosures-thereof-etc">
<span id="sec-enclos-env"></span><h3><span class="section-number">16.2.2. </span>Enclosures, enclosures thereof, etc.<a class="headerlink" href="#enclosures-enclosures-thereof-etc" title="Permalink to this heading">#</a></h3>
<p>To show that there is much more to the environment model
of evaluation than what we mentioned above,
let us try to evaluate an expression featuring two names:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">expr_comp</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">quote</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="s">&quot;eggs&quot;</span><span class="p">)</span>
<span class="nf">eval</span><span class="p">(</span><span class="n">expr_comp</span><span class="p">,</span><span class="w"> </span><span class="n">envir</span><span class="o">=</span><span class="n">e2</span><span class="p">)</span>
<span class="c1">## Error in x &lt; &quot;eggs&quot;: could not find function &quot;&lt;&quot;</span>
</pre></div>
</div>
<p>The meaning of any constant (here, <code class="docutils literal notranslate"><span class="pre">&quot;spam&quot;</span></code>) is context-independent,
`<code class="docutils literal notranslate"><span class="pre">x</span></code>` is specified by the environment provided,
but the name `<strong class="command">&lt;</strong>` is not mentioned therein.
Hence the error.</p>
<p>However, we <em>feel</em> that we know the meaning
of `<strong class="command">&lt;</strong>`; it is a relational operator, obviously, isn’t it?
To add to confusion, let us note that our experience-grounded intuition
is true in the following context:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">e3</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">new.env</span><span class="p">()</span>
<span class="n">e3</span><span class="p">[[</span><span class="s">&quot;x&quot;</span><span class="p">]]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s">&quot;bacon&quot;</span>
<span class="nf">eval</span><span class="p">(</span><span class="n">expr_comp</span><span class="p">,</span><span class="w"> </span><span class="n">envir</span><span class="o">=</span><span class="n">e3</span><span class="p">)</span>
<span class="c1">## [1] TRUE</span>
</pre></div>
</div>
<p>So where does the name `<strong class="command">&lt;</strong>` come from?
It is neither included in <code class="docutils literal notranslate"><span class="pre">e2</span></code> nor in <code class="docutils literal notranslate"><span class="pre">e3</span></code>:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">e2</span><span class="p">[[</span><span class="s">&quot;&lt;&quot;</span><span class="p">]]</span>
<span class="c1">## NULL</span>
<span class="n">e3</span><span class="p">[[</span><span class="s">&quot;&lt;&quot;</span><span class="p">]]</span>
<span class="c1">## NULL</span>
</pre></div>
</div>
<p>Is `<strong class="command">&lt;</strong>` hardcoded somewhere?
Or is it also dependent on the context?
Why is it <em>visible</em> when evaluating
an expression within <code class="docutils literal notranslate"><span class="pre">e3</span></code> but not in <code class="docutils literal notranslate"><span class="pre">e2</span></code>?</p>
<div style="margin-top: 1em"></div><p>Studying<a class="footnote-reference brackets" href="#footlazystudent" id="id16" role="doc-noteref"><span class="fn-bracket">[</span>11<span class="fn-bracket">]</span></a> the manual of `<strong class="command">[[</strong>`
(<em>Environments</em> section), we discover that
<code class="docutils literal notranslate"><span class="pre">e3[[&quot;&lt;&quot;]]</span></code> is equivalent to a call to
<strong class="command">get</strong><code class="code docutils literal notranslate"><span class="pre">(&quot;&lt;&quot;,</span> <span class="pre">envir=e3,</span> <span class="pre">inherits=FALSE)</span></code>.</p>
<p>In <strong class="command">help</strong><code class="code docutils literal notranslate"><span class="pre">(&quot;get&quot;)</span></code>, we read that if the <code class="docutils literal notranslate"><span class="pre">inherits</span></code> argument
is set to <code class="docutils literal notranslate"><span class="pre">TRUE</span></code> (which is the default for <strong class="command">get</strong>), then
<em>the enclosing frames of the given environment are searched as well</em>.</p>
<p>Continuing the example from the previous subsection:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">get</span><span class="p">(</span><span class="s">&quot;&lt;&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">envir</span><span class="o">=</span><span class="n">e2</span><span class="p">)</span><span class="w">  </span><span class="c1"># inherits=TRUE</span>
<span class="c1">## Error in get(&quot;&lt;&quot;, envir = e2): object &#39;&lt;&#39; not found</span>
<span class="nf">get</span><span class="p">(</span><span class="s">&quot;&lt;&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">envir</span><span class="o">=</span><span class="n">e3</span><span class="p">)</span><span class="w">  </span><span class="c1"># inherits=TRUE</span>
<span class="c1">## function (e1, e2)  .Primitive(&quot;&lt;&quot;)</span>
</pre></div>
</div>
<p>And indeed, we see that `<strong class="command">&lt;</strong>` is <em>reachable</em> from
within <code class="docutils literal notranslate"><span class="pre">e3</span></code> but not <code class="docutils literal notranslate"><span class="pre">e2</span></code>. It means that <code class="docutils literal notranslate"><span class="pre">e3</span></code> <em>points to</em> another
environment where further information should be sought
if we were to leave the current container empty-handed.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>The reference (pointer) to the <em>enclosing environment</em>
is an integral part of each environment (alongside a <em>frame</em> of objects).
It can be fetched and set using the <strong class="command">parent.env</strong> function.</p>
</div>
</section>
<section id="missing-names-are-sought-in-enclosing-environments">
<h3><span class="section-number">16.2.3. </span>Missing names are sought in enclosing environments<a class="headerlink" href="#missing-names-are-sought-in-enclosing-environments" title="Permalink to this heading">#</a></h3>
<p>To understand the idea of enclosing environments better,
let us create two new environments
whose enclosures are set explicitly as follows:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">e4</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">new.env</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="n">e3</span><span class="p">))</span>
<span class="c1">## &lt;environment: 0x5630322721f8&gt;</span>
<span class="p">(</span><span class="n">e5</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">new.env</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="n">e4</span><span class="p">))</span>
<span class="c1">## &lt;environment: 0x5630321dd198&gt;</span>
</pre></div>
</div>
<p>To verify that everything is in order, let us inspect
the following:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">print</span><span class="p">(</span><span class="n">e3</span><span class="p">)</span><span class="w">  </span><span class="c1"># this is the address of e3 by the way</span>
<span class="c1">## &lt;environment: 0x563033724088&gt;</span>
<span class="nf">parent.env</span><span class="p">(</span><span class="n">e4</span><span class="p">)</span><span class="w">  </span><span class="c1"># e3 is the enclosing environment of e4</span>
<span class="c1">## &lt;environment: 0x563033724088&gt;</span>
<span class="nf">parent.env</span><span class="p">(</span><span class="n">e5</span><span class="p">)</span><span class="w">  </span><span class="c1"># e4 is the enclosing environment of e5</span>
<span class="c1">## &lt;environment: 0x5630322721f8&gt;</span>
</pre></div>
</div>
<p>Also, let us bind two different objects with the name `<code class="docutils literal notranslate"><span class="pre">y</span></code>` in <code class="docutils literal notranslate"><span class="pre">e5</span></code>
and <code class="docutils literal notranslate"><span class="pre">e3</span></code>.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">e5</span><span class="p">[[</span><span class="s">&quot;y&quot;</span><span class="p">]]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s">&quot;spam&quot;</span>
<span class="n">e3</span><span class="p">[[</span><span class="s">&quot;y&quot;</span><span class="p">]]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">function</span><span class="p">()</span><span class="w"> </span><span class="s">&quot;a function `y` in e3&quot;</span>
</pre></div>
</div>
<p>The current state of matters is depicted in <a class="reference internal" href="#fig-envirs1"><span class="std std-numref">Figure 16.1</span></a>.</p>
<figure class="align-default" id="id38">
<span id="fig-envirs1"></span><img alt="../_images/envirs1.png" src="../_images/envirs1.png" />
<figcaption>
<p><span class="caption-number">Figure 16.1 </span><span class="caption-text">Example environments and their enclosures (original setting)</span><a class="headerlink" href="#id38" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<p>Now, let us consider a simple expression featuring
the `<code class="docutils literal notranslate"><span class="pre">y</span></code>` name only and evaluate it in the above environments:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">expr_y</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">quote</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<span class="nf">eval</span><span class="p">(</span><span class="n">expr_y</span><span class="p">,</span><span class="w"> </span><span class="n">envir</span><span class="o">=</span><span class="n">e3</span><span class="p">)</span>
<span class="c1">## function() &quot;a function `y` in e3&quot;</span>
<span class="nf">eval</span><span class="p">(</span><span class="n">expr_y</span><span class="p">,</span><span class="w"> </span><span class="n">envir</span><span class="o">=</span><span class="n">e5</span><span class="p">)</span>
<span class="c1">## [1] &quot;spam&quot;</span>
</pre></div>
</div>
<p>No surprises yet.
However, evaluating it in <code class="docutils literal notranslate"><span class="pre">e4</span></code>, which does not feature
`<code class="docutils literal notranslate"><span class="pre">y</span></code>`, yields:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">eval</span><span class="p">(</span><span class="n">expr_y</span><span class="p">,</span><span class="w"> </span><span class="n">envir</span><span class="o">=</span><span class="n">e4</span><span class="p">)</span>
<span class="c1">## function() &quot;a function `y` in e3&quot;</span>
</pre></div>
</div>
<p>This returned `<code class="docutils literal notranslate"><span class="pre">y</span></code>` from <code class="docutils literal notranslate"><span class="pre">e4</span></code>’s enclosure, <code class="docutils literal notranslate"><span class="pre">e3</span></code>.</p>
<p>Let us horse around with the enclosures of <code class="docutils literal notranslate"><span class="pre">e5</span></code> and <code class="docutils literal notranslate"><span class="pre">e4</span></code>
so that we obtain the setting depicted in <a class="reference internal" href="#fig-envirs2"><span class="std std-numref">Figure 16.2</span></a>:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">parent.env</span><span class="p">(</span><span class="n">e5</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">e3</span>
<span class="nf">parent.env</span><span class="p">(</span><span class="n">e4</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">e5</span>
</pre></div>
</div>
<figure class="align-default" id="id39">
<span id="fig-envirs2"></span><img alt="../_images/envirs2.png" src="../_images/envirs2.png" />
<figcaption>
<p><span class="caption-number">Figure 16.2 </span><span class="caption-text">Example environments and their enclosures (after the change made)</span><a class="headerlink" href="#id39" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<p>Now evaluating `<code class="docutils literal notranslate"><span class="pre">y</span></code>` again in the same <code class="docutils literal notranslate"><span class="pre">e4</span></code> yields of course
a very different result:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">eval</span><span class="p">(</span><span class="n">expr_y</span><span class="p">,</span><span class="w"> </span><span class="n">envir</span><span class="o">=</span><span class="n">e4</span><span class="p">)</span>
<span class="c1">## [1] &quot;spam&quot;</span>
</pre></div>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Names referred to in an expression to be evaluated
but missing in the current environment, will be sought
in its enclosure(s).</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>There are some functions related to searching within
and modifying environments which optionally (see their <code class="docutils literal notranslate"><span class="pre">inherits</span></code> argument)
allow for continuing explorations in the enclosures,
until successful:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">inherits=TRUE</span></code> by default:</p>
<ul>
<li><p><strong class="command">exists</strong>,</p></li>
<li><p><strong class="command">get</strong>,</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">inherits=FALSE</span></code> by default:</p>
<ul>
<li><p><strong class="command">assign</strong>,</p></li>
<li><p><strong class="command">rm</strong> (remove).</p></li>
</ul>
</li>
</ul>
</div>
</section>
<section id="looking-for-functions">
<h3><span class="section-number">16.2.4. </span>Looking for functions<a class="headerlink" href="#looking-for-functions" title="Permalink to this heading">#</a></h3>
<p>Interestingly, if a name is used in place of a function to be called,
the object sought is always<a class="footnote-reference brackets" href="#footc" id="id17" role="doc-noteref"><span class="fn-bracket">[</span>12<span class="fn-bracket">]</span></a> of mode <code class="docutils literal notranslate"><span class="pre">function</span></code>.</p>
<p>Consider a similar expression to the above, but this
time including name `<code class="docutils literal notranslate"><span class="pre">y</span></code>` playing a different role:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">expr_y2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">quote</span><span class="p">(</span><span class="nf">y</span><span class="p">())</span><span class="w">  </span><span class="c1"># a call to something named `y`</span>
<span class="nf">eval</span><span class="p">(</span><span class="n">expr_y2</span><span class="p">,</span><span class="w"> </span><span class="n">envir</span><span class="o">=</span><span class="n">e4</span><span class="p">)</span>
<span class="c1">## [1] &quot;a function `y` in e3&quot;</span>
</pre></div>
</div>
<p>In other words, what we used here was not:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">get</span><span class="p">(</span><span class="s">&quot;y&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">envir</span><span class="o">=</span><span class="n">e4</span><span class="p">)</span>
<span class="c1">## [1] &quot;spam&quot;</span>
</pre></div>
</div>
<p>but:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">get</span><span class="p">(</span><span class="s">&quot;y&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">envir</span><span class="o">=</span><span class="n">e4</span><span class="p">,</span><span class="w"> </span><span class="n">mode</span><span class="o">=</span><span class="s">&quot;function&quot;</span><span class="p">)</span>
<span class="c1">## function() &quot;a function `y` in e3&quot;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>“<strong class="command">name</strong><code class="code docutils literal notranslate"><span class="pre">()</span></code>”,
“<code class="docutils literal notranslate"><span class="pre">&quot;name&quot;()</span></code>”,
and “`<code class="docutils literal notranslate"><span class="pre">name</span></code>`<code class="docutils literal notranslate"><span class="pre">()</span></code>”
are synonymous.
However, the first expression is valid
only if <code class="docutils literal notranslate"><span class="pre">name</span></code> is a syntactically valid name.</p>
</div>
</section>
<section id="inspecting-the-search-path">
<h3><span class="section-number">16.2.5. </span>Inspecting the search path<a class="headerlink" href="#inspecting-the-search-path" title="Permalink to this heading">#</a></h3>
<p>Going back to our expression involving a comparison operator:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">expr_comp</span>
<span class="c1">## x &lt; &quot;eggs&quot;</span>
</pre></div>
</div>
<p>Why does the following work as expected?</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">eval</span><span class="p">(</span><span class="n">expr_comp</span><span class="p">,</span><span class="w"> </span><span class="n">envir</span><span class="o">=</span><span class="n">e3</span><span class="p">)</span>
<span class="c1">## [1] TRUE</span>
</pre></div>
</div>
<p>Well, we have all the bits to understand it now.
Namely, `<code class="docutils literal notranslate"><span class="pre">&lt;</span></code>` is a function that is looked up in the following way:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">get</span><span class="p">(</span><span class="s">&quot;&lt;&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">envir</span><span class="o">=</span><span class="n">e3</span><span class="p">,</span><span class="w"> </span><span class="n">inherits</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">,</span><span class="w"> </span><span class="n">mode</span><span class="o">=</span><span class="s">&quot;function&quot;</span><span class="p">)</span>
<span class="c1">## function (e1, e2)  .Primitive(&quot;&lt;&quot;)</span>
</pre></div>
</div>
<p>It was reachable from <code class="docutils literal notranslate"><span class="pre">e3</span></code>, which means that
<code class="docutils literal notranslate"><span class="pre">e3</span></code> also has an enclosing environment.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">parent.env</span><span class="p">(</span><span class="n">e3</span><span class="p">)</span>
<span class="c1">## &lt;environment: R_GlobalEnv&gt;</span>
</pre></div>
</div>
<p>This is our global namespace, which was the current environment
at the time <code class="docutils literal notranslate"><span class="pre">e3</span></code> was created. Still, we have not defined `<code class="docutils literal notranslate"><span class="pre">&lt;</span></code>`
there. It means that the global environment also has an enclosure.</p>
<div style="margin-top: 1em"></div><p>We can explore the whole <em>search</em> path easily,
by starting at the global environment, and then following
the enclosures recursively.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">ecur</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">globalenv</span><span class="p">()</span><span class="w">  </span><span class="c1"># starting point</span>
<span class="n">repeat</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nf">cat</span><span class="p">(</span><span class="nf">format</span><span class="p">(</span><span class="n">ecur</span><span class="p">))</span><span class="w">  </span><span class="c1"># pretty-print</span>

<span class="w">    </span><span class="nf">if </span><span class="p">(</span><span class="nf">exists</span><span class="p">(</span><span class="s">&quot;&lt;&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">envir</span><span class="o">=</span><span class="n">ecur</span><span class="p">,</span><span class="w"> </span><span class="n">inherits</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">))</span>
<span class="w">        </span><span class="nf">cat</span><span class="p">(</span><span class="s">&quot;                  `&lt;` found here!&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nf">cat</span><span class="p">(</span><span class="s">&quot;\n&quot;</span><span class="p">)</span>

<span class="w">    </span><span class="n">ecur</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">parent.env</span><span class="p">(</span><span class="n">ecur</span><span class="p">)</span><span class="w">  </span><span class="c1"># advance to its enclosure</span>
<span class="p">}</span>
<span class="c1">## &lt;environment: R_GlobalEnv&gt;</span>
<span class="c1">## &lt;environment: 0x56303183b9b8&gt;</span>
<span class="c1">## &lt;environment: package:stats&gt;</span>
<span class="c1">## &lt;environment: package:graphics&gt;</span>
<span class="c1">## &lt;environment: package:grDevices&gt;</span>
<span class="c1">## &lt;environment: package:utils&gt;</span>
<span class="c1">## &lt;environment: package:datasets&gt;</span>
<span class="c1">## &lt;environment: package:methods&gt;</span>
<span class="c1">## &lt;environment: 0x56302fba3a60&gt;</span>
<span class="c1">## &lt;environment: base&gt;                  `&lt;` found here!</span>
<span class="c1">## &lt;environment: R_EmptyEnv&gt;</span>
<span class="c1">## Error in parent.env(ecur): the empty environment has no parent</span>
</pre></div>
</div>
<p>Underneath the global environment,
there is a whole list of attached packages.</p>
<p>The `<code class="docutils literal notranslate"><span class="pre">&lt;</span></code>` operator was found in the <em>base</em> environment,
which we can access directly by calling <strong class="command">baseenv</strong>.
This is where most of the <em>fundamental</em> functions
described in the previous chapters reside.</p>
<p>The base environment’s enclosure is the <em>empty</em> environment
(<strong class="command">emptyenv</strong>), which is the only one followed by nothing
(note that the loop might have turn out endless otherwise).</p>
</section>
<section id="attaching-and-detaching-from-the-search-path">
<span id="sec-attach"></span><h3><span class="section-number">16.2.6. </span>Attaching and detaching from the search path<a class="headerlink" href="#attaching-and-detaching-from-the-search-path" title="Permalink to this heading">#</a></h3>
<p>In <a class="reference internal" href="170-function.html#sec-packages"><span class="std std-numref">Section 7.3.1</span></a>, we mentioned, that we can access
the objects exported by a package (loading the package if necessary)
without attaching them onto the search path
by using the <strong class="program">pkg</strong><code class="code docutils literal notranslate"><span class="pre">::object</span></code> syntax.</p>
<p>For instance:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">tools</span><span class="o">::</span><span class="nf">toTitleCase</span><span class="p">(</span><span class="s">&quot;`tools` namespace not attached to the search path&quot;</span><span class="p">)</span>
<span class="c1">## [1] &quot;`tools` Namespace not Attached to the Search Path&quot;</span>
</pre></div>
</div>
<p>As writing “<strong class="program">pkg</strong><code class="code docutils literal notranslate"><span class="pre">::</span></code>” might be inconvenient in the
long run (for some), we can call <strong class="command">library</strong> to
attach the package’s namespace (environment featuring
exported objects) onto the search path,
just below the global environment.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">toTitleCase</span><span class="p">(</span><span class="s">&quot;nope&quot;</span><span class="p">)</span>
<span class="c1">## Error in toTitleCase(&quot;nope&quot;): could not find function &quot;toTitleCase&quot;</span>
</pre></div>
</div>
<p>This does not work, because <strong class="command">toTitleCase</strong> is not reachable
from the current environment.</p>
<p>Let us inspect the current search path (yes, there is a built-in
function for that):</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">search</span><span class="p">()</span>
<span class="c1">##  [1] &quot;.GlobalEnv&quot;        &quot;marekstuff&quot;        &quot;package:stats&quot;</span>
<span class="c1">##  [4] &quot;package:graphics&quot;  &quot;package:grDevices&quot; &quot;package:utils&quot;</span>
<span class="c1">##  [7] &quot;package:datasets&quot;  &quot;package:methods&quot;   &quot;Autoloads&quot;</span>
<span class="c1">## [10] &quot;package:base&quot;</span>
</pre></div>
</div>
<p>Attaching the package’s namespace:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">library</span><span class="p">(</span><span class="s">&quot;tools&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>And now:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">search</span><span class="p">()</span>
<span class="c1">##  [1] &quot;.GlobalEnv&quot;        &quot;package:tools&quot;     &quot;marekstuff&quot;</span>
<span class="c1">##  [4] &quot;package:stats&quot;     &quot;package:graphics&quot;  &quot;package:grDevices&quot;</span>
<span class="c1">##  [7] &quot;package:utils&quot;     &quot;package:datasets&quot;  &quot;package:methods&quot;</span>
<span class="c1">## [10] &quot;Autoloads&quot;         &quot;package:base&quot;</span>
</pre></div>
</div>
<p>Therefore, what follows, now works as expected:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">toTitleCase</span><span class="p">(</span><span class="s">&quot;Nobody expects the Spanish Inquisition&quot;</span><span class="p">)</span>
<span class="c1">## [1] &quot;Nobody Expects the Spanish Inquisition&quot;</span>
</pre></div>
</div>
<p>To remove an item from the search path,
we can use <strong class="command">detach</strong><a class="footnote-reference brackets" href="#footunload" id="id18" role="doc-noteref"><span class="fn-bracket">[</span>13<span class="fn-bracket">]</span></a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>It turns out that we can also plug in arbitrary environments<a class="footnote-reference brackets" href="#footattachenv" id="id19" role="doc-noteref"><span class="fn-bracket">[</span>14<span class="fn-bracket">]</span></a>
and, by similarity thereto (<a class="reference internal" href="#sec-env-vs-list"><span class="std std-numref">Section 16.1.2</span></a>), named lists
onto the search path. Recalling that data frames are in fact built upon
the latter (<a class="reference internal" href="240-data-frame.html#sec-df-representation"><span class="std std-numref">Section 12.1.6</span></a>), some
users rely on this technique to free themselves from the
onerous burden of typing the object name each time a column
is to be referred to:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">attach</span><span class="p">(</span><span class="n">iris</span><span class="p">)</span>
<span class="nf">head</span><span class="p">(</span><span class="n">Sepal.Length</span><span class="p">)</span><span class="w">  </span><span class="c1"># iris[[&quot;Sepal.Length&quot;]]</span>
<span class="c1">## [1] 5.1 4.9 4.7 4.6 5.0 5.4</span>
</pre></div>
</div>
<p>Here, the <code class="docutils literal notranslate"><span class="pre">iris</span></code> list was converted to an environment,
and the necessary enclosures were set accordingly:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">str</span><span class="p">(</span><span class="nf">parent.env</span><span class="p">(</span><span class="nf">globalenv</span><span class="p">()))</span>
<span class="c1">## &lt;environment: 0x563032147ad8&gt;</span>
<span class="c1">##  - attr(*, &quot;name&quot;)= chr &quot;iris&quot;</span>
<span class="nf">str</span><span class="p">(</span><span class="nf">parent.env</span><span class="p">(</span><span class="nf">parent.env</span><span class="p">(</span><span class="nf">globalenv</span><span class="p">())))</span>
<span class="c1">## &lt;environment: package:tools&gt;</span>
<span class="c1">##  - attr(*, &quot;name&quot;)= chr &quot;package:tools&quot;</span>
<span class="c1">##  - attr(*, &quot;path&quot;)= chr &quot;/usr/lib/R/library/tools&quot;</span>
</pre></div>
</div>
<p>Overall, attaching data frames like this is discouraged,
especially outside of the interactive-mode. Let us not be too lazy.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">detach</span><span class="p">(</span><span class="n">iris</span><span class="p">)</span><span class="w">  </span><span class="c1"># such a relief</span>
</pre></div>
</div>
</div>
</section>
<section id="masking-shadowing-objects-from-down-under">
<span id="sec-shadowing"></span><h3><span class="section-number">16.2.7. </span>Masking (shadowing) objects from down under<a class="headerlink" href="#masking-shadowing-objects-from-down-under" title="Permalink to this heading">#</a></h3>
<p>Note that assignment via `<strong class="command">&lt;-</strong>`
(and <strong class="command">assign</strong>, by default) creates a binding in the <em>current</em>
environment.</p>
<p>Therefore, even if the name to-bind exists somewhere on the search
path, it will not be modified. Instead, a new name will be created.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">expr_comp</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">quote</span><span class="p">(</span><span class="s">&quot;spam&quot;</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="s">&quot;eggs&quot;</span><span class="p">)</span>
<span class="nf">eval</span><span class="p">(</span><span class="n">expr_comp</span><span class="p">)</span>
<span class="c1">## [1] FALSE</span>
</pre></div>
</div>
<p>Here, we rely on `<strong class="command">&lt;</strong>` from the base environment.
However, we create an object of the same name in the current
(global) context:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">`&lt;`</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">function</span><span class="p">(</span><span class="n">e1</span><span class="p">,</span><span class="w"> </span><span class="n">e2</span><span class="p">)</span><span class="w"> </span><span class="nf">cat</span><span class="p">(</span><span class="s">&quot;None shall pass.\n&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>And now we have two different functions of the same name.
When we evaluate an expression within the current
environment or any of its “descendants”,
the new name will <em>shadow</em> the base one:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">eval</span><span class="p">(</span><span class="n">expr_comp</span><span class="p">)</span>
<span class="c1">## None shall pass.</span>
<span class="nf">eval</span><span class="p">(</span><span class="n">expr_comp</span><span class="p">,</span><span class="w"> </span><span class="n">envir</span><span class="o">=</span><span class="n">e5</span><span class="p">)</span><span class="w">  </span><span class="c1"># e5&#39;s enclosure&#39;s enclosure is the global env</span>
<span class="c1">## None shall pass.</span>
</pre></div>
</div>
<p>But we can still call the original function directly:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">base</span><span class="o">::</span><span class="nf">`&lt;`</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">)</span>
<span class="c1">## [1] TRUE</span>
</pre></div>
</div>
<p>It is also reachable from within the current environment’s “ancestors”:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">eval</span><span class="p">(</span><span class="n">expr_comp</span><span class="p">,</span><span class="w"> </span><span class="n">envir</span><span class="o">=</span><span class="nf">baseenv</span><span class="p">())</span>
<span class="c1">## [1] FALSE</span>
<span class="nf">eval</span><span class="p">(</span><span class="n">expr_comp</span><span class="p">,</span><span class="w"> </span><span class="n">envir</span><span class="o">=</span><span class="nf">as.environment</span><span class="p">(</span><span class="s">&quot;package:tools&quot;</span><span class="p">))</span>
<span class="c1">## [1] FALSE</span>
</pre></div>
</div>
<div style="margin-top: 1em"></div><p>It may also happen that an attached package might
introduce some object names that are also available elsewhere.
For instance:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">library</span><span class="p">(</span><span class="s">&quot;stringx&quot;</span><span class="p">)</span>
<span class="c1">## Attaching package: &#39;stringx&#39;</span>
<span class="c1">## The following objects are masked from &#39;package:base&#39;: casefold, chartr,</span>
<span class="c1">##     endsWith, gregexec, gregexpr, grep, grepl, gsub, ISOdate, ISOdatetime,</span>
<span class="c1">##     nchar, nzchar, paste, paste0, regexec, regexpr, sprintf, startsWith,</span>
<span class="c1">##     strftime, strptime, strrep, strsplit, strtrim, strwrap, sub, substr,</span>
<span class="c1">##     substr&lt;-, substring, substring&lt;-, Sys.time, tolower, toupper, trimws,</span>
<span class="c1">##     xtfrm, xtfrm.default</span>
</pre></div>
</div>
<p>Therefore, we have what follows from the current context:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">toupper</span><span class="p">(</span><span class="s">&quot;Groß&quot;</span><span class="p">)</span><span class="w">  </span><span class="c1"># stringx::toupper</span>
<span class="c1">## [1] &quot;GROSS&quot;</span>
<span class="n">base</span><span class="o">::</span><span class="nf">toupper</span><span class="p">(</span><span class="s">&quot;Groß&quot;</span><span class="p">)</span>
<span class="c1">## [1] &quot;GROß&quot;</span>
</pre></div>
</div>
<div style="margin-top: 1em"></div><p>Sometimes<a class="footnote-reference brackets" href="#footpkglock" id="id20" role="doc-noteref"><span class="fn-bracket">[</span>15<span class="fn-bracket">]</span></a>, we can use
<strong class="command">assign</strong><code class="code docutils literal notranslate"><span class="pre">(...,</span> <span class="pre">inherits=FALSE)</span></code>
or its synonym, `<strong class="command">&lt;&lt;-</strong>`, to modify the <em>existing</em>
binding (without creating a new one).</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Let us attach the <code class="docutils literal notranslate"><span class="pre">iris</span></code> data frame (named list) onto the search
path again:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">attach</span><span class="p">(</span><span class="n">iris</span><span class="p">)</span>
<span class="n">Sepal.Length</span><span class="p">[</span><span class="m">1</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">0</span>
</pre></div>
</div>
<p>This of course does not modify the original <code class="docutils literal notranslate"><span class="pre">iris</span></code> nor
its converted-to-an-environment copy that we can find on the search
path. Instead, a new vector named <code class="docutils literal notranslate"><span class="pre">Sepal.Length</span></code> has been created
in the current environment:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">exists</span><span class="p">(</span><span class="s">&quot;Sepal.Length&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">envir</span><span class="o">=</span><span class="nf">globalenv</span><span class="p">())</span>
<span class="c1">## [1] TRUE</span>
</pre></div>
</div>
<p>We can verify the above statement as follows:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">rm</span><span class="p">(</span><span class="s">&quot;Sepal.Length&quot;</span><span class="p">)</span><span class="w">  </span><span class="c1"># removes the one in the global environment</span>
<span class="n">Sepal.Length</span><span class="p">[</span><span class="m">1</span><span class="p">]</span><span class="w">  </span><span class="c1"># `iris` from the search path</span>
<span class="c1">## [1] 5.1</span>
<span class="n">iris</span><span class="p">[[</span><span class="s">&quot;Sepal.Length&quot;</span><span class="p">]][</span><span class="m">1</span><span class="p">]</span><span class="w">  </span><span class="c1"># the original `iris`</span>
<span class="c1">## [1] 5.1</span>
</pre></div>
</div>
<p>However, by writing:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">Petal.Length</span><span class="p">[</span><span class="m">1</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;-</span><span class="w"> </span><span class="m">0</span><span class="w">  </span><span class="c1"># uses assign(..., inherits=FALSE)</span>
</pre></div>
</div>
<p>We changed the state of the environment on the search path.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">exists</span><span class="p">(</span><span class="s">&quot;Sepal.Length&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">envir</span><span class="o">=</span><span class="nf">globalenv</span><span class="p">())</span>
<span class="c1">## [1] TRUE</span>
<span class="n">Petal.Length</span><span class="p">[</span><span class="m">1</span><span class="p">]</span><span class="w">  </span><span class="c1"># `iris` from the search path</span>
<span class="c1">## [1] 0</span>
</pre></div>
</div>
<p>Yet, still, the original <code class="docutils literal notranslate"><span class="pre">iris</span></code> object is still left untouched:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">iris</span><span class="p">[[</span><span class="s">&quot;Petal.Length&quot;</span><span class="p">]][</span><span class="m">1</span><span class="p">]</span><span class="w">  </span><span class="c1"># the original `iris`</span>
<span class="c1">## [1] 1.4</span>
</pre></div>
</div>
<p>Confusing? Just do not attach data frames onto the search path. Too easy.</p>
</div>
</section>
</section>
<section id="evaluating-functions">
<span id="sec-eval-fun"></span><h2><span class="section-number">16.3. </span>🚧 Evaluating functions<a class="headerlink" href="#evaluating-functions" title="Permalink to this heading">#</a></h2>
<p>So far we have only covered the rules behind the evaluation of <em>standalone</em>
R expressions. In this section, we take a look at what happens
<em>inside</em> the invoked functions.</p>
<section id="local-environment">
<h3><span class="section-number">16.3.1. </span>Local environment<a class="headerlink" href="#local-environment" title="Permalink to this heading">#</a></h3>
<p>When we call a function, a new temporary environment is created.
This is where all arguments<a class="footnote-reference brackets" href="#footlocarg" id="id21" role="doc-noteref"><span class="fn-bracket">[</span>16<span class="fn-bracket">]</span></a> and local variables
are emplaced. During the function evaluation, this environment becomes
the current one. After the call, the environment ceases to exist
and we go back to the previous environment from the call stack.</p>
<p>Consider the following function</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">test</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="nf">print</span><span class="p">(</span><span class="nf">ls</span><span class="p">())</span><span class="w">  </span><span class="c1"># list object names in the current environment</span>
<span class="w">    </span><span class="n">y</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">x</span><span class="o">^</span><span class="m">2</span><span class="w">  </span><span class="c1"># creates a new variable</span>
<span class="w">    </span><span class="nf">print</span><span class="p">(</span><span class="nf">sys.frame</span><span class="p">(</span><span class="nf">sys.nframe</span><span class="p">()))</span><span class="w">  </span><span class="c1"># get the ID of the current environment</span>
<span class="w">    </span><span class="nf">str</span><span class="p">(</span><span class="nf">as.list</span><span class="p">(</span><span class="nf">sys.frame</span><span class="p">(</span><span class="nf">sys.nframe</span><span class="p">())))</span><span class="w">  </span><span class="c1"># display its contents</span>
<span class="p">}</span>
</pre></div>
</div>
<p>First call:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">test</span><span class="p">(</span><span class="m">2</span><span class="p">)</span>
<span class="c1">## [1] &quot;x&quot;</span>
<span class="c1">## &lt;environment: 0x56303309eaa0&gt;</span>
<span class="c1">## List of 2</span>
<span class="c1">##  $ y: num 4</span>
<span class="c1">##  $ x: num 2</span>
</pre></div>
</div>
<p>Second call:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">test</span><span class="p">(</span><span class="m">3</span><span class="p">)</span>
<span class="c1">## [1] &quot;x&quot;</span>
<span class="c1">## &lt;environment: 0x563033457fa0&gt;</span>
<span class="c1">## List of 2</span>
<span class="c1">##  $ y: num 9</span>
<span class="c1">##  $ x: num 3</span>
</pre></div>
</div>
<p>We note that each time, the current environment is different.
This is why we do not see the `<code class="docutils literal notranslate"><span class="pre">y</span></code>` variable at the start
of the second call. This is a brilliantly simple implementation
of the storage for local variables.</p>
</section>
<section id="lexical-scope-and-function-closures">
<span id="sec-lexical-scope"></span><h3><span class="section-number">16.3.2. </span>Lexical scope and function closures<a class="headerlink" href="#lexical-scope-and-function-closures" title="Permalink to this heading">#</a></h3>
<p>The fact that we were able to access the <strong class="command">print</strong> function
(amongst others) in the above example should make us wonder
what is the enclosing environment of that local environment.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">print_enclosure</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">function</span><span class="p">()</span>
<span class="w">    </span><span class="nf">print</span><span class="p">(</span><span class="nf">parent.env</span><span class="p">(</span><span class="nf">sys.frame</span><span class="p">(</span><span class="nf">sys.nframe</span><span class="p">())))</span>

<span class="nf">print_enclosure</span><span class="p">()</span>
<span class="c1">## &lt;environment: R_GlobalEnv&gt;</span>
</pre></div>
</div>
<p>It is the global environment. Let us evaluate the same function
from within another one:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">call_print_enclosure</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">function</span><span class="p">()</span>
<span class="w">    </span><span class="nf">print_enclosure</span><span class="p">()</span>

<span class="nf">call_print_enclosure</span><span class="p">()</span>
<span class="c1">## &lt;environment: R_GlobalEnv&gt;</span>
</pre></div>
</div>
<p>It is the global environment again.
If R had implemented the so-called <em>dynamic scoping</em>,
we would see the local environment of the function invoking the one above.
If this was true, we would have access to the local variables
of the caller from within the callee.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Objects of type <code class="docutils literal notranslate"><span class="pre">closure</span></code>, i.e., user-defined<a class="footnote-reference brackets" href="#footprimitive" id="id22" role="doc-noteref"><span class="fn-bracket">[</span>17<span class="fn-bracket">]</span></a> functions,
consist of three components:</p>
<ul class="simple">
<li><p>a list of formal arguments (compare <strong class="command">formals</strong>
and <a class="reference internal" href="320-language.html#sec-body-formals"><span class="std std-numref">Section 15.4.1</span></a>);</p></li>
<li><p>an expression (compare <strong class="command">body</strong> and  <a class="reference internal" href="320-language.html#sec-body-formals"><span class="std std-numref">Section 15.4.1</span></a>
again);</p></li>
<li><p>a reference to the <em>associated environment</em> where the function might store
data for further use (see <strong class="command">environment</strong>).</p></li>
</ul>
<p>By default, the associated environment is set to the current
environment where the function was created.</p>
<p>A local environment created during a function’s call
has this associated environment as its closure.</p>
<p>Due to this, we say that R has <em>lexical (static) scope</em>.</p>
</div>
<p>So in the above example, we have:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">environment</span><span class="p">(</span><span class="n">print_enclosure</span><span class="p">)</span><span class="w">  </span><span class="c1"># print the associated environment</span>
<span class="c1">## &lt;environment: R_GlobalEnv&gt;</span>
</pre></div>
</div>
<div class="proof proof-type-example" id="id40">

    <div class="proof-title">
        <span class="proof-type">Example 16.7</span>
        
    </div><div class="proof-content">
<p>Consider the following function that prints out `<code class="docutils literal notranslate"><span class="pre">x</span></code>` defined outside
of its scope:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">test</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">function</span><span class="p">()</span><span class="w"> </span><span class="nf">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
<p>Now:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">x</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s">&quot;x in global&quot;</span>
<span class="nf">test</span><span class="p">()</span>
<span class="c1">## [1] &quot;x in global&quot;</span>
</pre></div>
</div>
<p>printed out `<code class="docutils literal notranslate"><span class="pre">x</span></code>` from the user workspace, because this is exactly
the environment associated with the function.</p>
<p>However, setting the associated environment to a different
one that also happens to define `<code class="docutils literal notranslate"><span class="pre">x</span></code>`, will give a different result:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">e</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">new.env</span><span class="p">()</span>
<span class="n">e</span><span class="p">[[</span><span class="s">&quot;x&quot;</span><span class="p">]]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s">&quot;x in e&quot;</span>
<span class="nf">environment</span><span class="p">(</span><span class="n">test</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">e</span>
<span class="nf">test</span><span class="p">()</span>
<span class="c1">## [1] &quot;x in e&quot;</span>
</pre></div>
</div>
</div></div><div class="proof proof-type-example" id="id41">

    <div class="proof-title">
        <span class="proof-type">Example 16.8</span>
        
    </div><div class="proof-content">
<p>Let us demonstrate lexical scoping in action:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">test</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">function</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="nf">cat</span><span class="p">(</span><span class="nf">sprintf</span><span class="p">(</span><span class="s">&quot;test: current env: %s\n&quot;</span><span class="p">,</span><span class="w"> </span><span class="nf">format</span><span class="p">(</span><span class="nf">sys.frame</span><span class="p">(</span><span class="nf">sys.nframe</span><span class="p">()))))</span>

<span class="w">    </span><span class="n">subtest</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">function</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">e</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">sys.frame</span><span class="p">(</span><span class="nf">sys.nframe</span><span class="p">())</span>
<span class="w">        </span><span class="nf">cat</span><span class="p">(</span><span class="nf">sprintf</span><span class="p">(</span><span class="s">&quot;subtest: enclosing env: %s\n&quot;</span><span class="p">,</span><span class="w"> </span><span class="nf">format</span><span class="p">(</span><span class="nf">parent.env</span><span class="p">(</span><span class="n">e</span><span class="p">))))</span>
<span class="w">        </span><span class="nf">cat</span><span class="p">(</span><span class="nf">sprintf</span><span class="p">(</span><span class="s">&quot;x = %s\n&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s">&quot;spam&quot;</span>
<span class="w">    </span><span class="nf">subtest</span><span class="p">()</span>
<span class="w">    </span><span class="nf">environment</span><span class="p">(</span><span class="n">subtest</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">globalenv</span><span class="p">()</span>
<span class="w">    </span><span class="nf">subtest</span><span class="p">()</span>
<span class="p">}</span>

<span class="n">x</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s">&quot;bacon&quot;</span>
<span class="nf">test</span><span class="p">()</span>
<span class="c1">## test: current env: &lt;environment: 0x56303285b538&gt;</span>
<span class="c1">## subtest: enclosing env: &lt;environment: 0x56303285b538&gt;</span>
<span class="c1">## x = spam</span>
<span class="c1">## subtest: enclosing env: &lt;environment: R_GlobalEnv&gt;</span>
<span class="c1">## x = bacon</span>
</pre></div>
</div>
<p>Here is what happened:</p>
<ol class="arabic simple">
<li><p>A call to <strong class="command">test</strong> creates a local function <strong class="command">subtest</strong>,
whose associated environment is set to the local environment
associated to the current call.
This is exactly the current environment where <strong class="command">subtest</strong>
was created.</p></li>
<li><p>This is why <strong class="command">subtest</strong> can access the local variable `<code class="docutils literal notranslate"><span class="pre">x</span></code>`
inside its maker.</p></li>
<li><p>Then we change the environment associated with <strong class="command">subtest</strong>
to the global environment.</p></li>
<li><p>In the next call to <strong class="command">subtest</strong>, unsurprisingly,
now we get access to `<code class="docutils literal notranslate"><span class="pre">x</span></code>` in the user workspace.</p></li>
</ol>
</div></div><div class="admonition note">
<p class="admonition-title">Note</p>
<p>In theory, in lexical (static) scoping,
which variables a function is referring to can be deduced by reading the
function’s body only, and not how it is called in other contexts.
However, the fact that we can freely modify the associated environment
anywhere, can complicate the program analysis greatly.</p>
<p>If we find the rules of lexical scoping confusing, here are some simple
rules that guarantee a hygienic experience.</p>
<ol class="arabic simple">
<li><p>Define all our functions as top-level ones, i.e.,
in the global environment.</p></li>
<li><p>Only call functions from the attached packages,
other top-level functions, and temporary functions defined locally.</p></li>
<li><p>Do not refer to any other objects outside of the current scope
(“global variables”).</p></li>
</ol>
<p>Which is mostly what we have been doing so far.
Otherwise, let us make sure we always know what we are doing.</p>
</div>
</section>
<section id="application-function-factories">
<h3><span class="section-number">16.3.3. </span>Application: Function factories<a class="headerlink" href="#application-function-factories" title="Permalink to this heading">#</a></h3>
<p>As closures are functions with associated environments,
and the role of environments is to store information,
we can consider closures=functions+data.</p>
<p>We have seen that already in <a class="reference internal" href="210-design.html#sec-closures"><span class="std std-numref">Section 9.5.3</span></a>, where we
described the <strong class="command">approxfun</strong> function.
To recall:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">x</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">seq</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">length.out</span><span class="o">=</span><span class="m">11</span><span class="p">)</span>
<span class="n">f1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">approxfun</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="o">^</span><span class="m">2</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">f1</span><span class="p">)</span>
<span class="c1">## function (v)</span>
<span class="c1">## .approxfun(x, y, v, method, yleft, yright, f, na.rm)</span>
<span class="c1">## &lt;environment: 0x563032ecc9f0&gt;</span>
</pre></div>
</div>
<p>The variables `<code class="docutils literal notranslate"><span class="pre">x</span></code>`, `<code class="docutils literal notranslate"><span class="pre">y</span></code>`, etc. that <strong class="command">f1</strong>’s source code
refers to are stored inside its dedicated, associated environment:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">ls</span><span class="p">(</span><span class="n">envir</span><span class="o">=</span><span class="nf">environment</span><span class="p">(</span><span class="n">f1</span><span class="p">))</span>
<span class="c1">## [1] &quot;f&quot;      &quot;method&quot; &quot;na.rm&quot;  &quot;x&quot;      &quot;y&quot;      &quot;yleft&quot;  &quot;yright&quot;</span>
</pre></div>
</div>
<p>Routines such as <strong class="command">approxfun</strong> we are used to referring to
as <em>function factories</em>. They return functions whose
its non-local variables are stored in their associated environments.</p>
<div class="proof proof-type-example" id="id42">

    <div class="proof-title">
        <span class="proof-type">Example 16.9</span>
        
    </div><div class="proof-content">
<p>Consider the following function factory:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">gen_power</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">function</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
<span class="w">    </span><span class="nf">function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="n">x</span><span class="o">^</span><span class="n">p</span><span class="w">  </span><span class="c1"># p references a non-local variable</span>
</pre></div>
</div>
<p>A call to <strong class="command">gen_power</strong> creates a local environment
which defines one variable, `<code class="docutils literal notranslate"><span class="pre">p</span></code>`, where the value of the argument
is stored. Then, we create a function whose associated environment
(remember that R uses lexical scoping) is that local one.
Therefore, the reference to the non-local `<code class="docutils literal notranslate"><span class="pre">p</span></code>` in its body
will be resolved therein.
This new function is returned by <strong class="command">gen_power</strong> to the caller.
Normally, the local environment would be destroyed, but it is still
used after the call, hence it will not be garbage-collected.</p>
<p>Example calls:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">square</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">gen_power</span><span class="p">(</span><span class="m">2</span><span class="p">))</span>
<span class="c1">## function(x) x^p</span>
<span class="c1">## &lt;environment: 0x56303346c390&gt;</span>
<span class="p">(</span><span class="n">cube</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">gen_power</span><span class="p">(</span><span class="m">3</span><span class="p">))</span>
<span class="c1">## function(x) x^p</span>
<span class="c1">## &lt;environment: 0x5630334c7610&gt;</span>
<span class="nf">cube</span><span class="p">(</span><span class="m">2</span><span class="p">)</span>
<span class="c1">## [1] 8</span>
<span class="nf">square</span><span class="p">(</span><span class="m">2</span><span class="p">)</span>
<span class="c1">## [1] 4</span>
</pre></div>
</div>
<p>The underlying environment can of course be modified:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">assign</span><span class="p">(</span><span class="s">&quot;p&quot;</span><span class="p">,</span><span class="w"> </span><span class="m">7</span><span class="p">,</span><span class="w"> </span><span class="n">envir</span><span class="o">=</span><span class="nf">environment</span><span class="p">(</span><span class="n">cube</span><span class="p">))</span>
<span class="nf">cube</span><span class="p">(</span><span class="m">2</span><span class="p">)</span><span class="w">  </span><span class="c1"># so much for the cube</span>
<span class="c1">## [1] 128</span>
</pre></div>
</div>
</div></div><div class="proof proof-type-exercise" id="id43">

    <div class="proof-title">
        <span class="proof-type">Exercise 16.10</span>
        
    </div><div class="proof-content">
<p><strong class="command">Negate</strong> is another example of a built-in function factory.
Study its source code.</p>
</div></div><div class="proof proof-type-exercise" id="id44">

    <div class="proof-title">
        <span class="proof-type">Exercise 16.11</span>
        
    </div><div class="proof-content">
<p>Write a function factory named <strong class="command">gen_counter</strong> which
implements a simple counter that is increased by 1 upon each call thereto.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">gen_counter</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">function</span><span class="p">()</span><span class="w"> </span><span class="n">...to.do...</span>
<span class="n">c1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">gen_counter</span><span class="p">()</span>
<span class="n">c2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">gen_counter</span><span class="p">()</span>
<span class="nf">c</span><span class="p">(</span><span class="nf">c1</span><span class="p">(),</span><span class="w"> </span><span class="nf">c1</span><span class="p">(),</span><span class="w"> </span><span class="nf">c2</span><span class="p">(),</span><span class="w"> </span><span class="nf">c1</span><span class="p">(),</span><span class="w"> </span><span class="nf">c2</span><span class="p">())</span>
<span class="c1">## [1] 1 2 1 3 2</span>
</pre></div>
</div>
</div></div></section>
<section id="accessing-the-calling-environment">
<h3><span class="section-number">16.3.4. </span>Accessing the calling environment<a class="headerlink" href="#accessing-the-calling-environment" title="Permalink to this heading">#</a></h3>
<p>We know that the environment associated with a function
is not necessarily the same as the environment
from which the function was called, sometimes quite confusingly referred
to as the <em>parent frame</em>.</p>
<p>R maintains a whole <em>frame stack</em>. The global environment is assigned
number 0. Each call to a function increases the stack by 1 frame,
whereas returning from a call decreases the counter.</p>
<p>To get the current frame number, we call <strong class="command">sys.nframe</strong>.
This is why <strong class="command">sys.frame</strong><code class="code docutils literal notranslate"><span class="pre">(</span></code><strong class="command">sys.nframe</strong><code class="code docutils literal notranslate"><span class="pre">()</span></code>
returns the current environment.</p>
<p>We can fetch the calling environment  by referring to
<strong class="command">parent.frame</strong><code class="code docutils literal notranslate"><span class="pre">()</span></code> or
<strong class="command">sys.frame</strong><code class="code docutils literal notranslate"><span class="pre">(</span></code><strong class="command">sys.parent</strong><code class="code docutils literal notranslate"><span class="pre">()</span></code>,
amongst others<a class="footnote-reference brackets" href="#footparentframe" id="id23" role="doc-noteref"><span class="fn-bracket">[</span>18<span class="fn-bracket">]</span></a>.</p>
<p>Thanks to <strong class="command">parent.frame</strong>, we may easily evaluate arbitrary
expressions in (on behalf of) the calling environment.
Normally, we should not be doing that,
but some built-in functions rely on this feature, hence our avid interest
in it here. In the subsections below, we will discuss a few its use cases.</p>
</section>
<section id="not-all-arguments-need-to-be-evaluated-immediately">
<span id="sec-not-all-args-eval"></span><h3><span class="section-number">16.3.5. </span>🚧 Not all arguments need to be evaluated (immediately)<a class="headerlink" href="#not-all-arguments-need-to-be-evaluated-immediately" title="Permalink to this heading">#</a></h3>
<p>… to do … working on it …</p>
<p>Calls such as
`<strong class="command">if</strong>`<code class="code docutils literal notranslate"><span class="pre">(test,</span> <span class="pre">ifyes,</span> <span class="pre">ifno)</span></code>
or `<strong class="command">&amp;&amp;</strong>`<code class="code docutils literal notranslate"><span class="pre">(mustbe,</span> <span class="pre">maybe)</span></code>
do not have to evaluate all their arguments.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="nf">cat</span><span class="p">(</span><span class="s">&quot; first &quot;</span><span class="p">);</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">}</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">{</span><span class="nf">cat</span><span class="p">(</span><span class="s">&quot; second &quot;</span><span class="p">);</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">}</span>
<span class="c1">##  first</span>
<span class="c1">## [1] FALSE</span>
<span class="p">{</span><span class="nf">cat</span><span class="p">(</span><span class="s">&quot; first &quot;</span><span class="p">);</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">}</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">{</span><span class="nf">cat</span><span class="p">(</span><span class="s">&quot; Spanish Inquisition &quot;</span><span class="p">);</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">}</span>
<span class="c1">##  first  Spanish Inquisition</span>
<span class="c1">## [1] FALSE</span>
</pre></div>
</div>
<p>This is also a kind of nonstandard evaluation.</p>
<p>We can write such functions ourselves.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">test</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">function</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">)</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">c</span><span class="w">  </span><span class="c1"># b is unused</span>

<span class="nf">test</span><span class="p">({</span><span class="nf">cat</span><span class="p">(</span><span class="s">&quot; spam &quot;</span><span class="p">);</span><span class="w"> </span><span class="m">1</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="nf">cat</span><span class="p">(</span><span class="s">&quot; eggs &quot;</span><span class="p">);</span><span class="w"> </span><span class="m">10</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="nf">cat</span><span class="p">(</span><span class="s">&quot; bacon &quot;</span><span class="p">);</span><span class="w"> </span><span class="m">100</span><span class="p">})</span>
<span class="c1">##  spam  bacon</span>
<span class="c1">## [1] 101</span>
</pre></div>
</div>
<p>Here, the second argument was not used. Therefore,
it did not have to be evaluated. And it was not.</p>
<p>A more advanced example:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">test</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">function</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="nf">cat</span><span class="p">(</span><span class="s">&quot;Arguments passed to the functions (expressions): \n&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nf">cat</span><span class="p">(</span><span class="s">&quot;a = &quot;</span><span class="p">,</span><span class="w"> </span><span class="nf">deparse</span><span class="p">(</span><span class="nf">substitute</span><span class="p">(</span><span class="n">a</span><span class="p">)),</span><span class="w"> </span><span class="s">&quot;\n&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nf">cat</span><span class="p">(</span><span class="s">&quot;b = &quot;</span><span class="p">,</span><span class="w"> </span><span class="nf">deparse</span><span class="p">(</span><span class="nf">substitute</span><span class="p">(</span><span class="n">b</span><span class="p">)),</span><span class="w"> </span><span class="s">&quot;\n&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nf">cat</span><span class="p">(</span><span class="s">&quot;c = &quot;</span><span class="p">,</span><span class="w"> </span><span class="nf">deparse</span><span class="p">(</span><span class="nf">substitute</span><span class="p">(</span><span class="n">c</span><span class="p">)),</span><span class="w"> </span><span class="s">&quot;\n&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nf">cat</span><span class="p">(</span><span class="s">&quot;Using a: &quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">a</span><span class="w">  </span><span class="c1"># we don&#39;t even have to be particularly creative</span>
<span class="w">    </span><span class="nf">cat</span><span class="p">(</span><span class="s">&quot;Using a and c: &quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">retval</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">c</span><span class="w">  </span><span class="c1"># a is reused, b is unused</span>
<span class="w">    </span><span class="nf">cat</span><span class="p">(</span><span class="s">&quot;Cheers! &quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">retval</span>
<span class="p">}</span>

<span class="nf">test</span><span class="p">({</span><span class="nf">cat</span><span class="p">(</span><span class="s">&quot; spam &quot;</span><span class="p">);</span><span class="w"> </span><span class="m">1</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="nf">cat</span><span class="p">(</span><span class="s">&quot; eggs &quot;</span><span class="p">);</span><span class="w"> </span><span class="nf">MeAn</span><span class="p">(</span><span class="n">egGs</span><span class="p">)},</span><span class="w"> </span><span class="p">{</span><span class="nf">cat</span><span class="p">(</span><span class="s">&quot; bacon &quot;</span><span class="p">);</span><span class="w"> </span><span class="m">100</span><span class="p">})</span>
<span class="c1">## Arguments passed to the functions (expressions):</span>
<span class="c1">## a =  {     cat(&quot; spam &quot;)     1 }</span>
<span class="c1">## b =  {     cat(&quot; eggs &quot;)     MeAn(egGs) }</span>
<span class="c1">## c =  {     cat(&quot; bacon &quot;)     100 }</span>
<span class="c1">## Using a:  spam Using a and c:  bacon Cheers!</span>
<span class="c1">## [1] 101</span>
</pre></div>
</div>
<p>Notice that:</p>
<ul class="simple">
<li><p>either the evaluation of an argument does not happen
or it is triggered only once (in which case the result is cached);</p></li>
<li><p>evaluation is <em>delayed</em> until the very first request for the underlying
value;</p></li>
<li><p>evaluation takes place in the calling environment (parent frame);</p></li>
<li><p>regardless whether we request it or not, we still have access to the
unevaluated expression passed as the argument.</p></li>
</ul>
<p>As a consequence, we can pass arbitrary gibberish as the second argument
(and we did above).</p>
<p>In other words, the evaluation of arguments can be postponed arbitrarily,
possibly forever.</p>
<div class="proof proof-type-exercise" id="id45">

    <div class="proof-title">
        <span class="proof-type">Exercise 16.12</span>
        
    </div><div class="proof-content">
<p>Study the source code of <strong class="command">system.time</strong> and
note the use of delayed evaluation to measure the execution
time of a given expression.
Also note the use of <strong class="command">on.exit</strong> (<a class="reference internal" href="#sec-on-exit"><span class="std std-numref">Section 16.3.9</span></a>)
to react to possible exceptions.</p>
</div></div><div class="proof proof-type-exercise" id="id46">

    <div class="proof-title">
        <span class="proof-type">Exercise 16.13</span>
        
    </div><div class="proof-content">
<p>Implement your own version of the built-in <strong class="command">switch</strong> function.</p>
</div></div></section>
<section id="evaluation-of-default-arguments">
<span id="sec-default-args-eval"></span><h3><span class="section-number">16.3.6. </span>🚧 Evaluation of default arguments<a class="headerlink" href="#evaluation-of-default-arguments" title="Permalink to this heading">#</a></h3>
<p>… to do … working on it …</p>
</section>
<section id="matching-of-argument-names">
<span id="sec-pmatch"></span><h3><span class="section-number">16.3.7. </span>🚧 Matching of argument names<a class="headerlink" href="#matching-of-argument-names" title="Permalink to this heading">#</a></h3>
<p>… to do … working on it …</p>
</section>
<section id="ellipsis-revisited">
<span id="sec-ellipsis-eval"></span><h3><span class="section-number">16.3.8. </span>🚧 Ellipsis revisited<a class="headerlink" href="#ellipsis-revisited" title="Permalink to this heading">#</a></h3>
<p>… to do … working on it …</p>
</section>
<section id="on-exit">
<span id="sec-on-exit"></span><h3><span class="section-number">16.3.9. </span><strong class="command">on.exit</strong><a class="headerlink" href="#on-exit" title="Permalink to this heading">#</a></h3>
<p><strong class="command">on.exit</strong> registers an expression to be evaluated
at the very end of a function call. It might be used to
re-set the temporarily modified graphical parameters (see <strong class="command">par</strong>)
and system options (<strong class="command">options</strong>),
or clean up the allocated resources (e.g., closing open files).</p>
<p>For instance:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">test</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">function</span><span class="p">(</span><span class="n">reset</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="nf">on.exit</span><span class="p">(</span><span class="nf">print</span><span class="p">(</span><span class="s">&quot;eggs&quot;</span><span class="p">))</span>
<span class="w">    </span><span class="nf">on.exit</span><span class="p">(</span><span class="nf">print</span><span class="p">(</span><span class="s">&quot;bacon&quot;</span><span class="p">))</span><span class="w">  </span><span class="c1"># replace</span>
<span class="w">    </span><span class="nf">on.exit</span><span class="p">(</span><span class="nf">print</span><span class="p">(</span><span class="s">&quot;spam&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">add</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span><span class="w">  </span><span class="c1"># add</span>

<span class="w">    </span><span class="nf">print</span><span class="p">(</span><span class="s">&quot;roti canai&quot;</span><span class="p">)</span>

<span class="w">    </span><span class="nf">if </span><span class="p">(</span><span class="n">reset</span><span class="p">)</span>
<span class="w">        </span><span class="nf">on.exit</span><span class="p">()</span><span class="w">  </span><span class="c1"># cancels all (replace by nothing)</span>

<span class="w">    </span><span class="s">&quot;end.&quot;</span><span class="w">  </span><span class="c1"># return value</span>
<span class="p">}</span>

<span class="n">x</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">test</span><span class="p">()</span>
<span class="c1">## [1] &quot;roti canai&quot;</span>
<span class="c1">## [1] &quot;bacon&quot;</span>
<span class="c1">## [1] &quot;spam&quot;</span>
<span class="nf">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="c1">## [1] &quot;end.&quot;</span>
<span class="n">x</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">test</span><span class="p">(</span><span class="kc">TRUE</span><span class="p">)</span>
<span class="c1">## [1] &quot;roti canai&quot;</span>
<span class="nf">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="c1">## [1] &quot;end.&quot;</span>
</pre></div>
</div>
<p>Note that we can always do without <strong class="command">on.exit</strong>,
e.g., by applying proper exception handling techniques;
<a class="reference internal" href="180-flow.html#sec-exceptions"><span class="std std-numref">Section 8.2</span></a>.</p>
<div class="proof proof-type-exercise" id="id47">

    <div class="proof-title">
        <span class="proof-type">Exercise 16.14</span>
        
    </div><div class="proof-content">
<p>Note the call to:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">on.exit</span><span class="p">(</span><span class="nf">close</span><span class="p">(</span><span class="n">file</span><span class="p">))</span>
</pre></div>
</div>
<p>in the definition of <strong class="command">scan</strong>.
What is its purpose?</p>
</div></div><div class="proof proof-type-exercise" id="id48">

    <div class="proof-title">
        <span class="proof-type">Exercise 16.15</span>
        
    </div><div class="proof-content">
<p>Why does <strong class="command">graphics::barplot.default</strong> call the following
expressions?</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">dev.hold</span><span class="p">()</span>
<span class="n">opar</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">if </span><span class="p">(</span><span class="n">horiz</span><span class="p">)</span><span class="w"> </span><span class="nf">par</span><span class="p">(</span><span class="n">xaxs</span><span class="o">=</span><span class="s">&quot;i&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">xpd</span><span class="o">=</span><span class="n">xpd</span><span class="p">)</span><span class="w"> </span><span class="n">else</span><span class="w"> </span><span class="nf">par</span><span class="p">(</span><span class="n">yaxs</span><span class="o">=</span><span class="s">&quot;i&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">xpd</span><span class="o">=</span><span class="n">xpd</span><span class="p">)</span>
<span class="nf">on.exit</span><span class="p">({</span>
<span class="w">    </span><span class="nf">dev.flush</span><span class="p">()</span>
<span class="w">    </span><span class="nf">par</span><span class="p">(</span><span class="n">opar</span><span class="p">)</span>
<span class="p">})</span>
</pre></div>
</div>
</div></div></section>
<section id="example-functions-relying-on-metaprogramming">
<span id="sec-metaprogramming-implement"></span><h3><span class="section-number">16.3.10. </span>🚧 Example functions relying on metaprogramming (**)<a class="headerlink" href="#example-functions-relying-on-metaprogramming" title="Permalink to this heading">#</a></h3>
<p>… to do … working on it …</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Due to the similarity between environments and named lists (and hence data
frames), <strong class="command">eval</strong> can also be called like:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">eval</span><span class="p">(</span><span class="nf">quote</span><span class="p">(</span><span class="nf">head</span><span class="p">(</span><span class="n">Sepal.Length</span><span class="p">)),</span><span class="w"> </span><span class="n">envir</span><span class="o">=</span><span class="n">iris</span><span class="p">)</span>
<span class="c1">## [1] 5.1 4.9 4.7 4.6 5.0 5.4</span>
</pre></div>
</div>
<p>which evaluates the given expression in something like
<strong class="command">list2env</strong><code class="code docutils literal notranslate"><span class="pre">(iris,</span> <span class="pre">parent=</span></code><strong class="command">parent.frame</strong><code class="code docutils literal notranslate"><span class="pre">())</span></code>.
Note that thanks to the enclosure’s being set to the calling frame,
we can successfully refer to the <strong class="command">head</strong> function.</p>
</div>
</section>
<section id="processing-formulas">
<span id="sec-formula"></span><h3><span class="section-number">16.3.11. </span>🚧 Processing Formulas, `<strong class="command">~</strong>` (*)<a class="headerlink" href="#processing-formulas" title="Permalink to this heading">#</a></h3>
<p>… to do … working on it …</p>
</section>
</section>
<section id="other-concepts">
<h2><span class="section-number">16.4. </span>🚧 Other concepts<a class="headerlink" href="#other-concepts" title="Permalink to this heading">#</a></h2>
<p>… to do … working on it …</p>
<section id="package-namespaces">
<h3><span class="section-number">16.4.1. </span>🚧 Package namespaces (*)<a class="headerlink" href="#package-namespaces" title="Permalink to this heading">#</a></h3>
<p>… to do … working on it …</p>
<p>According to <span id="id24">[<a class="reference internal" href="999-bibliography.html#id14" title="R Development Core Team. (2023).  Writing R Extensions. URL: https://CRAN.R-project.org/doc/manuals/r-release/R-exts.html.">48</a>]</span> and <span id="id25">[<a class="reference internal" href="999-bibliography.html#id12" title="R Development Core Team. (2023).  R Internals. URL: https://CRAN.R-project.org/doc/manuals/r-release/R-ints.html.">51</a>]</span>, ….</p>
<p>We will use an example <strong class="program">rpackagedemo</strong> package
discussed <a class="reference internal" href="170-function.html#sec-src-package"><span class="std std-numref">Section 7.3.1.2</span></a>, which is available
for download from <a class="reference external" href="https://github.com/gagolews/rpackagedemo/">https://github.com/gagolews/rpackagedemo/</a>.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">library</span><span class="p">(</span><span class="s">&quot;rpackagedemo&quot;</span><span class="p">)</span><span class="w">  </span><span class="c1"># https://github.com/gagolews/rpackagedemo/</span>
<span class="c1">## Attaching package: &#39;rpackagedemo&#39;</span>
<span class="c1">## The following object is masked from &#39;package:utils&#39;: demo</span>
<span class="nf">demo</span><span class="p">(</span><span class="s">&quot;Sir Lancelot&quot;</span><span class="p">)</span>
<span class="c1">## G&#39;day, Sir Lancelot!</span>
<span class="n">demo</span>
<span class="c1">## function (x = &quot;world&quot;)</span>
<span class="c1">## {</span>
<span class="c1">##     cat(prepare_message(x))</span>
<span class="c1">## }</span>
<span class="c1">## &lt;environment: namespace:rpackagedemo&gt;</span>
<span class="n">prepare_message</span>
<span class="c1">## Error in eval(expr, envir, enclos): object &#39;prepare_message&#39; not found</span>
<span class="n">rpackagedemo</span><span class="o">:::</span><span class="n">prepare_message</span>
<span class="c1">## function (x)</span>
<span class="c1">## {</span>
<span class="c1">##     sprintf(&quot;G&#39;day, %s!\n&quot;, x)</span>
<span class="c1">## }</span>
<span class="c1">## &lt;environment: namespace:rpackagedemo&gt;</span>
<span class="n">prepare_message</span><span class="w"> </span><span class="o">&lt;&lt;-</span><span class="w"> </span><span class="nf">function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="s">&quot;aaargh&quot;</span>
<span class="nf">demo</span><span class="p">(</span><span class="s">&quot;Sir Lancelot&quot;</span><span class="p">)</span>
<span class="c1">## G&#39;day, Sir Lancelot!</span>
<span class="nf">getNamespaceExports</span><span class="p">(</span><span class="s">&quot;rpackagedemo&quot;</span><span class="p">)</span>
<span class="c1">## [1] &quot;demo&quot;</span>
<span class="nf">getNamespaceImports</span><span class="p">(</span><span class="s">&quot;rpackagedemo&quot;</span><span class="p">)</span>
<span class="c1">## $base</span>
<span class="c1">## [1] TRUE</span>
<span class="c1">##</span>
<span class="c1">## $stringx</span>
<span class="c1">##   sprintf</span>
<span class="c1">## &quot;sprintf&quot;</span>
<span class="nf">assign</span><span class="p">(</span><span class="s">&quot;prepare_message&quot;</span><span class="p">,</span><span class="w"> </span><span class="nf">function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="s">&quot;aaargh&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="n">envir</span><span class="o">=</span><span class="nf">getNamespace</span><span class="p">(</span><span class="s">&quot;rpackagedemo&quot;</span><span class="p">))</span>
<span class="c1">## Error in assign(&quot;prepare_message&quot;, function(x) &quot;aaargh&quot;, envir =</span>
<span class="c1">##     getNamespace(&quot;rpackagedemo&quot;)): cannot change value of locked binding</span>
<span class="c1">##     for &#39;prepare_message&#39;</span>
<span class="nf">getNamespace</span><span class="p">(</span><span class="s">&quot;rpackagedemo&quot;</span><span class="p">)</span>
<span class="c1">## &lt;environment: namespace:rpackagedemo&gt;</span>
</pre></div>
</div>
</section>
<section id="s3-method-lookup-by-usemethod">
<span id="sec-use-method"></span><h3><span class="section-number">16.4.2. </span>🚧 S3 method lookup by <strong class="command">UseMethod</strong><a class="headerlink" href="#s3-method-lookup-by-usemethod" title="Permalink to this heading">#</a></h3>
<p>… to do … working on it …</p>
</section>
<section id="overloading-s3-group-generics">
<span id="sec-group-generics"></span><h3><span class="section-number">16.4.3. </span>🚧 Overloading S3 group generics<a class="headerlink" href="#overloading-s3-group-generics" title="Permalink to this heading">#</a></h3>
<p>… to do … working on it …</p>
</section>
</section>
<section id="exercises">
<h2><span class="section-number">16.5. </span>Exercises<a class="headerlink" href="#exercises" title="Permalink to this heading">#</a></h2>
<div class="proof proof-type-exercise" id="id49">

    <div class="proof-title">
        <span class="proof-type">Exercise 16.16</span>
        
    </div><div class="proof-content">
<p>Asking too many questions is not very charismatic,
but challenge yourself with the following.</p>
<ul class="simple">
<li><p>What is the role of a frame in an environment?</p></li>
<li><p>What is the role of an enclosing environment? How to read
it or set it?</p></li>
<li><p>What is the difference between a named list and an environment?</p></li>
<li><p>What functions and operators work on named lists but cannot be
applied on environments?</p></li>
<li><p>What do we mean by saying that environments are not passed by value
to R functions?</p></li>
<li><p>What do we mean by saying that objects are sometimes copied on demand?</p></li>
<li><p>What happens if a name listed in an expression to be evaluated
is not found in the current environment?</p></li>
<li><p>How and what kind of objects can we attach onto the search path?</p></li>
<li><p>What happens if we have two identical object names on the search path?</p></li>
<li><p>What do we mean by saying that namespace environments
of packages with namespaces are locked when loaded?</p></li>
<li><p>What is the current environment when we evaluate an expression
“on the console”?</p></li>
<li><p>What is the difference between `<strong class="command">&lt;-</strong>` and `<strong class="command">&lt;&lt;-</strong>`?</p></li>
<li><p>Do packages have their own search paths?</p></li>
<li><p>What is a function closure?</p></li>
<li><p>What is the difference between a dynamic and a lexical scope?</p></li>
<li><p>When evaluating a function, how the enclosure of the current
(local) environment is determined? Is it the same as the calling
environment? How to get it/them programmatically?</p></li>
<li><p>How and why function factories work?</p></li>
<li><p>What is the role of promises?</p></li>
<li><p>Why the use of functions relying on metaprogramming is generally
discouraged?</p></li>
<li><p>Is there anything special about formulas?</p></li>
<li><p>What is the difference between <strong class="program">package:pkg</strong> and
<strong class="program">namespace:pkg</strong>?</p></li>
<li><p>How to fetch the definition of an S3 method which does not seem
to be available directly via the
standard accessor <strong class="command">fun_name.class_name</strong>?</p></li>
</ul>
</div></div><div class="proof proof-type-exercise" id="id50">

    <div class="proof-title">
        <span class="proof-type">Exercise 16.17</span>
        
    </div><div class="proof-content">
<p>Calling:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">pkg</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">available.packages</span><span class="p">()</span>
<span class="n">pkg</span><span class="p">[,</span><span class="w"> </span><span class="s">&quot;Package&quot;</span><span class="p">]</span><span class="w">  </span><span class="c1"># a list of the names of available packages</span>
<span class="n">pkg</span><span class="p">[,</span><span class="w"> </span><span class="s">&quot;Depends&quot;</span><span class="p">]</span><span class="w">  </span><span class="c1"># dependencies</span>
</pre></div>
</div>
<p>gives the list of available packages and their dependencies.
Convert the dependency lists to a list of character vectors
(preferably using regular expressions; see <a class="reference internal" href="160-character.html#sec-regex"><span class="std std-numref">Section 6.2.4</span></a>).</p>
<p>Then, generate a list of reverse dependencies: what packages depend
on each given package.</p>
<p>Use an object of type environment (a hast table)
to map the package names to numeric IDs (indexes). This will greatly
speed up the processing (compare it to a named list-based implementation).</p>
</div></div><div class="proof proof-type-exercise" id="id51">

    <div class="proof-title">
        <span class="proof-type">Exercise 16.18</span>
        
    </div><div class="proof-content">
<p>According to <span id="id26">[<a class="reference internal" href="999-bibliography.html#id10" title="R Development Core Team. (2023).  R Language Definition. URL: https://CRAN.R-project.org/doc/manuals/r-release/R-lang.html.">52</a>]</span>, a call to:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">))</span><span class="w"> </span><span class="o">&lt;&lt;-</span><span class="w"> </span><span class="n">v</span>
</pre></div>
</div>
<p>translates to:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">`*tmp*`</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">envir</span><span class="o">=</span><span class="nf">parent.env</span><span class="p">(),</span><span class="w"> </span><span class="n">inherits</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span>
<span class="n">x</span><span class="w"> </span><span class="o">&lt;&lt;-</span><span class="w"> </span><span class="nf">`add&lt;-`</span><span class="p">(</span><span class="n">`*tmp*`</span><span class="p">,</span><span class="w"> </span><span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">),</span><span class="w"> </span><span class="n">v</span><span class="p">)</span><span class="w">  </span><span class="c1"># note: not f(`*tmp*`)</span>
<span class="nf">rm</span><span class="p">(</span><span class="n">`*tmp*`</span><span class="p">)</span>
</pre></div>
</div>
<p>Given:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">`add&lt;-`</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">where</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">x</span><span class="p">[</span><span class="n">where</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="n">where</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">value</span>
<span class="w">    </span><span class="n">x</span><span class="w">  </span><span class="c1"># the modified object that will replace the original one</span>
<span class="p">}</span>

<span class="n">y</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="m">5</span>
<span class="n">f</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="o">-</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="m">5</span><span class="p">);</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="o">==</span><span class="m">-3</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;-</span><span class="w"> </span><span class="m">1000</span><span class="p">;</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="p">}</span>
</pre></div>
</div>
<p>Explain why the following calls yield the results they give:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">f</span><span class="p">()</span>
<span class="c1">## [1] -1 -2 -3 -4 -5</span>
<span class="nf">print</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<span class="c1">## [1]    1    2 1003    4    5</span>
</pre></div>
</div>
</div></div></section>
<section id="outro">
<h2><span class="section-number">16.6. </span>Outro<a class="headerlink" href="#outro" title="Permalink to this heading">#</a></h2>
<p>Let us recall our first approximation to the classification
of R Data Types that we presented in the <a class="reference internal" href="000-preface.html#chap-preface"><span class="std std-ref">Preface</span></a>.
As a summary of what we have covered in this book, let us contemplate
upon <a class="reference internal" href="#fig-data-types-full"><span class="std std-numref">Figure 16.3</span></a>, which gives a much broader picture.</p>
<figure class="align-default" id="id52">
<span id="fig-data-types-full"></span><img alt="../_images/data-types-full.png" src="../_images/data-types-full.png" />
<figcaption>
<p><span class="caption-number">Figure 16.3 </span><span class="caption-text">R data types</span><a class="headerlink" href="#id52" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<p>If we omitted something, it was most likely on purpose –
either we can now study it on our own easily, it is not really
worth our attention, or it violates our <em>minimalist</em> design principles
that we explained in the <a class="reference internal" href="000-preface.html#chap-preface"><span class="std std-ref">Preface</span></a>.</p>
<p>Now that we have reached the end of this course,
we might be interested in reading the following materials:</p>
<ul class="simple">
<li><p><em>R Language Definition</em> <span id="id27">[<a class="reference internal" href="999-bibliography.html#id10" title="R Development Core Team. (2023).  R Language Definition. URL: https://CRAN.R-project.org/doc/manuals/r-release/R-lang.html.">52</a>]</span>,</p></li>
<li><p><em>R Internals</em> <span id="id28">[<a class="reference internal" href="999-bibliography.html#id12" title="R Development Core Team. (2023).  R Internals. URL: https://CRAN.R-project.org/doc/manuals/r-release/R-ints.html.">51</a>]</span>,</p></li>
<li><p><em>Writing R Extensions</em> <span id="id29">[<a class="reference internal" href="999-bibliography.html#id14" title="R Development Core Team. (2023).  Writing R Extensions. URL: https://CRAN.R-project.org/doc/manuals/r-release/R-exts.html.">48</a>]</span>,</p></li>
<li><p>R’s source code available at <a class="reference external" href="https://cran.r-project.org/src/base/">https://cran.r-project.org/src/base/</a>,</p></li>
<li><p>The open-access
<a class="reference external" href="https://datawranglingpy.gagolewski.com/"><em>Minimalist data wrangling with Python</em></a> <span id="id30">[<a class="reference internal" href="999-bibliography.html#id3" title="Gagolewski, M. (2022).  Minimalist Data Wrangling with Python. Zenodo, Melbourne. URL: https://datawranglingpy.gagolewski.com/, DOI: 10.5281/zenodo.6451068.">21</a>]</span> by yours truly.</p></li>
</ul>
<p>Also, the <code class="docutils literal notranslate"><span class="pre">NEWS</span></code> files available at
<a class="reference external" href="https://cran.r-project.org/doc/manuals/r-release/">https://cran.r-project.org/doc/manuals/r-release/</a>
will keep us up to date with new features, bug fixes,
and deprecated functionality; see also the <strong class="command">news</strong> function.</p>
<p>Good luck!</p>
<hr class="footnotes docutils" />
<aside class="footnote-list brackets">
<aside class="footnote brackets" id="footdf" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id2">1</a><span class="fn-bracket">]</span></span>
<p>Not to be confused with a <em>data frame</em>, i.e., an object
of S3 class <code class="docutils literal notranslate"><span class="pre">data.frame</span></code>; see <a class="reference internal" href="240-data-frame.html#chap-data-frame"><span class="std std-numref">Chapter 12</span></a>.</p>
</aside>
<aside class="footnote brackets" id="footencpar" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id3">2</a><span class="fn-bracket">]</span></span>
<p>Some also call it a <em>parent</em> environment,
but we will not. We will try following the nomenclature
established in Section 3.2 in <span id="id31">[<a class="reference internal" href="999-bibliography.html#id15" title="Abelson, H., Sussman, G.J., and Sussman, J. (1996).  Structure and Interpretation of Computer Programs. MIT Press.">1</a>]</span>.
Note that there is a bit of a mess in the R documentation
regarding the way enclosing environments are referred to as.</p>
</aside>
<aside class="footnote brackets" id="footdiscourage" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id4">3</a><span class="fn-bracket">]</span></span>
<p>Which might be by design, to discourage the novices
from playing with fire.</p>
</aside>
<aside class="footnote brackets" id="footnamesattr" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id5">4</a><span class="fn-bracket">]</span></span>
<p>Even though the <code class="docutils literal notranslate"><span class="pre">names</span></code> attribute is not set explicitly,
the corresponding function returns a sensible result.</p>
</aside>
<aside class="footnote brackets" id="footquickhash" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id7">5</a><span class="fn-bracket">]</span></span>
<p>Element lookup, insertion, and deletion
in hash tables takes amortised <span class="math notranslate nohighlight">\(O(1)\)</span> time.</p>
</aside>
<aside class="footnote brackets" id="footlisttime" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id8">6</a><span class="fn-bracket">]</span></span>
<p>Accessing elements by position (numeric index)
in lists takes <span class="math notranslate nohighlight">\(O(1)\)</span> time.
Worst-case scenario for the element look-up by name (non-existence)
is linear with respect to the container size.
Also, inserting new elements at the end takes amortised <span class="math notranslate nohighlight">\(O(1)\)</span> time.</p>
</aside>
<aside class="footnote brackets" id="footdelayed" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id9">7</a><span class="fn-bracket">]</span></span>
<p>Delayed (on demand); see below.</p>
</aside>
<aside class="footnote brackets" id="foottrickery" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id10">8</a><span class="fn-bracket">]</span></span>
<p>Tricks that we can do at the C language level do not
count (<a class="reference internal" href="310-compiled.html#chap-compiled"><span class="std std-numref">Chapter 14</span></a>).</p>
</aside>
<aside class="footnote brackets" id="footr5" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id11">9</a><span class="fn-bracket">]</span></span>
<p>Some call them R5, but we will not.</p>
</aside>
<aside class="footnote brackets" id="footassign" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id15">10</a><span class="fn-bracket">]</span></span>
<p>Let us for now take for granted that `<strong class="command">&lt;-</strong>`
is accessible from the current context and denotes assignment.</p>
</aside>
<aside class="footnote brackets" id="footlazystudent" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id16">11</a><span class="fn-bracket">]</span></span>
<p>Which we should have done already long time ago,
but most likely we did not.</p>
</aside>
<aside class="footnote brackets" id="footc" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id17">12</a><span class="fn-bracket">]</span></span>
<p>This is why we can write <code class="docutils literal notranslate"><span class="pre">c</span> <span class="pre">&lt;-</span> </code><strong class="command">c</strong><code class="code docutils literal notranslate"><span class="pre">(1,</span> <span class="pre">2)</span></code>
and then still be able to call <strong class="command">c</strong> to create another
vector.</p>
</aside>
<aside class="footnote brackets" id="footunload" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id18">13</a><span class="fn-bracket">]</span></span>
<p>Which does not unload the package from memory, though;
see <strong class="command">unload</strong> (possibly combined with
<strong class="command">library.dynam.unload</strong>).</p>
</aside>
<aside class="footnote brackets" id="footattachenv" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id19">14</a><span class="fn-bracket">]</span></span>
<p>Or we should rather say, environment frames.
When an environment is attached onto the search path,
it is cloned (so that the changes made to the original environment
are not reflected in the copy) and its previous enclosure is discarded.
After all, we want a series of recursive calls to
<strong class="command">parent.env</strong> to form the whole search path.</p>
</aside>
<aside class="footnote brackets" id="footpkglock" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id20">15</a><span class="fn-bracket">]</span></span>
<p>We normally cannot modify package environments
from the search path. As we will soon see, they are automatically locked.</p>
</aside>
<aside class="footnote brackets" id="footlocarg" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id21">16</a><span class="fn-bracket">]</span></span>
<p>Function arguments are initially unevaluated;
see <a class="reference internal" href="#sec-not-all-args-eval"><span class="std std-numref">Section 16.3.5</span></a>.</p>
</aside>
<aside class="footnote brackets" id="footprimitive" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id22">17</a><span class="fn-bracket">]</span></span>
<p>There are two other types of functions:
a <code class="docutils literal notranslate"><span class="pre">special</span></code> is an internal function that
does not necessarily evaluate its arguments (e.g.,
<strong class="command">switch</strong>, <strong class="command">if</strong>, or <strong class="command">quote</strong>;
compare also <a class="reference internal" href="#sec-not-all-args-eval"><span class="std std-numref">Section 16.3.5</span></a>),
whereas a <code class="docutils literal notranslate"><span class="pre">builtin</span></code> always evaluates its actual parameters,
e.g., <strong class="command">sum</strong>.</p>
</aside>
<aside class="footnote brackets" id="footparentframe" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id23">18</a><span class="fn-bracket">]</span></span>
<p>In <strong class="command">help</strong><code class="code docutils literal notranslate"><span class="pre">(&quot;sys.parent&quot;)</span></code>, we read that
the parent frame number, as returned by <strong class="command">sys.parent</strong><code class="code docutils literal notranslate"><span class="pre">()</span></code>,
is not necessarily equal to <strong class="command">sys.nframe</strong><code class="code docutils literal notranslate"><span class="pre">()-1</span></code>.
This is certainly true if we are at the top (global) level.</p>
</aside>
</aside>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="998-changelog.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Changelog</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="320-language.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title"><span class="section-number">15. </span>🚧 Unevaluated expressions (**)</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
              
              
              Copyright &#169; 2022–2023 by <a href="https://www.gagolewski.com">Marek Gagolewski</a>.
              Some rights reserved. Licensed under <a href='https://creativecommons.org/licenses/by-nc-nd/4.0/'>CC BY-NC-ND 4.0</a>.
              Built with <a href="https://sphinx-doc.org/">Sphinx</a>
              and a customised <a href="https://github.com/pradyunsg/furo">Furo</a> theme.
              Last updated on 2023-03-29T19:52:58+1100.
              This site will never display any ads: it is a non-profit project.
              It does not collect any data.
            </div>
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            In this chapter
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">16. 🚧🚧 Environments and evaluation (**)</a><ul>
<li><a class="reference internal" href="#frames-environments-as-object-containers">16.1. Frames: Environments as object containers</a><ul>
<li><a class="reference internal" href="#printing">16.1.1. Printing</a></li>
<li><a class="reference internal" href="#environments-vs-named-lists">16.1.2. Environments vs named lists</a></li>
<li><a class="reference internal" href="#hash-maps-fast-element-look-up-by-name">16.1.3. Hash maps: Fast element look-up by name</a></li>
<li><a class="reference internal" href="#pass-by-value-copy-on-demand-not-for-environments">16.1.4. Pass-by-value, copy on demand: Not for environments</a></li>
<li><a class="reference internal" href="#a-note-on-reference-classes">16.1.5. A note on reference classes (**)</a></li>
</ul>
</li>
<li><a class="reference internal" href="#the-environment-model-of-evaluation">16.2. The environment model of evaluation</a><ul>
<li><a class="reference internal" href="#getting-the-current-environment-here-the-global-one">16.2.1. Getting the current environment (here: the global one)</a></li>
<li><a class="reference internal" href="#enclosures-enclosures-thereof-etc">16.2.2. Enclosures, enclosures thereof, etc.</a></li>
<li><a class="reference internal" href="#missing-names-are-sought-in-enclosing-environments">16.2.3. Missing names are sought in enclosing environments</a></li>
<li><a class="reference internal" href="#looking-for-functions">16.2.4. Looking for functions</a></li>
<li><a class="reference internal" href="#inspecting-the-search-path">16.2.5. Inspecting the search path</a></li>
<li><a class="reference internal" href="#attaching-and-detaching-from-the-search-path">16.2.6. Attaching and detaching from the search path</a></li>
<li><a class="reference internal" href="#masking-shadowing-objects-from-down-under">16.2.7. Masking (shadowing) objects from down under</a></li>
</ul>
</li>
<li><a class="reference internal" href="#evaluating-functions">16.3. 🚧 Evaluating functions</a><ul>
<li><a class="reference internal" href="#local-environment">16.3.1. Local environment</a></li>
<li><a class="reference internal" href="#lexical-scope-and-function-closures">16.3.2. Lexical scope and function closures</a></li>
<li><a class="reference internal" href="#application-function-factories">16.3.3. Application: Function factories</a></li>
<li><a class="reference internal" href="#accessing-the-calling-environment">16.3.4. Accessing the calling environment</a></li>
<li><a class="reference internal" href="#not-all-arguments-need-to-be-evaluated-immediately">16.3.5. 🚧 Not all arguments need to be evaluated (immediately)</a></li>
<li><a class="reference internal" href="#evaluation-of-default-arguments">16.3.6. 🚧 Evaluation of default arguments</a></li>
<li><a class="reference internal" href="#matching-of-argument-names">16.3.7. 🚧 Matching of argument names</a></li>
<li><a class="reference internal" href="#ellipsis-revisited">16.3.8. 🚧 Ellipsis revisited</a></li>
<li><a class="reference internal" href="#on-exit">16.3.9. <strong class="command">on.exit</strong></a></li>
<li><a class="reference internal" href="#example-functions-relying-on-metaprogramming">16.3.10. 🚧 Example functions relying on metaprogramming (**)</a></li>
<li><a class="reference internal" href="#processing-formulas">16.3.11. 🚧 Processing Formulas, `<strong class="command">~</strong>` (*)</a></li>
</ul>
</li>
<li><a class="reference internal" href="#other-concepts">16.4. 🚧 Other concepts</a><ul>
<li><a class="reference internal" href="#package-namespaces">16.4.1. 🚧 Package namespaces (*)</a></li>
<li><a class="reference internal" href="#s3-method-lookup-by-usemethod">16.4.2. 🚧 S3 method lookup by <strong class="command">UseMethod</strong></a></li>
<li><a class="reference internal" href="#overloading-s3-group-generics">16.4.3. 🚧 Overloading S3 group generics</a></li>
</ul>
</li>
<li><a class="reference internal" href="#exercises">16.5. Exercises</a></li>
<li><a class="reference internal" href="#outro">16.6. Outro</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/scripts/furo.js"></script>
    <script src="../_static/proof.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    </body>
</html>