<!doctype html>
<html class="no-js" lang="en">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />
<meta content="Deep R Programming" name="citation_title" />
<meta content="Marek Gagolewski" name="citation_author" />
<meta content="2023" name="citation_date" />
<meta content="2023" name="citation_publication_date" />
<meta content="https://deepr.gagolewski.com/deepr.pdf" name="citation_pdf_url" />
<meta content="https://deepr.gagolewski.com" name="citation_public_url" />
<meta content="10.5281/zenodo.7490464" name="citation_doi" />
<meta content="Deep R Programming is comprehensive course on one of the most popular languages in data science (statistical computing, graphics, machine learning, data wrangling and analytics). It introduces the base language in-depth and is aimed at ambitious students, practitioners, and researchers who would like to become independent users of this powerful environment. This textbook is a non-profit project. Its online and PDF versions are freely available at https://deepr.gagolewski.com/." name="citation_abstract" />
<meta content="summary" name="twitter:card" />
<meta content="Deep R Programming" name="twitter:title" />
<meta content="Deep R Programming" name="og:title" />
<meta content="Deep R Programming is comprehensive course on one of the most popular languages in data science (statistical computing, graphics, machine learning, data wrangling and analytics). It introduces the base language in-depth and is aimed at ambitious students, practitioners, and researchers who would like to become independent users of this powerful environment. This textbook is a non-profit project. Its online and PDF versions are freely available at https://deepr.gagolewski.com/." name="twitter:description" />
<meta content="Deep R Programming is comprehensive course on one of the most popular languages in data science (statistical computing, graphics, machine learning, data wrangling and analytics). It introduces the base language in-depth and is aimed at ambitious students, practitioners, and researchers who would like to become independent users of this powerful environment. This textbook is a non-profit project. Its online and PDF versions are freely available at https://deepr.gagolewski.com/." name="og:description" />
<meta content="gagolews/deepr" name="og:site_name" />
<meta content="https://deepr.gagolewski.com" name="og:url" />
<meta content="https://deepr.gagolewski.com/_images/cover.png" name="twitter:image" />
<meta content="https://deepr.gagolewski.com/_images/cover.png" name="og:image" />
<meta content="https://deepr.gagolewski.com" name="DC.identifier" />
<meta content="Marek Gagolewski" name="DC.publisher" />
<meta content="INDEX,FOLLOW" name="robots" />
<meta content="book" name="og:type" />
<meta content="9780645571929" name="og:book:isbn" />
<link rel="index" title="Index" href="../genindex.html" /><link rel="search" title="Search" href="../search.html" /><link rel="next" title="Changelog" href="998-changelog.html" /><link rel="prev" title="16. 🚧 Environments and evaluation (*)" href="330-environment.html" />
        <link rel="canonical" href="https://deepr.gagolewski.com/chapter/340-lazy.html" />

    <link rel="shortcut icon" href="../_static/favicon.png"/><!-- Generated with Sphinx 5.3.0 and Furo 2022.12.07 -->
        <title>17. 🚧 Lazy evaluation (**) - Deep R Programming</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?digest=91d0f0d1c444bdcb17a68e833c7a53903343c195" />
    <link rel="stylesheet" type="text/css" href="../_static/proof.css" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?digest=30d1aed668e5c3a91c3e3bf6a60b675221979f0e" />
    <link rel="stylesheet" type="text/css" href="../_static/css/custom.css" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  --admonition-font-size: 95%;
  --admonition-title-font-size: 95%;
  --color-brand-primary: red;
  --color-brand-content: #CC3333;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  --admonition-font-size: 95%;
  --admonition-title-font-size: 95%;
  --color-brand-primary: #ff2b53;
  --color-brand-content: #dd3333;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  --admonition-font-size: 95%;
  --admonition-title-font-size: 95%;
  --color-brand-primary: #ff2b53;
  --color-brand-content: #dd3333;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">Deep R Programming</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto colour theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky">

<span class="sidebar-brand-text">
<a class="sidebar-brand" href="../index.html">Deep R Programming</a>
</span>
<div class="sidebar-brand">
An open-access textbook<br />
by <a href='https://www.gagolewski.com' style="display: contents">Marek Gagolewski</a><br />
v0.1.14.9001 (draft)
</div>
<form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul>
<li class="toctree-l1"><a class="reference internal" href="../index.html">About</a></li>
<li class="toctree-l1"><a class="reference external" href="https://www.gagolewski.com/">Author</a></li>
<li class="toctree-l1"><a class="reference external" href="https://deepr.gagolewski.com/deepr.pdf">This Book in PDF</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/gagolews/deepr/">Report Bugs or Typos (GitHub)</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/gagolews/teaching-data">Datasets</a></li>
<li class="toctree-l1"><a class="reference external" href="https://datawranglingpy.gagolewski.com">Data Wrangling with Python</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Start Here</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="000-preface.html">Preface</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Deep</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="110-basics.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="120-numeric.html">2. Numeric vectors</a></li>
<li class="toctree-l1"><a class="reference internal" href="130-logical.html">3. Logical vectors</a></li>
<li class="toctree-l1"><a class="reference internal" href="140-list.html">4. Lists and attributes</a></li>
<li class="toctree-l1"><a class="reference internal" href="150-indexing.html">5. Vector indexing</a></li>
<li class="toctree-l1"><a class="reference internal" href="160-character.html">6. Character vectors</a></li>
<li class="toctree-l1"><a class="reference internal" href="170-function.html">7. Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="180-flow.html">8. Flow of execution</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Deeper</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="210-design.html">9. Designing functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="220-s3.html">10. S3 classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="230-matrix.html">11. Matrices and other arrays</a></li>
<li class="toctree-l1"><a class="reference internal" href="240-data-frame.html">12. Data frames</a></li>
<li class="toctree-l1"><a class="reference internal" href="250-graphics.html">13. 🚧🚧 Graphics</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Deepest</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="310-compiled.html">14. 🚧🚧 Interfacing compiled code (*)</a></li>
<li class="toctree-l1"><a class="reference internal" href="320-language.html">15. Unevaluated expressions (*)</a></li>
<li class="toctree-l1"><a class="reference internal" href="330-environment.html">16. 🚧 Environments and evaluation (*)</a></li>
<li class="toctree-l1 current current-page"><a class="current reference internal" href="#">17. 🚧 Lazy evaluation (**)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Appendix</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="998-changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="999-bibliography.html">References</a></li>
</ul>

</div></div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="edit-this-page">
  <a class="muted-link" href="https://github.com/gagolews/deepr/issues/" title="Edit this page">
    <svg aria-hidden="true" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <path d="M4 20h4l10.5 -10.5a1.5 1.5 0 0 0 -4 -4l-10.5 10.5v4" />
      <line x1="13.5" y1="6.5" x2="17.5" y2="10.5" />
    </svg>
    <span class="visually-hidden">Edit this page</span>
  </a>
</div><div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto colour theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <section class="tex2jax_ignore mathjax_ignore" id="lazy-evaluation">
<span id="chap-lazy"></span><h1><span class="section-number">17. </span>🚧 Lazy evaluation (**)<a class="headerlink" href="#lazy-evaluation" title="Permalink to this heading">#</a></h1>
<blockquote>
<div><p><em>The open-access textbook</em>
Deep R Programming <em>by <a class="reference external" href="https://www.gagolewski.com">Marek Gagolewski</a>
is, and will remain, freely available for everyone’s enjoyment
(also in <a class="reference external" href="https://deepr.gagolewski.com/deepr.pdf">PDF</a>).
It is a non-profit project.</em>
<strong>This book is still a work in progress. Beta versions
of Chapters 1–12 and 15–17 are already complete, but there will be more.
In the meantime, any
<a class="reference external" href="https://github.com/gagolews/deepr/issues">bug/typos reports/fixes</a>
are appreciated.</strong>
<em>Although available online, it is a whole course;
it should be read from the beginning to the end.
Refer to the <a class="reference internal" href="000-preface.html#chap-preface"><span class="std std-ref">Preface</span></a> for general introductory remarks.</em>
<em>Also, check out my other book,
<a class="reference external" href="https://datawranglingpy.gagolewski.com/"><em>Minimalist Data Wrangling with Python</em></a>
<span id="id1">[<a class="reference internal" href="999-bibliography.html#id3" title="Gagolewski, M. (2022).  Minimalist Data Wrangling with Python. Zenodo, Melbourne. URL: https://datawranglingpy.gagolewski.com/, DOI: 10.5281/zenodo.6451068.">25</a>]</span>.</em></p>
</div></blockquote>
<p>The ability to create, store, and manipulate unevaluated expressions
so that the can be computed later is not particularly special.
Many languages enjoy such <em>metaprogramming</em> (computing <em>on</em> the language,
reflection) capabilities, e.g., Lisp, Scheme, Wolfram, Julia,
amongst many others.</p>
<p>However, R inherited from its predecessor, the S language,
a variation of the idea of lazy<a class="footnote-reference brackets" href="#footnomemoisation" id="id2" role="doc-noteref"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></a>
(nonstrict, noneager, delayed)
evaluation of function arguments.
They are evaluated when their <em>values</em> are first needed.
As we can take the expressions used to generate them
(via <strong class="command">substitute</strong>; see <a class="reference internal" href="320-language.html#sec-substitute"><span class="std std-numref">Section 15.4.2</span></a>),
we shall see that we can ignore their meaning in the original (caller’s)
context and compute them in a custom one.</p>
<section id="evaluation-of-function-arguments">
<span id="sec-lazy-args"></span><h2><span class="section-number">17.1. </span>Evaluation of function arguments<a class="headerlink" href="#evaluation-of-function-arguments" title="Permalink to this heading">#</a></h2>
<p>We know that calls such as
`<strong class="command">if</strong>`<code class="code docutils literal notranslate"><span class="pre">(test,</span> <span class="pre">ifyes,</span> <span class="pre">ifno)</span></code>,
`<strong class="command">||</strong>`<code class="code docutils literal notranslate"><span class="pre">(mustbe,</span> <span class="pre">maybe)</span></code>,
or `<strong class="command">&amp;&amp;</strong>`<code class="code docutils literal notranslate"><span class="pre">(mustbe,</span> <span class="pre">maybe)</span></code>
do not have to evaluate all their arguments.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="nf">cat</span><span class="p">(</span><span class="s">&quot; first &quot;</span><span class="p">);</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">}</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">{</span><span class="nf">cat</span><span class="p">(</span><span class="s">&quot; second &quot;</span><span class="p">);</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">}</span>
<span class="c1">##  first</span>
<span class="c1">## [1] FALSE</span>
<span class="p">{</span><span class="nf">cat</span><span class="p">(</span><span class="s">&quot; first &quot;</span><span class="p">);</span><span class="w"> </span><span class="kc">TRUE</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">{</span><span class="nf">cat</span><span class="p">(</span><span class="s">&quot; Spanish Inquisition &quot;</span><span class="p">);</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">}</span>
<span class="c1">##  first  Spanish Inquisition</span>
<span class="c1">## [1] FALSE</span>
</pre></div>
</div>
<p>We can write such functions ourselves. For instance:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">test</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">function</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">)</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">c</span><span class="w">  </span><span class="c1"># b is unused</span>
<span class="nf">test</span><span class="p">({</span><span class="nf">cat</span><span class="p">(</span><span class="s">&quot;spam\n&quot;</span><span class="p">);</span><span class="w"> </span><span class="m">1</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="nf">cat</span><span class="p">(</span><span class="s">&quot;eggs\n&quot;</span><span class="p">);</span><span class="w"> </span><span class="m">10</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="nf">cat</span><span class="p">(</span><span class="s">&quot;salt\n&quot;</span><span class="p">);</span><span class="w"> </span><span class="m">100</span><span class="p">})</span>
<span class="c1">## spam</span>
<span class="c1">## salt</span>
<span class="c1">## [1] 101</span>
</pre></div>
</div>
<p>The second argument was not referred to in the function’s body.
Therefore, it was not evaluated.</p>
<div class="proof proof-type-example" id="id11">

    <div class="proof-title">
        <span class="proof-type">Example 17.1</span>
        
    </div><div class="proof-content">
<p>Study the following very carefully.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">test</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">function</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="nf">cat</span><span class="p">(</span><span class="s">&quot;Arguments passed to test (expressions): \n&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nf">cat</span><span class="p">(</span><span class="s">&quot;a = &quot;</span><span class="p">,</span><span class="w"> </span><span class="nf">deparse</span><span class="p">(</span><span class="nf">substitute</span><span class="p">(</span><span class="n">a</span><span class="p">)),</span><span class="w"> </span><span class="s">&quot;\n&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nf">cat</span><span class="p">(</span><span class="s">&quot;b = &quot;</span><span class="p">,</span><span class="w"> </span><span class="nf">deparse</span><span class="p">(</span><span class="nf">substitute</span><span class="p">(</span><span class="n">b</span><span class="p">)),</span><span class="w"> </span><span class="s">&quot;\n&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nf">cat</span><span class="p">(</span><span class="s">&quot;c = &quot;</span><span class="p">,</span><span class="w"> </span><span class="nf">deparse</span><span class="p">(</span><span class="nf">substitute</span><span class="p">(</span><span class="n">c</span><span class="p">)),</span><span class="w"> </span><span class="s">&quot;\n&quot;</span><span class="p">)</span>

<span class="w">    </span><span class="n">subtest</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="nf">cat</span><span class="p">(</span><span class="s">&quot;Arguments passed to subtest (expressions): \n&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="nf">cat</span><span class="p">(</span><span class="s">&quot;x = &quot;</span><span class="p">,</span><span class="w"> </span><span class="nf">deparse</span><span class="p">(</span><span class="nf">substitute</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span><span class="w"> </span><span class="s">&quot;\n&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="nf">cat</span><span class="p">(</span><span class="s">&quot;y = &quot;</span><span class="p">,</span><span class="w"> </span><span class="nf">deparse</span><span class="p">(</span><span class="nf">substitute</span><span class="p">(</span><span class="n">y</span><span class="p">)),</span><span class="w"> </span><span class="s">&quot;\n&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="nf">cat</span><span class="p">(</span><span class="s">&quot;z = &quot;</span><span class="p">,</span><span class="w"> </span><span class="nf">deparse</span><span class="p">(</span><span class="nf">substitute</span><span class="p">(</span><span class="n">z</span><span class="p">)),</span><span class="w"> </span><span class="s">&quot;\n&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="nf">cat</span><span class="p">(</span><span class="s">&quot;Using x(a) and z(c)... &quot;</span><span class="p">)</span>
<span class="w">        </span><span class="n">retval</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">z</span><span class="w">  </span><span class="c1"># evaluate a, c is reused, b is unused</span>
<span class="w">        </span><span class="nf">cat</span><span class="p">(</span><span class="s">&quot;Cheers!\n&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="n">retval</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nf">cat</span><span class="p">(</span><span class="s">&quot;Using c... &quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">c</span><span class="w">  </span><span class="c1"># evaluate; we do not even have to be particularly creative</span>

<span class="w">    </span><span class="nf">subtest</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="o">~!~</span><span class="n">b</span><span class="o">*</span><span class="m">2</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">headache</span><span class="w"> </span><span class="o">-&gt;&gt;</span><span class="w"> </span><span class="n">ha</span><span class="o">@</span><span class="n">x</span><span class="o">$</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="o">*</span><span class="m">10</span><span class="p">)</span><span class="w">  </span><span class="c1"># no evaluation yet!</span>
<span class="p">}</span>

<span class="nf">environment</span><span class="p">(</span><span class="n">test</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">new.env</span><span class="p">()</span><span class="w">  </span><span class="c1"># to spice things up</span>

<span class="nf">test</span><span class="p">(</span>
<span class="w">    </span><span class="p">{</span><span class="n">testx</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s">&quot;goulash&quot;</span><span class="p">;</span><span class="w"> </span><span class="nf">cat</span><span class="p">(</span><span class="s">&quot;spam\n&quot;</span><span class="p">);</span><span class="w"> </span><span class="m">1</span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span><span class="n">testy</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s">&quot;kabanos&quot;</span><span class="p">;</span><span class="w"> </span><span class="nf">cat</span><span class="p">(</span><span class="s">&quot;eggs\n&quot;</span><span class="p">);</span><span class="w"> </span><span class="nf">MeAn</span><span class="p">(</span><span class="n">egGs</span><span class="o">+</span><span class="n">whatever</span><span class="o">&amp;!!</span><span class="n">weird</span><span class="p">[</span><span class="n">stuff</span><span class="p">])},</span>
<span class="w">    </span><span class="p">{</span><span class="n">testx</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s">&quot;kransky&quot;</span><span class="p">;</span><span class="w"> </span><span class="nf">cat</span><span class="p">(</span><span class="s">&quot;salt\n&quot;</span><span class="p">);</span><span class="w"> </span><span class="m">100</span><span class="p">}</span>
<span class="p">)</span>
<span class="c1">## Arguments passed to test (expressions):</span>
<span class="c1">## a =  {     testx &lt;- &quot;goulash&quot;     cat(&quot;spam\n&quot;)     1 }</span>
<span class="c1">## b =  {     testy &lt;- &quot;kabanos&quot;     cat(&quot;eggs\n&quot;)     MeAn(egGs + whatever …</span>
<span class="c1">## c =  {     testx &lt;- &quot;kransky&quot;     cat(&quot;salt\n&quot;)     100 }</span>
<span class="c1">## Using c... salt</span>
<span class="c1">## Arguments passed to subtest (expressions):</span>
<span class="c1">## x =  a</span>
<span class="c1">## y =  `:=`(~!~b * 2, ha@x$y &lt;&lt;- headache)</span>
<span class="c1">## z =  c * 10</span>
<span class="c1">## Using x(a) and z(c)... spam</span>
<span class="c1">## Cheers!</span>
<span class="c1">## [1] 1001</span>
<span class="nf">print</span><span class="p">(</span><span class="n">testx</span><span class="p">)</span>
<span class="c1">## [1] &quot;goulash&quot;</span>
<span class="nf">print</span><span class="p">(</span><span class="n">testy</span><span class="p">)</span>
<span class="c1">## Error in print(testy): object &#39;testy&#39; not found</span>
</pre></div>
</div>
<p>On a side note, the `<strong class="command">~</strong>` (formula) operator will be discussed
in <a class="reference internal" href="#sec-formula"><span class="std std-numref">Section 17.6</span></a>.
Furthermore, the `<strong class="command">:=</strong>` operator was used
in an ancient version of R for assignments, but it is still recognised by
the parser, yet now it has no associated meaning.</p>
</div></div><div class="admonition important">
<p class="admonition-title">Important</p>
<p>We note what follows.</p>
<ul>
<li><p>Either the evaluation of an argument does not happen
or it is triggered only once (in which case the result is cached).</p></li>
<li><p>Evaluation is <em>delayed</em> until the very first request
for the underlying value (we call it <em>lazy evaluation</em>).</p></li>
<li><p>Evaluation takes place in the calling environment (parent frame).</p></li>
<li><p>Fetching the expression passed as an argument
using <strong class="command">substitute</strong> (<a class="reference internal" href="320-language.html#sec-substitute"><span class="std std-numref">Section 15.4.2</span></a>)
or checking if an argument was provided with
<strong class="command">missing</strong> (<a class="reference internal" href="320-language.html#sec-missing-arg"><span class="std std-numref">Section 15.4.3</span></a>)
does not trigger the evaluation.</p></li>
<li><p>Merely passing arguments further to another function <em>usually</em>
does not trigger the evaluation.</p>
<p>We wrote <em>usually</em>, because <code class="docutils literal notranslate"><span class="pre">builtin</span></code> functions
(e.g., <strong class="command">c</strong>, <strong class="command">list</strong>,
<strong class="command">sum</strong>, `<strong class="command">+</strong>`, `<strong class="command">&amp;</strong>`, and `<strong class="command">:</strong>`)
always evaluate the arguments.
There is no lazy evaluation in case
of the arguments passed to group generics;
see <strong class="command">help</strong><code class="code docutils literal notranslate"><span class="pre">(&quot;groupGeneric&quot;)</span></code> and <a class="reference internal" href="220-s3.html#sec-operator-overloading-s3"><span class="std std-numref">Section 10.2.6</span></a>.
Furthermore, replacement functions’ <code class="docutils literal notranslate"><span class="pre">values</span></code> arguments
(<a class="reference internal" href="210-design.html#sec-replacementfun"><span class="std std-numref">Section 9.4.6</span></a>) are computed eagerly.</p>
</li>
</ul>
</div>
<div class="proof proof-type-exercise" id="id12">

    <div class="proof-title">
        <span class="proof-type">Exercise 17.2</span>
        
    </div><div class="proof-content">
<p>Study the source code of <strong class="command">system.time</strong> and
note the use of delayed evaluation to measure the duration
of the execution of a given expression.
Also note the use of <strong class="command">on.exit</strong> (<a class="reference internal" href="#sec-on-exit"><span class="std std-numref">Section 17.4</span></a>)
to react to possible exceptions.</p>
</div></div><div class="proof proof-type-example" id="id13">

    <div class="proof-title">
        <span class="proof-type">Example 17.3</span>
        
    </div><div class="proof-content">
<p>It turns out that the role of <strong class="command">substitute</strong> is broader
than just getting the expression passed as an argument.
We can actually replace each occurrence of every name from
a given dictionary (a named list or an environment).</p>
<p>For instance:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">test</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">subtest</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">function</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">ex</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">substitute</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">env</span><span class="o">=</span><span class="nf">parent.frame</span><span class="p">())</span>
<span class="w">        </span><span class="n">ey</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">substitute</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<span class="w">        </span><span class="nf">cat</span><span class="p">(</span><span class="s">&quot;ex =&quot;</span><span class="p">,</span><span class="w"> </span><span class="nf">deparse</span><span class="p">(</span><span class="n">ex</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;\n&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="nf">cat</span><span class="p">(</span><span class="s">&quot;ey =&quot;</span><span class="p">,</span><span class="w"> </span><span class="nf">deparse</span><span class="p">(</span><span class="n">ey</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;\n&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="nf">eval</span><span class="p">(</span><span class="nf">as.call</span><span class="p">(</span><span class="nf">list</span><span class="p">(</span><span class="n">substitute</span><span class="p">,</span><span class="w"> </span><span class="n">ey</span><span class="p">,</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">ex</span><span class="p">))))</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nf">subtest</span><span class="p">(</span><span class="nf">spam</span><span class="p">(</span><span class="o">!</span><span class="n">x</span><span class="p">[</span><span class="n">x</span><span class="p">](</span><span class="n">x</span><span class="p">)))</span>
<span class="p">}</span>
<span class="nf">test</span><span class="p">(</span><span class="n">bacon</span><span class="o">@</span><span class="n">hovercraft</span><span class="p">)</span>
<span class="c1">## ex = bacon@hovercraft</span>
<span class="c1">## ey = spam(!x[x](x))</span>
<span class="c1">## spam(!bacon@hovercraft[bacon@hovercraft](bacon@hovercraft))</span>
</pre></div>
</div>
<p>This way, we could not only fetch the expression passed as the
`<code class="docutils literal notranslate"><span class="pre">x</span></code>` argument to the calling function, but also replace every occurrence
of `<code class="docutils literal notranslate"><span class="pre">x</span></code>` in the expression `<code class="docutils literal notranslate"><span class="pre">ey</span></code>`.</p>
<p>Note that <strong class="command">substitute</strong> does not evaluate
its first argument. Hence, if we called
<strong class="command">substitute</strong><code class="code docutils literal notranslate"><span class="pre">(ey,</span> <span class="pre">...)</span></code>, we would treat
`<code class="docutils literal notranslate"><span class="pre">ey</span></code>` as a quoted name.</p>
</div></div><div class="proof proof-type-exercise" id="id14">

    <div class="proof-title">
        <span class="proof-type">Exercise 17.4</span>
        
    </div><div class="proof-content">
<p>Study the source code of <strong class="command">replicate</strong>:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">replicate</span>
<span class="c1">## function (n, expr, simplify = &quot;array&quot;)</span>
<span class="c1">## sapply(integer(n), eval.parent(substitute(function(...) expr)),</span>
<span class="c1">##     simplify = simplify)</span>
<span class="c1">## &lt;environment: namespace:base&gt;</span>
</pre></div>
</div>
</div></div><div class="proof proof-type-exercise" id="id15">

    <div class="proof-title">
        <span class="proof-type">Exercise 17.5</span>
        
    </div><div class="proof-content">
<p>Implement your own version of the <strong class="command">bquote</strong> function.</p>
</div></div><div class="admonition note">
<p class="admonition-title">Note</p>
<p>(*)
Internally, lazy evaluation of arguments
is implemented using the so-called <em>promises</em>.
As such, they consist of (compare <span id="id3">[<a class="reference internal" href="999-bibliography.html#id10" title="R Development Core Team. (2023).  R Language Definition. URL: https://CRAN.R-project.org/doc/manuals/r-release/R-lang.html.">55</a>]</span>):</p>
<ul class="simple">
<li><p>an expression (which we can access by calling <strong class="command">substitute</strong>),</p></li>
<li><p>an environment where the expression is to be evaluated
(once this happens, it is set to <code class="docutils literal notranslate"><span class="pre">NULL</span></code>),</p></li>
<li><p>a cached value (computed on demand, once).</p></li>
</ul>
<p>This interface is not really visible
from within R, but see <strong class="command">help</strong><code class="code docutils literal notranslate"><span class="pre">(&quot;delayedAssign&quot;)</span></code>.</p>
</div>
<div class="proof proof-type-exercise" id="id16">

    <div class="proof-title">
        <span class="proof-type">Exercise 17.6</span>
        
    </div><div class="proof-content">
<p>Inspect the definition of <strong class="command">match.fun</strong>.
Why is it used by, e.g., <strong class="command">apply</strong>,
<strong class="command">Map</strong>, or <strong class="command">outer</strong>?</p>
<p>Note that it uses
<strong class="command">eval.parent</strong><code class="code docutils literal notranslate"><span class="pre">(</span></code><strong class="command">substitute</strong><code class="code docutils literal notranslate"><span class="pre">(</span></code><strong class="command">substitute</strong><code class="code docutils literal notranslate"><span class="pre">(FUN)))</span></code> to fetch the expression representing
the argument passed by the calling function (but it is probably
very rarely needed there).</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">test</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">subtest</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">function</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1"># NOT: substitute(y)</span>
<span class="w">        </span><span class="c1"># NOT: eval.parent(substitute(y))</span>
<span class="w">        </span><span class="nf">eval.parent</span><span class="p">(</span><span class="nf">substitute</span><span class="p">(</span><span class="nf">substitute</span><span class="p">(</span><span class="n">y</span><span class="p">)))</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nf">subtest</span><span class="p">(</span><span class="n">x</span><span class="m">+3</span><span class="p">)</span>
<span class="p">}</span>

<span class="nf">test</span><span class="p">(</span><span class="m">1</span><span class="o">*</span><span class="m">2</span><span class="p">)</span>
<span class="c1">## 1 * 2 + 3</span>
</pre></div>
</div>
</div></div></section>
<section id="evaluation-of-default-arguments">
<span id="sec-default-args-eval"></span><h2><span class="section-number">17.2. </span>Evaluation of default arguments<a class="headerlink" href="#evaluation-of-default-arguments" title="Permalink to this heading">#</a></h2>
<p>As we know from <a class="reference internal" href="210-design.html#sec-default-args"><span class="std std-numref">Section 9.5.4</span></a>, default arguments
are special expressions specified in a function’s parameter list.
When a function’s body requires the value of an argument
that was not provided by the caller, the default expression
will be evaluated <em>in the current (local) environment</em> of the function.
This is thus different than the case of normally passed arguments, which
are interpreted in the context of the calling environment.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">x</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s">&quot;banana\n&quot;</span>

<span class="n">test</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">function</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="p">{</span><span class="nf">cat</span><span class="p">(</span><span class="s">&quot;spam\n&quot;</span><span class="p">);</span><span class="w"> </span><span class="n">x</span><span class="p">})</span>
<span class="p">{</span>
<span class="w">    </span><span class="nf">cat</span><span class="p">(</span><span class="nf">deparse</span><span class="p">(</span><span class="nf">substitute</span><span class="p">(</span><span class="n">y</span><span class="p">)),</span><span class="w"> </span><span class="s">&quot;\n&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nf">cat</span><span class="p">(</span><span class="s">&quot;bacon\n&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s">&quot;rotten potatoes\n&quot;</span>
<span class="w">    </span><span class="nf">cat</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<span class="p">}</span>

<span class="nf">test</span><span class="p">()</span>
<span class="c1">## {     cat(&quot;spam\n&quot;)     x }</span>
<span class="c1">## bacon</span>
<span class="c1">## spam</span>
<span class="c1">## rotten potatoes</span>
<span class="nf">test</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="c1">## x</span>
<span class="c1">## bacon</span>
<span class="c1">## banana</span>
</pre></div>
</div>
<p>As usual, the evaluation is triggered only once,
where it is explicitly requested, and only when needed.</p>
<div class="proof proof-type-example" id="id17">

    <div class="proof-title">
        <span class="proof-type">Example 17.7</span>
        
    </div><div class="proof-content">
<p>Consider the following example from <span id="id4">[<a class="reference internal" href="999-bibliography.html#id17" title="Ihaka, R. and Gentleman, R. (1996).  R: A language for data analysis and graphics. Journal of Computational and Graphical Statistics, 5(3):299–314. URL: https://www.stat.auckland.ac.nz/~ihaka/downloads/R-paper.pdf, DOI: 10.1080/10618600.1996.10474713.">35</a>]</span>:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">sumsq</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">function</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">about</span><span class="o">=</span><span class="nf">mean</span><span class="p">(</span><span class="n">y</span><span class="p">),</span><span class="w"> </span><span class="n">na.rm</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="nf">if </span><span class="p">(</span><span class="n">na.rm</span><span class="p">)</span>
<span class="w">        </span><span class="n">y</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">y</span><span class="p">[</span><span class="o">!</span><span class="nf">is.na</span><span class="p">(</span><span class="n">y</span><span class="p">)]</span>
<span class="w">    </span><span class="nf">sum</span><span class="p">((</span><span class="n">y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">about</span><span class="p">)</span><span class="o">^</span><span class="m">2</span><span class="p">)</span>
<span class="p">}</span>

<span class="nf">sumsq</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="kc">NA_real_</span><span class="p">,</span><span class="w"> </span><span class="kc">NA_real_</span><span class="p">),</span><span class="w"> </span><span class="n">na.rm</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span>
<span class="c1">## [1] 0</span>
</pre></div>
</div>
<p>The nice side effect is that the computation of the mean
may take into account the removal of the missing values, if requested.</p>
<p>However, as the idea of lazy evaluation of arguments is alien
to most programmers (especially coming from different languages),
it might be better to rewrite the above using a call to <strong class="command">missing</strong>
(<a class="reference internal" href="320-language.html#sec-missing-arg"><span class="std std-numref">Section 15.4.3</span></a>):</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">sumsq</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">function</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">about</span><span class="p">,</span><span class="w"> </span><span class="n">na.rm</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="nf">if </span><span class="p">(</span><span class="n">na.rm</span><span class="p">)</span>
<span class="w">        </span><span class="n">y</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">y</span><span class="p">[</span><span class="o">!</span><span class="nf">is.na</span><span class="p">(</span><span class="n">y</span><span class="p">)]</span>
<span class="w">    </span><span class="nf">if </span><span class="p">(</span><span class="nf">missing</span><span class="p">(</span><span class="n">about</span><span class="p">))</span>
<span class="w">        </span><span class="n">about</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">mean</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="nf">sum</span><span class="p">((</span><span class="n">y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">about</span><span class="p">)</span><span class="o">^</span><span class="m">2</span><span class="p">)</span>
<span class="p">}</span>

<span class="nf">sumsq</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="kc">NA_real_</span><span class="p">,</span><span class="w"> </span><span class="kc">NA_real_</span><span class="p">),</span><span class="w"> </span><span class="n">na.rm</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span>
<span class="c1">## [1] 0</span>
</pre></div>
</div>
<p>or better even:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">sumsq</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">function</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">about</span><span class="o">=</span><span class="kc">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">na.rm</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="nf">if </span><span class="p">(</span><span class="n">na.rm</span><span class="p">)</span>
<span class="w">        </span><span class="n">y</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">y</span><span class="p">[</span><span class="o">!</span><span class="nf">is.na</span><span class="p">(</span><span class="n">y</span><span class="p">)]</span>
<span class="w">    </span><span class="nf">if </span><span class="p">(</span><span class="nf">is.null</span><span class="p">(</span><span class="n">about</span><span class="p">))</span>
<span class="w">        </span><span class="n">about</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">mean</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="nf">sum</span><span class="p">((</span><span class="n">y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">about</span><span class="p">)</span><span class="o">^</span><span class="m">2</span><span class="p">)</span>
<span class="p">}</span>

<span class="nf">sumsq</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="kc">NA_real_</span><span class="p">,</span><span class="w"> </span><span class="kc">NA_real_</span><span class="p">),</span><span class="w"> </span><span class="n">na.rm</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span>
<span class="c1">## [1] 0</span>
</pre></div>
</div>
</div></div><div class="proof proof-type-exercise" id="id18">

    <div class="proof-title">
        <span class="proof-type">Exercise 17.8</span>
        
    </div><div class="proof-content">
<p>Note that the default arguments to <strong class="command">do.call</strong>,
<strong class="command">list2env</strong>, and <strong class="command">new.env</strong>
are set to <strong class="command">parent.frame</strong>. What does that mean?</p>
</div></div><div class="proof proof-type-exercise" id="id19">

    <div class="proof-title">
        <span class="proof-type">Exercise 17.9</span>
        
    </div><div class="proof-content">
<p>Study the source code of the <strong class="command">local</strong> function:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">local</span>
<span class="c1">## function (expr, envir = new.env())</span>
<span class="c1">## eval.parent(substitute(eval(quote(expr), envir)))</span>
<span class="c1">## &lt;environment: namespace:base&gt;</span>
</pre></div>
</div>
</div></div></section>
<section id="ellipsis-revisited">
<span id="sec-ellipsis-eval"></span><h2><span class="section-number">17.3. </span>Ellipsis, `<code class="code docutils literal notranslate"><span class="pre">...</span></code>`,  revisited<a class="headerlink" href="#ellipsis-revisited" title="Permalink to this heading">#</a></h2>
<p>If our function features the dot-dot-dot parameter,
`<code class="code docutils literal notranslate"><span class="pre">...</span></code>`, whatever we pass through it
is packed into a pairlist of promise expressions. Thus, we can
enjoy the benefits of lazy evaluation.
In particular, we can redirect all `<code class="code docutils literal notranslate"><span class="pre">...</span></code>`-fed arguments
to another call, as-is.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">test</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">function</span><span class="p">(</span><span class="kc">...</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">subtest</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="kc">...</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="nf">cat</span><span class="p">(</span><span class="s">&quot;x   = &quot;</span><span class="p">);</span><span class="w"> </span><span class="nf">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="w">        </span><span class="nf">cat</span><span class="p">(</span><span class="s">&quot;... = &quot;</span><span class="p">);</span><span class="w"> </span><span class="nf">str</span><span class="p">(</span><span class="nf">list</span><span class="p">(</span><span class="kc">...</span><span class="p">))</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nf">subtest</span><span class="p">(</span><span class="kc">...</span><span class="p">)</span>
<span class="p">}</span>

<span class="nf">test</span><span class="p">({</span><span class="nf">cat</span><span class="p">(</span><span class="s">&quot;eggs! &quot;</span><span class="p">);</span><span class="w"> </span><span class="m">1</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="nf">cat</span><span class="p">(</span><span class="s">&quot;spam! &quot;</span><span class="p">);</span><span class="w"> </span><span class="m">2</span><span class="p">},</span><span class="w"> </span><span class="n">z</span><span class="o">=</span><span class="p">{</span><span class="nf">cat</span><span class="p">(</span><span class="s">&quot;rice! &quot;</span><span class="p">);</span><span class="w"> </span><span class="m">3</span><span class="p">})</span>
<span class="c1">## x   = eggs!  num 1</span>
<span class="c1">## ... = spam! rice! List of 2</span>
<span class="c1">##  $  : num 2</span>
<span class="c1">##  $ z: num 3</span>
</pre></div>
</div>
<div class="proof proof-type-exercise" id="id20">

    <div class="proof-title">
        <span class="proof-type">Exercise 17.10</span>
        
    </div><div class="proof-content">
<p>In <strong class="command">help</strong><code class="code docutils literal notranslate"><span class="pre">(&quot;lapply&quot;)</span></code>, we read that this function
is called like <strong class="command">lapply</strong><code class="code docutils literal notranslate"><span class="pre">(X,</span> <span class="pre">FUN,</span> <span class="pre">...)</span></code>,
where `<code class="code docutils literal notranslate"><span class="pre">...</span></code>` are <em>optional arguments to <code class="docutils literal notranslate"><span class="pre">FUN</span></code></em>.
Verify that whatever is passed via the ellipsis is evaluated
only once, and not on each application of <code class="docutils literal notranslate"><span class="pre">FUN</span></code> on the elements of <code class="docutils literal notranslate"><span class="pre">X</span></code>.</p>
</div></div><div class="proof proof-type-example" id="id21">

    <div class="proof-title">
        <span class="proof-type">Example 17.11</span>
        
    </div><div class="proof-content">
<p>We know from <a class="reference internal" href="250-graphics.html#chap-graphics"><span class="std std-numref">Chapter 13</span></a> that
many high-level graphical functions rely on multiple calls to
more primitive functions that allow for setting a variety of parameters
(e.g., via <strong class="command">par</strong>).
A quite common scenario is for the high-level function
to submit <em>all</em> the passed arguments to the underlying
basic routines, which then decide by themselves which items
they are interested in.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">test</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">function</span><span class="p">(</span><span class="kc">...</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">subtest1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">function</span><span class="p">(</span><span class="kc">...</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="o">=</span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="n">a</span><span class="p">)</span>
<span class="w">    </span><span class="n">subtest2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">function</span><span class="p">(</span><span class="kc">...</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="o">=</span><span class="m">2</span><span class="p">)</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">b</span><span class="o">=</span><span class="n">b</span><span class="p">)</span>
<span class="w">    </span><span class="n">subtest3</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">function</span><span class="p">(</span><span class="kc">...</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="o">=</span><span class="m">3</span><span class="p">)</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>

<span class="w">    </span><span class="nf">c</span><span class="p">(</span><span class="nf">subtest1</span><span class="p">(</span><span class="kc">...</span><span class="p">),</span><span class="w"> </span><span class="nf">subtest2</span><span class="p">(</span><span class="kc">...</span><span class="p">),</span><span class="w"> </span><span class="nf">subtest3</span><span class="p">(</span><span class="kc">...</span><span class="p">))</span>
<span class="p">}</span>

<span class="nf">test</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="s">&quot;A&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="o">=</span><span class="s">&quot;B&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="o">=</span><span class="s">&quot;D&quot;</span><span class="p">)</span>
<span class="c1">##   a   b   c</span>
<span class="c1">## &quot;A&quot; &quot;B&quot; &quot;3&quot;</span>
</pre></div>
</div>
<p>Here, for instance, <strong class="command">subtest1</strong> only consumes the value of <code class="docutils literal notranslate"><span class="pre">a</span></code>
and ignores all the other arguments whatsoever.
<strong class="command">plot.default</strong> (amongst others) relies on such a design pattern.</p>
</div></div><p><strong class="command">...length</strong> fetches the number of items
passed via the ellipsis, <strong class="command">...names</strong> retrieves their names
(in the case they are given as keyword arguments), and
<strong class="command">...elt(i)</strong> gives the <em>value</em> of the <em>i</em>-th element.
Furthermore, <code class="docutils literal notranslate"><span class="pre">..1</span></code>, <code class="docutils literal notranslate"><span class="pre">..2</span></code>, … are synonymous with
<strong class="command">...elt(1)</strong>, <strong class="command">...elt(2)</strong>, etc.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">test</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">function</span><span class="p">(</span><span class="kc">...</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="nf">cat</span><span class="p">(</span><span class="s">&quot;length:&quot;</span><span class="p">,</span><span class="w"> </span><span class="nf">...length</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;\n&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="nf">cat</span><span class="p">(</span><span class="s">&quot;names: &quot;</span><span class="p">,</span><span class="w"> </span><span class="nf">paste</span><span class="p">(</span><span class="nf">...names</span><span class="p">(),</span><span class="w"> </span><span class="n">collapse</span><span class="o">=</span><span class="s">&quot;, &quot;</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;\n&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="nf">for </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nf">seq_len</span><span class="p">(</span><span class="nf">...length</span><span class="p">()))</span>
<span class="w">        </span><span class="nf">cat</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;:&quot;</span><span class="p">,</span><span class="w"> </span><span class="nf">...elt</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;\n&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nf">print</span><span class="p">(</span><span class="nf">substitute</span><span class="p">(</span><span class="nf">...elt</span><span class="p">(</span><span class="n">i</span><span class="p">)))</span>
<span class="p">}</span>

<span class="nf">test</span><span class="p">(</span><span class="n">u</span><span class="o">=</span><span class="p">{</span><span class="nf">cat</span><span class="p">(</span><span class="s">&quot;honey! &quot;</span><span class="p">);</span><span class="w"> </span><span class="s">&quot;a&quot;</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="nf">cat</span><span class="p">(</span><span class="s">&quot;gravy! &quot;</span><span class="p">);</span><span class="w"> </span><span class="s">&quot;b&quot;</span><span class="p">},</span><span class="w"> </span><span class="n">w</span><span class="o">=</span><span class="p">{</span><span class="nf">cat</span><span class="p">(</span><span class="s">&quot;bacon! &quot;</span><span class="p">);</span><span class="w"> </span><span class="s">&quot;c&quot;</span><span class="p">})</span>
<span class="c1">## length: 3</span>
<span class="c1">## names:  u, , w</span>
<span class="c1">## honey! 1 : a</span>
<span class="c1">## gravy! 2 : b</span>
<span class="c1">## bacon! 3 : c</span>
<span class="c1">## ...elt(3L)</span>
</pre></div>
</div>
<p>Note that only <code class="docutils literal notranslate"><span class="pre">...elt(i)</span></code> triggers the evaluation of the respective
argument. Unfortunately, we cannot use <strong class="command">substitute</strong> to
fetch the underlying expression.
Instead, we can rely on <strong class="command">match.call</strong> discussed
in <a class="reference internal" href="320-language.html#sec-sys-call"><span class="std std-numref">Section 15.4.4</span></a>:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">test</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">function</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="kc">...</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="o">=</span><span class="m">1</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">e</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">match.call</span><span class="p">()[</span><span class="m">-1</span><span class="p">]</span>
<span class="w">    </span><span class="nf">as.list</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="o">!</span><span class="p">(</span><span class="nf">names</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="nf">names</span><span class="p">(</span><span class="nf">formals</span><span class="p">(</span><span class="nf">sys.function</span><span class="p">())))])</span>
<span class="p">}</span>

<span class="nf">str</span><span class="p">(</span><span class="nf">test</span><span class="p">(</span><span class="m">1+1</span><span class="p">,</span><span class="w"> </span><span class="m">2+2</span><span class="p">,</span><span class="w"> </span><span class="m">3+3</span><span class="p">,</span><span class="w"> </span><span class="m">4+4</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="o">=</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="o">=</span><span class="m">8</span><span class="p">,</span><span class="w"> </span><span class="n">w</span><span class="o">=</span><span class="m">4</span><span class="p">))</span>
<span class="c1">## List of 4</span>
<span class="c1">##  $  : language 2 + 2</span>
<span class="c1">##  $  : language 3 + 3</span>
<span class="c1">##  $  : language 4 + 4</span>
<span class="c1">##  $ w: num 4</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>(*) Objects passed via `<code class="code docutils literal notranslate"><span class="pre">...</span></code>`, even if they are specified as
keyword arguments, cannot be referred to by their name,
as if they were local variables:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">test</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">function</span><span class="p">(</span><span class="kc">...</span><span class="p">)</span><span class="w"> </span><span class="n">zzz</span>
<span class="nf">test</span><span class="p">(</span><span class="n">zzz</span><span class="o">=</span><span class="m">3</span><span class="p">)</span>
<span class="c1">## Error in test(zzz = 3): object &#39;zzz&#39; not found</span>
</pre></div>
</div>
<p>In other words, no assignment in the local environment is triggered.</p>
</div>
<div class="proof proof-type-exercise" id="id22">

    <div class="proof-title">
        <span class="proof-type">Exercise 17.12</span>
        
    </div><div class="proof-content">
<p>Implement your own version of the built-in <strong class="command">switch</strong> function.</p>
</div></div><div class="proof proof-type-exercise" id="id23">

    <div class="proof-title">
        <span class="proof-type">Exercise 17.13</span>
        
    </div><div class="proof-content">
<p>Implement your own version of the <strong class="command">stopifnot</strong> function.</p>
</div></div></section>
<section id="on-exit">
<span id="sec-on-exit"></span><h2><span class="section-number">17.4. </span><strong class="command">on.exit</strong> (*)<a class="headerlink" href="#on-exit" title="Permalink to this heading">#</a></h2>
<p><strong class="command">on.exit</strong> registers an expression to be evaluated
at the very end of a function call, regardless whether
it exited due to an error or not.
It might be used to
re-set the temporarily modified graphical parameters (see <strong class="command">par</strong>)
and system options (<strong class="command">options</strong>),
or clean up the allocated resources (e.g., closing open files).</p>
<p>For instance:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">test</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">function</span><span class="p">(</span><span class="n">reset</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="nf">on.exit</span><span class="p">(</span><span class="nf">print</span><span class="p">(</span><span class="s">&quot;eggs&quot;</span><span class="p">))</span>
<span class="w">    </span><span class="nf">on.exit</span><span class="p">(</span><span class="nf">print</span><span class="p">(</span><span class="s">&quot;bacon&quot;</span><span class="p">))</span><span class="w">  </span><span class="c1"># replace</span>
<span class="w">    </span><span class="nf">on.exit</span><span class="p">(</span><span class="nf">print</span><span class="p">(</span><span class="s">&quot;spam&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">add</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span><span class="w">  </span><span class="c1"># add</span>

<span class="w">    </span><span class="nf">print</span><span class="p">(</span><span class="s">&quot;roti canai&quot;</span><span class="p">)</span>

<span class="w">    </span><span class="nf">if </span><span class="p">(</span><span class="n">reset</span><span class="p">)</span>
<span class="w">        </span><span class="nf">on.exit</span><span class="p">()</span><span class="w">  </span><span class="c1"># cancels all (replace by nothing)</span>

<span class="w">    </span><span class="s">&quot;end.&quot;</span><span class="w">  </span><span class="c1"># return value</span>
<span class="p">}</span>

<span class="n">x</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">test</span><span class="p">()</span>
<span class="c1">## [1] &quot;roti canai&quot;</span>
<span class="c1">## [1] &quot;bacon&quot;</span>
<span class="c1">## [1] &quot;spam&quot;</span>
<span class="nf">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="c1">## [1] &quot;end.&quot;</span>
<span class="n">x</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">test</span><span class="p">(</span><span class="kc">TRUE</span><span class="p">)</span>
<span class="c1">## [1] &quot;roti canai&quot;</span>
<span class="nf">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="c1">## [1] &quot;end.&quot;</span>
</pre></div>
</div>
<p>Note that we can always do without <strong class="command">on.exit</strong>,
e.g., by applying proper exception handling techniques;
<a class="reference internal" href="180-flow.html#sec-exceptions"><span class="std std-numref">Section 8.2</span></a>.</p>
<div class="proof proof-type-exercise" id="id24">

    <div class="proof-title">
        <span class="proof-type">Exercise 17.14</span>
        
    </div><div class="proof-content">
<p>Note the call to:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">on.exit</span><span class="p">(</span><span class="nf">close</span><span class="p">(</span><span class="n">file</span><span class="p">))</span>
</pre></div>
</div>
<p>in the definition of <strong class="command">scan</strong>.
What is its purpose?</p>
</div></div><div class="proof proof-type-exercise" id="id25">

    <div class="proof-title">
        <span class="proof-type">Exercise 17.15</span>
        
    </div><div class="proof-content">
<p>Why does <strong class="command">graphics::barplot.default</strong> call the following
expressions?</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">dev.hold</span><span class="p">()</span>
<span class="n">opar</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">if </span><span class="p">(</span><span class="n">horiz</span><span class="p">)</span><span class="w"> </span><span class="nf">par</span><span class="p">(</span><span class="n">xaxs</span><span class="o">=</span><span class="s">&quot;i&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">xpd</span><span class="o">=</span><span class="n">xpd</span><span class="p">)</span><span class="w"> </span><span class="n">else</span><span class="w"> </span><span class="nf">par</span><span class="p">(</span><span class="n">yaxs</span><span class="o">=</span><span class="s">&quot;i&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">xpd</span><span class="o">=</span><span class="n">xpd</span><span class="p">)</span>
<span class="nf">on.exit</span><span class="p">({</span>
<span class="w">    </span><span class="nf">dev.flush</span><span class="p">()</span>
<span class="w">    </span><span class="nf">par</span><span class="p">(</span><span class="n">opar</span><span class="p">)</span>
<span class="p">})</span>
</pre></div>
</div>
</div></div></section>
<section id="metaprogramming-in-action-examples">
<span id="sec-metaprogramming-implement"></span><h2><span class="section-number">17.5. </span>Metaprogramming in action: Examples (*)<a class="headerlink" href="#metaprogramming-in-action-examples" title="Permalink to this heading">#</a></h2>
<p>As we mentioned at the beginning of the previous chapter
and in <a class="reference internal" href="210-design.html#sec-metaprogramming-intro"><span class="std std-numref">Section 9.5.7</span></a>
and <a class="reference internal" href="240-data-frame.html#sec-metaprogramming-df"><span class="std std-numref">Section 12.3.9</span></a>,
due to lazy evaluation, we can define functions that allow
arbitrary gibberish as their arguments,
as long as they are syntactically valid R expressions.
Nothing but basic decency stops us from interpreting them in
any way we want. Each such function can become a microverse
(a microlanguage?) by itself. This might confuse<a class="footnote-reference brackets" href="#footconfuse" id="id5" role="doc-noteref"><span class="fn-bracket">[</span>2<span class="fn-bracket">]</span></a> our users,
as they will have to study its behaviour separately.</p>
<p>In this section, we will take a look at a few builtin functions relying
on metaprogramming, mostly because that studying them is a good exercise
that help extend our programming skills and deepen our understanding
of the underlying concepts.</p>
<p>By no means it is an invite to use them in practice.</p>
<p>Still, R’s computing on the language capabilities
might be of interest to some advanced programmers (e.g., package
developers).</p>
<section id="match-arg">
<h3><span class="section-number">17.5.1. </span><strong class="command">match.arg</strong><a class="headerlink" href="#match-arg" title="Permalink to this heading">#</a></h3>
<p>We mentioned <strong class="command">match.arg</strong> in <a class="reference internal" href="210-design.html#sec-metaprogramming-intro"><span class="std std-numref">Section 9.5.7</span></a>.
When called normally, it matches a string against a set of possible
choices, similarly to <strong class="command">pmatch</strong>:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">choices</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;spam&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;bacon&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;eggs&quot;</span><span class="p">)</span>
<span class="nf">match.arg</span><span class="p">(</span><span class="s">&quot;spam&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">choices</span><span class="p">)</span>
<span class="c1">## [1] &quot;spam&quot;</span>
<span class="nf">match.arg</span><span class="p">(</span><span class="s">&quot;s&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">choices</span><span class="p">)</span><span class="w">  </span><span class="c1"># partial matching</span>
<span class="c1">## [1] &quot;spam&quot;</span>
<span class="nf">match.arg</span><span class="p">(</span><span class="s">&quot;eggplant&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">choices</span><span class="p">)</span><span class="w">  </span><span class="c1"># no match</span>
<span class="c1">## Error in match.arg(&quot;eggplant&quot;, choices): &#39;arg&#39; should be one of &quot;spam&quot;,</span>
<span class="c1">##     &quot;bacon&quot;, &quot;eggs&quot;</span>
<span class="nf">match.arg</span><span class="p">(</span><span class="n">choices</span><span class="p">,</span><span class="w"> </span><span class="n">choices</span><span class="p">)</span><span class="w">  </span><span class="c1"># match first</span>
<span class="c1">## [1] &quot;spam&quot;</span>
</pre></div>
</div>
<p>However, skipping the second argument,
this function will fetch the choices from the default argument
of the function it is enclosed in!</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">test</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">function</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;spam&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;bacon&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;eggs&quot;</span><span class="p">))</span>
<span class="w">    </span><span class="nf">match.arg</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="nf">test</span><span class="p">(</span><span class="s">&quot;spam&quot;</span><span class="p">)</span>
<span class="c1">## [1] &quot;spam&quot;</span>
<span class="nf">test</span><span class="p">(</span><span class="s">&quot;s&quot;</span><span class="p">)</span>
<span class="c1">## [1] &quot;spam&quot;</span>
<span class="nf">test</span><span class="p">(</span><span class="s">&quot;eggplant&quot;</span><span class="p">)</span>
<span class="c1">## Error in match.arg(x): &#39;arg&#39; should be one of &quot;spam&quot;, &quot;bacon&quot;, &quot;eggs&quot;</span>
<span class="nf">test</span><span class="p">()</span>
<span class="c1">## [1] &quot;spam&quot;</span>
</pre></div>
</div>
<div class="proof proof-type-exercise" id="id26">

    <div class="proof-title">
        <span class="proof-type">Exercise 17.16</span>
        
    </div><div class="proof-content">
<p>Inspect the source code and the documentation of
<strong class="command">stats::binom.test</strong>, which looks like:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">function</span><span class="p">(</span><span class="kc">...</span><span class="p">,</span><span class="w"> </span><span class="n">alternative</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;two.sided&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;less&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;greater&quot;</span><span class="p">))</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1"># ...</span>
<span class="w">    </span><span class="n">alternative</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">match.arg</span><span class="p">(</span><span class="n">alternative</span><span class="p">)</span>
<span class="w">    </span><span class="c1"># ...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Note the <code class="docutils literal notranslate"><span class="pre">alternative</span></code> argument and its peculiar default value.</p>
</div></div><div class="proof proof-type-exercise" id="id27">

    <div class="proof-title">
        <span class="proof-type">Exercise 17.17</span>
        
    </div><div class="proof-content">
<p>Study the source code of <strong class="command">match.arg</strong>.
In particular, note the following fragment:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">if </span><span class="p">(</span><span class="nf">missing</span><span class="p">(</span><span class="n">choices</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">formal.args</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">formals</span><span class="p">(</span><span class="nf">sys.function</span><span class="p">(</span><span class="n">sysP</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">sys.parent</span><span class="p">()))</span>
<span class="w">    </span><span class="n">choices</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">eval</span><span class="p">(</span>
<span class="w">        </span><span class="n">formal.args</span><span class="p">[[</span><span class="nf">as.character</span><span class="p">(</span><span class="nf">substitute</span><span class="p">(</span><span class="n">arg</span><span class="p">))]],</span>
<span class="w">        </span><span class="n">envir</span><span class="o">=</span><span class="nf">sys.frame</span><span class="p">(</span><span class="n">sysP</span><span class="p">)</span>
<span class="w">    </span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</div></div></section>
<section id="curve">
<h3><span class="section-number">17.5.2. </span><strong class="command">curve</strong><a class="headerlink" href="#curve" title="Permalink to this heading">#</a></h3>
<p>The <strong class="command">curve</strong> function can be called like:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">curve</span><span class="p">(</span><span class="nf">sin</span><span class="p">(</span><span class="m">1</span><span class="o">/</span><span class="n">x</span><span class="o">^</span><span class="m">2</span><span class="p">),</span><span class="w"> </span><span class="m">1</span><span class="o">/</span><span class="kc">pi</span><span class="p">,</span><span class="w"> </span><span class="m">3</span><span class="p">,</span><span class="w"> </span><span class="m">1001</span><span class="p">,</span><span class="w"> </span><span class="n">lty</span><span class="o">=</span><span class="m">2</span><span class="p">)</span>
</pre></div>
</div>
<figure class="align-default" id="id28">
<span id="fig-curve-plot"></span><img alt="../_images/curve-plot-1.png" src="../_images/curve-plot-1.png" />
<figcaption>
<p><span class="caption-number">Figure 17.1 </span><span class="caption-text">An example plot generated by calling <strong class="command">curve</strong></span><a class="headerlink" href="#id28" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<p>which results in <a class="reference internal" href="#fig-curve-plot"><span class="std std-numref">Figure 17.1</span></a>.</p>
<div class="proof proof-type-exercise" id="id29">

    <div class="proof-title">
        <span class="proof-type">Exercise 17.18</span>
        
    </div><div class="proof-content">
<p>Study the source code of <strong class="command">curve</strong>.
Note the following fragment of its definition:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">function</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span><span class="w"> </span><span class="n">from</span><span class="o">=</span><span class="kc">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">to</span><span class="o">=</span><span class="kc">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="o">=</span><span class="m">101</span><span class="p">,</span><span class="w"> </span><span class="n">xlab</span><span class="o">=</span><span class="s">&quot;x&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="o">=</span><span class="s">&quot;l&quot;</span><span class="p">,</span><span class="w"> </span><span class="kc">...</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1"># ...</span>
<span class="w">    </span><span class="n">expr</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">substitute</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
<span class="w">    </span><span class="n">ylab</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">deparse</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
<span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">seq.int</span><span class="p">(</span><span class="n">from</span><span class="p">,</span><span class="w"> </span><span class="n">to</span><span class="p">,</span><span class="w"> </span><span class="n">length.out</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
<span class="w">    </span><span class="n">ll</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>
<span class="w">    </span><span class="n">y</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">eval</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span><span class="w"> </span><span class="n">envir</span><span class="o">=</span><span class="n">ll</span><span class="p">,</span><span class="w"> </span><span class="n">enclos</span><span class="o">=</span><span class="nf">parent.frame</span><span class="p">())</span>
<span class="w">    </span><span class="nf">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="o">=</span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">xlab</span><span class="o">=</span><span class="n">xlab</span><span class="p">,</span><span class="w"> </span><span class="n">ylab</span><span class="o">=</span><span class="n">ylab</span><span class="p">,</span><span class="w"> </span><span class="kc">...</span><span class="p">)</span>
<span class="w">    </span><span class="c1"># ...</span>
<span class="p">}</span>
</pre></div>
</div>
</div></div></section>
<section id="with-and-within">
<h3><span class="section-number">17.5.3. </span><strong class="command">with</strong> and <strong class="command">within</strong><a class="headerlink" href="#with-and-within" title="Permalink to this heading">#</a></h3>
<p>Environments and named lists (and hence data frames)
are similar (<a class="reference internal" href="330-environment.html#sec-env-vs-list"><span class="std std-numref">Section 16.1.2</span></a>).
Due to this, the <code class="docutils literal notranslate"><span class="pre">envir</span></code> argument to <strong class="command">eval</strong> can be set to either.</p>
<p>Therefore, for instance:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">eval</span><span class="p">(</span><span class="nf">quote</span><span class="p">(</span><span class="nf">head</span><span class="p">(</span><span class="n">Sepal.Length</span><span class="p">)),</span><span class="w"> </span><span class="n">envir</span><span class="o">=</span><span class="n">iris</span><span class="p">)</span>
<span class="c1">## [1] 5.1 4.9 4.7 4.6 5.0 5.4</span>
</pre></div>
</div>
<p>evaluates the given expression in something like
<strong class="command">list2env</strong><code class="code docutils literal notranslate"><span class="pre">(iris,</span> <span class="pre">parent=</span></code><strong class="command">parent.frame</strong><code class="code docutils literal notranslate"><span class="pre">())</span></code>.
Thus, even though <code class="docutils literal notranslate"><span class="pre">Sepal.Length</span></code> is not a standalone variable,
it is treated as if it was one <em>inside</em> the <code class="docutils literal notranslate"><span class="pre">iris</span></code> data frame.</p>
<p>Note that thanks to the enclosure’s being set to the calling frame,
we can successfully refer to the <strong class="command">head</strong> function
somewhere from the search path.
This is somewhat similar to <strong class="command">attach</strong> (<a class="reference internal" href="330-environment.html#sec-attach"><span class="std std-numref">Section 16.2.6</span></a>),
but without modifying the search path.</p>
<p>The <strong class="command">with</strong> function does exactly the above:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">print</span><span class="p">(</span><span class="n">with.default</span><span class="p">)</span>
<span class="c1">## function (data, expr, ...)</span>
<span class="c1">## eval(substitute(expr), data, enclos = parent.frame())</span>
<span class="c1">## &lt;environment: namespace:base&gt;</span>
</pre></div>
</div>
<p>Example use:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">with</span><span class="p">(</span><span class="n">iris</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">Sepal.Length</span><span class="w">  </span><span class="c1"># `Sepal.Length` is in `iris`</span>
<span class="w">    </span><span class="nf">mean</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="p">})</span>
<span class="c1">## [1] 5.8433</span>
</pre></div>
</div>
<p>As we evaluate the above in the local (temporary) environment,
we cannot modify the existing columns of the data frame this way.
But then the <strong class="command">within</strong> function includes a way to detect
and reflect any changes made.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">within</span><span class="p">(</span><span class="n">iris</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Sepal.Length</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">Sepal.Length</span><span class="o">/</span><span class="m">1000</span>
<span class="w">    </span><span class="n">Spam</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s">&quot;yum!&quot;</span>
<span class="p">})</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">iris2</span>
<span class="nf">head</span><span class="p">(</span><span class="n">iris2</span><span class="p">,</span><span class="w"> </span><span class="m">3</span><span class="p">)</span>
<span class="c1">##   Sepal.Length Sepal.Width Petal.Length Petal.Width Species Spam</span>
<span class="c1">## 1       0.0051         3.5          1.4         0.2  setosa yum!</span>
<span class="c1">## 2       0.0049         3.0          1.4         0.2  setosa yum!</span>
<span class="c1">## 3       0.0047         3.2          1.3         0.2  setosa yum!</span>
</pre></div>
</div>
<div class="proof proof-type-exercise" id="id30">

    <div class="proof-title">
        <span class="proof-type">Exercise 17.19</span>
        
    </div><div class="proof-content">
<p>Study the source code of <strong class="command">within</strong>:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">print</span><span class="p">(</span><span class="n">within.data.frame</span><span class="p">)</span>
<span class="c1">## function (data, expr, ...)</span>
<span class="c1">## {</span>
<span class="c1">##     parent &lt;- parent.frame()</span>
<span class="c1">##     e &lt;- evalq(environment(), data, parent)</span>
<span class="c1">##     eval(substitute(expr), e)</span>
<span class="c1">##     l &lt;- as.list(e, all.names = TRUE)</span>
<span class="c1">##     l &lt;- l[!vapply(l, is.null, NA, USE.NAMES = FALSE)]</span>
<span class="c1">##     nl &lt;- names(l)</span>
<span class="c1">##     del &lt;- setdiff(names(data), nl)</span>
<span class="c1">##     data[nl] &lt;- l</span>
<span class="c1">##     data[del] &lt;- NULL</span>
<span class="c1">##     data</span>
<span class="c1">## }</span>
<span class="c1">## &lt;environment: namespace:base&gt;</span>
</pre></div>
</div>
<p>Note that <strong class="command">evalq</strong><code class="code docutils literal notranslate"><span class="pre">(expr,</span> <span class="pre">...)</span></code> is equivalent to
<strong class="command">eval</strong><code class="code docutils literal notranslate"><span class="pre">(</span></code><strong class="command">quote</strong><code class="code docutils literal notranslate"><span class="pre">(expr),</span> <span class="pre">...)</span></code>,
and that <strong class="command">vapply</strong><code class="code docutils literal notranslate"><span class="pre">(X,</span> <span class="pre">FUN,</span> <span class="pre">NA,</span> <span class="pre">...)</span></code>
is like a call to <strong class="command">sapply</strong>, but it guarantees
that the result is a logical vector.</p>
</div></div></section>
<section id="transform">
<h3><span class="section-number">17.5.4. </span><strong class="command">transform</strong><a class="headerlink" href="#transform" title="Permalink to this heading">#</a></h3>
<p>We can call <strong class="command">transform</strong> to modify/add columns
in a data frame using vectorised functions, for instance:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">head</span><span class="p">(</span><span class="nf">transform</span><span class="p">(</span><span class="n">mtcars</span><span class="p">,</span><span class="w"> </span><span class="n">log_hp</span><span class="o">=</span><span class="nf">log</span><span class="p">(</span><span class="n">hp</span><span class="p">),</span><span class="w"> </span><span class="n">am</span><span class="o">=</span><span class="m">2</span><span class="o">*</span><span class="n">am</span><span class="m">-1</span><span class="p">,</span><span class="w"> </span><span class="n">hp</span><span class="o">=</span><span class="kc">NULL</span><span class="p">),</span><span class="w"> </span><span class="m">3</span><span class="p">)</span>
<span class="c1">##                mpg cyl disp drat    wt  qsec vs am gear carb log_hp</span>
<span class="c1">## Mazda RX4     21.0   6  160 3.90 2.620 16.46  0  1    4    4 4.7005</span>
<span class="c1">## Mazda RX4 Wag 21.0   6  160 3.90 2.875 17.02  0  1    4    4 4.7005</span>
<span class="c1">## Datsun 710    22.8   4  108 3.85 2.320 18.61  1  1    4    1 4.5326</span>
</pre></div>
</div>
<p>If we suspect that this function evaluates
all expressions passed as `<code class="docutils literal notranslate"><span class="pre">...</span></code>` in <em>within</em> the data frame,
we are obviously right.
Furthermore, there must be some mechanism allowing for the detection
of newly created variables so that new columns can be added.</p>
<div class="proof proof-type-exercise" id="id31">

    <div class="proof-title">
        <span class="proof-type">Exercise 17.20</span>
        
    </div><div class="proof-content">
<p>Study the source code of <strong class="command">transform</strong>:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">print</span><span class="p">(</span><span class="n">transform.data.frame</span><span class="p">)</span>
<span class="c1">## function (`_data`, ...)</span>
<span class="c1">## {</span>
<span class="c1">##     e &lt;- eval(substitute(list(...)), `_data`, parent.frame())</span>
<span class="c1">##     tags &lt;- names(e)</span>
<span class="c1">##     inx &lt;- match(tags, names(`_data`))</span>
<span class="c1">##     matched &lt;- !is.na(inx)</span>
<span class="c1">##     if (any(matched)) {</span>
<span class="c1">##         `_data`[inx[matched]] &lt;- e[matched]</span>
<span class="c1">##         `_data` &lt;- data.frame(`_data`)</span>
<span class="c1">##     }</span>
<span class="c1">##     if (!all(matched))</span>
<span class="c1">##         do.call(&quot;data.frame&quot;, c(list(`_data`), e[!matched]))</span>
<span class="c1">##     else `_data`</span>
<span class="c1">## }</span>
<span class="c1">## &lt;environment: namespace:base&gt;</span>
</pre></div>
</div>
<p>In particular, note that `<code class="docutils literal notranslate"><span class="pre">e</span></code>` is a named list.</p>
</div></div></section>
<section id="subset">
<h3><span class="section-number">17.5.5. </span><strong class="command">subset</strong><a class="headerlink" href="#subset" title="Permalink to this heading">#</a></h3>
<p>The <strong class="command">subset</strong> function can be used to select rows and columns
of a data frame that meet certain criteria. For instance:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">subset</span><span class="p">(</span><span class="n">airquality</span><span class="p">,</span><span class="w"> </span><span class="n">Temp</span><span class="o">&gt;</span><span class="m">95</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Temp</span><span class="o">&lt;</span><span class="m">57</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="p">(</span><span class="n">Month</span><span class="o">:</span><span class="n">Day</span><span class="p">))</span>
<span class="c1">##     Ozone Solar.R Wind Temp</span>
<span class="c1">## 5      NA      NA 14.3   56</span>
<span class="c1">## 120    76     203  9.7   97</span>
<span class="c1">## 122    84     237  6.3   96</span>
</pre></div>
</div>
<p>The second argument, the row selector, must definitely
be evaluated <em>within</em> the data frame. We expect it to reduce
to a logical vector which then can be passed to the index operator.</p>
<p>The “select all columns except those between the given ones”
part can be implemented by assigning each column a consecutive
integer, and then treating them as numeric indexes.</p>
<div class="proof proof-type-exercise" id="id32">

    <div class="proof-title">
        <span class="proof-type">Exercise 17.21</span>
        
    </div><div class="proof-content">
<p>Study the source code of <strong class="command">subset</strong>:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">print</span><span class="p">(</span><span class="n">subset.data.frame</span><span class="p">)</span>
<span class="c1">## function (x, subset, select, drop = FALSE, ...)</span>
<span class="c1">## {</span>
<span class="c1">##     r &lt;- if (missing(subset))</span>
<span class="c1">##         rep_len(TRUE, nrow(x))</span>
<span class="c1">##     else {</span>
<span class="c1">##         e &lt;- substitute(subset)</span>
<span class="c1">##         r &lt;- eval(e, x, parent.frame())</span>
<span class="c1">##         if (!is.logical(r))</span>
<span class="c1">##             stop(&quot;&#39;subset&#39; must be logical&quot;)</span>
<span class="c1">##         r &amp; !is.na(r)</span>
<span class="c1">##     }</span>
<span class="c1">##     vars &lt;- if (missing(select))</span>
<span class="c1">##         rep_len(TRUE, ncol(x))</span>
<span class="c1">##     else {</span>
<span class="c1">##         nl &lt;- as.list(seq_along(x))</span>
<span class="c1">##         names(nl) &lt;- names(x)</span>
<span class="c1">##         eval(substitute(select), nl, parent.frame())</span>
<span class="c1">##     }</span>
<span class="c1">##     x[r, vars, drop = drop]</span>
<span class="c1">## }</span>
<span class="c1">## &lt;environment: namespace:base&gt;</span>
</pre></div>
</div>
</div></div></section>
<section id="a-forward-pipe-operator">
<h3><span class="section-number">17.5.6. </span>A forward-pipe operator<a class="headerlink" href="#a-forward-pipe-operator" title="Permalink to this heading">#</a></h3>
<p>In <a class="reference internal" href="220-s3.html#sec-pipe"><span class="std std-numref">Section 10.5</span></a>, we mentioned the pipe operator,
`<code class="docutils literal notranslate"><span class="pre">|&gt;</span></code>`. We can quite easily implement its simplified version manually:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">`%&gt;%`</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">function</span><span class="p">(</span><span class="n">e1</span><span class="p">,</span><span class="w"> </span><span class="n">e2</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">e2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.list</span><span class="p">(</span><span class="nf">substitute</span><span class="p">(</span><span class="n">e2</span><span class="p">))</span>
<span class="w">    </span><span class="n">e2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.call</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="n">e2</span><span class="p">[[</span><span class="m">1</span><span class="p">]],</span><span class="w"> </span><span class="nf">substitute</span><span class="p">(</span><span class="n">e1</span><span class="p">),</span><span class="w"> </span><span class="n">e2</span><span class="p">[</span><span class="m">-1</span><span class="p">]))</span>
<span class="w">    </span><span class="nf">eval</span><span class="p">(</span><span class="n">e2</span><span class="p">,</span><span class="w"> </span><span class="n">envir</span><span class="o">=</span><span class="nf">parent.frame</span><span class="p">())</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This function imputes `<code class="docutils literal notranslate"><span class="pre">e1</span></code>` as the first argument in a call
`<code class="docutils literal notranslate"><span class="pre">e2</span></code>` and then evaluates the new expression.</p>
<p>Example calls:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">x</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="kc">NA_real_</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="m">3</span><span class="p">,</span><span class="w"> </span><span class="kc">NA_real_</span><span class="p">,</span><span class="w"> </span><span class="m">5</span><span class="p">)</span>
<span class="n">x</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">mean</span><span class="w">  </span><span class="c1"># mean(x)</span>
<span class="c1">## [1] NA</span>
<span class="n">x</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="nf">`-`</span><span class="p">(</span><span class="m">1</span><span class="p">)</span><span class="w">  </span><span class="c1"># x-1</span>
<span class="c1">## [1]  0 NA  1  2 NA  4</span>
<span class="n">x</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">na.omit</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">mean</span><span class="w">  </span><span class="c1"># mean(na.omit(x))</span>
<span class="c1">## [1] 2.75</span>
<span class="n">x</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="nf">mean</span><span class="p">(</span><span class="n">na.rm</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span><span class="w">  </span><span class="c1"># mean(x, na.rm=TRUE)</span>
<span class="c1">## [1] 2.75</span>
</pre></div>
</div>
<p>Moreover, at the cost of forcing the evaluation of
the lefthand side argument (and thus losing the potential benefits
of lazy evaluation, including the access to the generating expression),
we can memorise the value of `<code class="docutils literal notranslate"><span class="pre">e1</span></code>` under the name, say, `<code class="docutils literal notranslate"><span class="pre">.</span></code>`
so that it can be referred to in the righthand side expression.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">`%.&gt;%`</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">function</span><span class="p">(</span><span class="n">e1</span><span class="p">,</span><span class="w"> </span><span class="n">e2</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">env</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">list2env</span><span class="p">(</span><span class="nf">list</span><span class="p">(</span><span class="n">.</span><span class="o">=</span><span class="n">e1</span><span class="p">),</span><span class="w"> </span><span class="n">parent</span><span class="o">=</span><span class="nf">parent.frame</span><span class="p">())</span>
<span class="w">    </span><span class="n">e2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.list</span><span class="p">(</span><span class="nf">substitute</span><span class="p">(</span><span class="n">e2</span><span class="p">))</span>
<span class="w">    </span><span class="n">e2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.call</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="n">e2</span><span class="p">[[</span><span class="m">1</span><span class="p">]],</span><span class="w"> </span><span class="nf">quote</span><span class="p">(</span><span class="n">.</span><span class="p">),</span><span class="w"> </span><span class="n">e2</span><span class="p">[</span><span class="m">-1</span><span class="p">]))</span>
<span class="w">    </span><span class="nf">eval</span><span class="p">(</span><span class="n">e2</span><span class="p">,</span><span class="w"> </span><span class="n">envir</span><span class="o">=</span><span class="n">env</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This way, we can refer to the value of the lefthand side
multiple times in a single call, for instance:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">set.seed</span><span class="p">(</span><span class="m">123</span><span class="p">);</span><span class="w"> </span><span class="nf">runif</span><span class="p">(</span><span class="m">5</span><span class="p">)</span><span class="w"> </span><span class="o">%.&gt;%</span><span class="w"> </span><span class="nf">`[`</span><span class="p">(</span><span class="n">.</span><span class="o">&gt;</span><span class="m">0.5</span><span class="p">)</span><span class="w">   </span><span class="c1"># x[x&gt;0.5] with x=runif(5)</span>
<span class="c1">## [1] 0.78831 0.88302 0.94047</span>
<span class="c1"># x[x&gt;=0.5] &lt;- 0.5 with x=round(runif(5), 2):</span>
<span class="nf">set.seed</span><span class="p">(</span><span class="m">123</span><span class="p">);</span><span class="w"> </span><span class="nf">runif</span><span class="p">(</span><span class="m">5</span><span class="p">)</span><span class="w"> </span><span class="o">%.&gt;%</span><span class="w"> </span><span class="nf">round</span><span class="p">(</span><span class="m">2</span><span class="p">)</span><span class="w"> </span><span class="o">%.&gt;%</span><span class="w"> </span><span class="nf">`[&lt;-`</span><span class="p">(</span><span class="n">.</span><span class="o">&gt;=</span><span class="m">0.5</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="o">=</span><span class="m">0.5</span><span class="p">)</span>
<span class="c1">## [1] 0.29 0.50 0.41 0.50 0.50</span>
</pre></div>
</div>
</section>
<section id="other-ideas">
<h3><span class="section-number">17.5.7. </span>Other ideas (**)<a class="headerlink" href="#other-ideas" title="Permalink to this heading">#</a></h3>
<p>Why stop ourselves here?
We can create a lot more invasive functions that
read some local variables in the calling functions
(unless they are primitive, because this is R and there
always have to be exceptions to general rules…).</p>
<p>Here is an operator, thanks to which we can select a range
of columns in a data frame between two given labels:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">`%:%`</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">function</span><span class="p">(</span><span class="n">e1</span><span class="p">,</span><span class="w"> </span><span class="n">e2</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1"># get the `x` argument in the caller (hoping its `[`)</span>
<span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="s">&quot;x&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">envir</span><span class="o">=</span><span class="nf">sys.frame</span><span class="p">(</span><span class="nf">sys.nframe</span><span class="p">()</span><span class="m">-1</span><span class="p">))</span>
<span class="w">    </span><span class="n">n</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">names</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="w">    </span><span class="n">from</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">pmatch</span><span class="p">(</span><span class="nf">substitute</span><span class="p">(</span><span class="n">e1</span><span class="p">),</span><span class="w"> </span><span class="n">n</span><span class="p">)</span>
<span class="w">    </span><span class="n">to</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">pmatch</span><span class="p">(</span><span class="nf">substitute</span><span class="p">(</span><span class="n">e2</span><span class="p">),</span><span class="w"> </span><span class="n">n</span><span class="p">)</span>
<span class="w">    </span><span class="n">from</span><span class="o">:</span><span class="n">to</span>
<span class="p">}</span>

<span class="nf">head</span><span class="p">(</span><span class="n">iris</span><span class="p">[,</span><span class="w"> </span><span class="n">Sepal.W</span><span class="o">%:%</span><span class="n">Petal.W</span><span class="p">])</span>
<span class="c1">##   Sepal.Width Petal.Length Petal.Width</span>
<span class="c1">## 1         3.5          1.4         0.2</span>
<span class="c1">## 2         3.0          1.4         0.2</span>
<span class="c1">## 3         3.2          1.3         0.2</span>
<span class="c1">## 4         3.1          1.5         0.2</span>
<span class="c1">## 5         3.6          1.4         0.2</span>
<span class="c1">## 6         3.9          1.7         0.4</span>
</pre></div>
</div>
<p>This function operates under the assumption that
it is called as an argument to a non-primitive function
which took the `<code class="docutils literal notranslate"><span class="pre">x</span></code>` argument being a named vector.</p>
<div class="proof proof-type-exercise" id="id33">

    <div class="proof-title">
        <span class="proof-type">Exercise 17.22</span>
        
    </div><div class="proof-content">
<p>Make the above more foolproof:</p>
<ul class="simple">
<li><p>if `<strong class="command">%:%</strong>` is used outside of
`<strong class="command">[</strong>` or `<strong class="command">[&lt;-</strong>`, raise a polite error,</p></li>
<li><p>allow `<code class="docutils literal notranslate"><span class="pre">x</span></code>` to be a matrix (is it possible?),</p></li>
<li><p>prepare better for the case of less expected inputs.</p></li>
</ul>
</div></div><div class="proof proof-type-exercise" id="id34">

    <div class="proof-title">
        <span class="proof-type">Exercise 17.23</span>
        
    </div><div class="proof-content">
<p>Modify the definition of the above operator so that both:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">iris</span><span class="p">[,</span><span class="w"> </span><span class="o">-</span><span class="n">Sepal.W</span><span class="o">%:%</span><span class="n">Petal.W</span><span class="p">]</span>
<span class="n">iris</span><span class="p">[,</span><span class="w"> </span><span class="o">-</span><span class="p">(</span><span class="n">Sepal.W</span><span class="o">%:%</span><span class="n">Petal.W</span><span class="p">)]</span>
</pre></div>
</div>
<p>mean “select everything except”.</p>
</div></div><div class="proof proof-type-exercise" id="id35">

    <div class="proof-title">
        <span class="proof-type">Exercise 17.24</span>
        
    </div><div class="proof-content">
<p>Define `<strong class="command">%:%</strong>` for data frames so that:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">x[%:%3,</span> <span class="pre">]</span></code> means “select the first three rows”,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">x[3%:%,</span> <span class="pre">]</span></code> means “select from the third to the end”,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">x[-3%:%,</span> <span class="pre">]</span></code> means “select from the third last to the end”,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">x[%:%-10,</span> <span class="pre">]</span></code> means “select all but last 9”.</p></li>
</ul>
</div></div><p>The ceiling is the limit. Just please, do not use the above in production.</p>
</section>
</section>
<section id="processing-formulae">
<span id="sec-formula"></span><h2><span class="section-number">17.6. </span>Processing formulae, `<strong class="command">~</strong>` (*)<a class="headerlink" href="#processing-formulae" title="Permalink to this heading">#</a></h2>
<p>Formulae were introduced to S in the early 1990s,
see <span id="id6">[<a class="reference internal" href="999-bibliography.html#id49" title="Chambers, J.M. and Hastie, T.J. (1991).  Statistical Models in S. Chapman &amp; Hall.">13</a>]</span>, originally with the purpose of specifying
<em>statistical models</em>; compare <a class="reference internal" href="220-s3.html#sec-formula-intro"><span class="std std-numref">Section 10.3.4</span></a>.</p>
<p>From the language perspective, they are merely unevaluated
calls to the `<strong class="command">~</strong>` (tilde) operator.
When creating them, we do not even have to apply <strong class="command">quote</strong>
explicitly. For instance:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">f</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">x1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">x2</span><span class="p">)</span><span class="w">  </span><span class="c1"># or: `~`(y, x1+x2)</span>
<span class="nf">mode</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="c1">## [1] &quot;call&quot;</span>
<span class="nf">class</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="c1">## [1] &quot;formula&quot;</span>
</pre></div>
</div>
<p>Hence, formulae are compound objects in the sense given
in <a class="reference internal" href="220-s3.html#chap-s3"><span class="std std-numref">Chapter 10</span></a>.</p>
<p>Usually, formulae are equipped with an additional attribute:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">attr</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;.Environment&quot;</span><span class="p">)</span>
<span class="c1">## &lt;environment: R_GlobalEnv&gt;</span>
</pre></div>
</div>
<div class="proof proof-type-exercise" id="id36">

    <div class="proof-title">
        <span class="proof-type">Exercise 17.25</span>
        
    </div><div class="proof-content">
<p>Create a function that generates
a list of formulae of the form “<code class="docutils literal notranslate"><span class="pre">y</span> <span class="pre">~</span> <span class="pre">x1+x2+...+xk</span></code>”,
for all possible combinations <code class="docutils literal notranslate"><span class="pre">x1</span></code>, <code class="docutils literal notranslate"><span class="pre">x2</span></code>, …, <code class="docutils literal notranslate"><span class="pre">xk</span></code> (of any cardinality)
of elements in a given set of <code class="docutils literal notranslate"><span class="pre">xs</span></code>. For instance:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">formula_allcomb</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">function</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">xs</span><span class="p">,</span><span class="w"> </span><span class="n">env</span><span class="o">=</span><span class="nf">parent.frame</span><span class="p">())</span><span class="w"> </span><span class="n">...to.do...</span>
<span class="nf">str</span><span class="p">(</span><span class="nf">formula_allcomb</span><span class="p">(</span><span class="s">&quot;len&quot;</span><span class="p">,</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;supp&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;dose&quot;</span><span class="p">)))</span>
<span class="c1">## List of 3</span>
<span class="c1">##  $ :Class &#39;formula&#39;  language len ~ supp + dose</span>
<span class="c1">##   .. ..- attr(*, &quot;.Environment&quot;)=&lt;environment: R_GlobalEnv&gt;</span>
<span class="c1">##  $ :Class &#39;formula&#39;  language len ~ dose</span>
<span class="c1">##   .. ..- attr(*, &quot;.Environment&quot;)=&lt;environment: R_GlobalEnv&gt;</span>
<span class="c1">##  $ :Class &#39;formula&#39;  language len ~ supp</span>
<span class="c1">##   .. ..- attr(*, &quot;.Environment&quot;)=&lt;environment: R_GlobalEnv&gt;</span>
<span class="nf">str</span><span class="p">(</span><span class="nf">formula_allcomb</span><span class="p">(</span>
<span class="w">    </span><span class="s">&quot;y&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;x1&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;x2&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;x3&quot;</span><span class="p">),</span>
<span class="w">    </span><span class="n">env</span><span class="o">=</span><span class="kc">NULL</span>
<span class="p">))</span>
<span class="c1">## List of 7</span>
<span class="c1">##  $ :Class &#39;formula&#39;  language y ~ x1 + x2 + x3</span>
<span class="c1">##  $ :Class &#39;formula&#39;  language y ~ x2 + x3</span>
<span class="c1">##  $ :Class &#39;formula&#39;  language y ~ x1 + x3</span>
<span class="c1">##  $ :Class &#39;formula&#39;  language y ~ x3</span>
<span class="c1">##  $ :Class &#39;formula&#39;  language y ~ x1 + x2</span>
<span class="c1">##  $ :Class &#39;formula&#39;  language y ~ x2</span>
<span class="c1">##  $ :Class &#39;formula&#39;  language y ~ x1</span>
</pre></div>
</div>
</div></div><div style="margin-top: 1em"></div><p>As they are unevaluated expressions, functions can assign any fantastic
meaning to formulae, and we cannot really do anything about it.
However, many functions, especially in the <strong class="program">stats</strong>
and <strong class="program">graphics</strong> packages, rely on a call to <strong class="command">model.frame</strong>
and related routines. Thanks to this,
we can at least find some behavioural patters.
In particular, <strong class="command">help</strong><code class="code docutils literal notranslate"><span class="pre">(&quot;formula&quot;)</span></code> lists some typical meanings of operators
that can be used in a formula.</p>
<div class="proof proof-type-example" id="id37">

    <div class="proof-title">
        <span class="proof-type">Example 17.26</span>
        
    </div><div class="proof-content">
<p>Here are a few examples (executing the expressions below is left
as an exercise).</p>
<ul>
<li><p>Draw a boxplot for <code class="docutils literal notranslate"><span class="pre">iris[[&quot;Sepal.Length&quot;]]</span></code>
split by <code class="docutils literal notranslate"><span class="pre">iris[[&quot;Species&quot;]]</span></code>:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">boxplot</span><span class="p">(</span><span class="n">Sepal.Length</span><span class="o">~</span><span class="n">Species</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="o">=</span><span class="n">iris</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>Draw a boxplot for <code class="docutils literal notranslate"><span class="pre">ToothGrowth[[&quot;len&quot;]]</span></code> split by a combination of
levels in
<code class="docutils literal notranslate"><span class="pre">ToothGrowth[[&quot;supp&quot;]]</span></code> and <code class="docutils literal notranslate"><span class="pre">ToothGrowth[[&quot;dose&quot;]]</span></code>:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">boxplot</span><span class="p">(</span><span class="n">len</span><span class="o">~</span><span class="n">supp</span><span class="o">:</span><span class="n">dose</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="o">=</span><span class="n">ToothGrowth</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>Split the given data frame by a combination of values in two
specified columns therein:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">split</span><span class="p">(</span><span class="n">ToothGrowth</span><span class="p">,</span><span class="w"> </span><span class="o">~</span><span class="n">supp</span><span class="o">:</span><span class="n">dose</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>Fit a linear regression model of the form
<span class="math notranslate nohighlight">\(y=a+bx\)</span>, where <span class="math notranslate nohighlight">\(y\)</span> is  <code class="docutils literal notranslate"><span class="pre">iris[[&quot;Sepal.Length&quot;]]</span></code>
and <span class="math notranslate nohighlight">\(x\)</span> is <code class="docutils literal notranslate"><span class="pre">iris[[&quot;Petal.Length&quot;]]</span></code>:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">lm</span><span class="p">(</span><span class="n">Sepal.Length</span><span class="o">~</span><span class="n">Petal.Length</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="o">=</span><span class="n">iris</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>Fit a linear regression model of the form
<span class="math notranslate nohighlight">\(z=ax+by\)</span>, where <span class="math notranslate nohighlight">\(z\)</span> is <code class="docutils literal notranslate"><span class="pre">iris[[&quot;Sepal.Length&quot;]]</span></code>,
<span class="math notranslate nohighlight">\(x\)</span> is <code class="docutils literal notranslate"><span class="pre">iris[[&quot;Petal.Length&quot;]]</span></code>, and
<span class="math notranslate nohighlight">\(y\)</span> is <code class="docutils literal notranslate"><span class="pre">iris[[&quot;Sepal.Width&quot;]]</span></code> (without the intercept term):</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">lm</span><span class="p">(</span><span class="n">Sepal.Length</span><span class="o">~</span><span class="n">Petal.Length</span><span class="o">+</span><span class="n">Sepal.Width</span><span class="m">+0</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="o">=</span><span class="n">iris</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>Fit a linear regression model of the form
<span class="math notranslate nohighlight">\(z=a+bx+cy+dxy\)</span>, where <span class="math notranslate nohighlight">\(z\)</span> is <code class="docutils literal notranslate"><span class="pre">iris[[&quot;Sepal.Length&quot;]]+e</span></code>
(with `<code class="docutils literal notranslate"><span class="pre">e</span></code>` fetched from the associated environment),
and <span class="math notranslate nohighlight">\(x\)</span> and <span class="math notranslate nohighlight">\(y\)</span> are like above:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">e</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">rnorm</span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">iris</span><span class="p">[[</span><span class="s">&quot;Sepal.Length&quot;</span><span class="p">]]),</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">0.05</span><span class="p">)</span>
<span class="nf">lm</span><span class="p">(</span><span class="nf">I</span><span class="p">(</span><span class="n">Sepal.Length</span><span class="o">+</span><span class="n">e</span><span class="p">)</span><span class="o">~</span><span class="n">Petal.Length</span><span class="o">*</span><span class="n">Sepal.Width</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="o">=</span><span class="n">iris</span><span class="p">)</span>
</pre></div>
</div>
</li>
</ul>
</div></div><p>From the perspective of this book, which focuses on more universal
aspects of the R language, formulas are enough interesting
to describe them in any more detail. However, the kind reader
is now equipped with all the necessary knowledge to solve
the following very educative exercise.</p>
<div class="proof proof-type-exercise" id="id38">

    <div class="proof-title">
        <span class="proof-type">Exercise 17.27</span>
        
    </div><div class="proof-content">
<p>Study the source code of
<strong class="command">graphics:::boxplot.formula</strong>,
<strong class="command">stats::lm</strong>,
and <strong class="command">stats:::t.test.formula</strong>
and take note of how they prepare and process
the calls to <strong class="command">model.frame</strong>,
<strong class="command">model.matrix</strong>,
<strong class="command">model.response</strong>,
<strong class="command">model.weights</strong>, etc.</p>
<p>Note that their main aim is to prepare data to be passed
to <strong class="command">boxplot.default</strong>, <strong class="command">lm.fit</strong> (it is just a function
with such a name),
and <strong class="command">t.test.default</strong></p>
</div></div><div class="proof proof-type-exercise" id="id39">

    <div class="proof-title">
        <span class="proof-type">Exercise 17.28</span>
        
    </div><div class="proof-content">
<p>Write a function similar to <strong class="command">curve</strong>,
but one that allows to specify the function to plot using a formula.</p>
</div></div></section>
<section id="exercises">
<h2><span class="section-number">17.7. </span>Exercises<a class="headerlink" href="#exercises" title="Permalink to this heading">#</a></h2>
<div class="proof proof-type-exercise" id="id40">

    <div class="proof-title">
        <span class="proof-type">Exercise 17.29</span>
        
    </div><div class="proof-content">
<p>Answer the following questions.</p>
<ul class="simple">
<li><p>What is the role of promises?</p></li>
<li><p>Why do we generally discourage the use of functions relying on
metaprogramming?</p></li>
<li><p>How are default arguments evaluated?</p></li>
<li><p>Is there anything special about formulae, from the language perspective?</p></li>
<li><p>R evaluates function arguments lazily.
Does it mean that
“<code class="docutils literal notranslate"><span class="pre">y[</span></code><strong class="command">c</strong><code class="code docutils literal notranslate"><span class="pre">(</span></code><strong class="command">length</strong><code class="code docutils literal notranslate"><span class="pre">(y)+1,</span> </code><strong class="command">length</strong><code class="code docutils literal notranslate"><span class="pre">(y)+1,</span> </code><strong class="command">length</strong><code class="code docutils literal notranslate"><span class="pre">(y)+1)]</span> <span class="pre">&lt;-</span> </code><strong class="command">list</strong><code class="code docutils literal notranslate"><span class="pre">(1,</span> <span class="pre">2,</span> <span class="pre">3)</span></code>”
extends a list `<code class="docutils literal notranslate"><span class="pre">y</span></code>` by three elements?
Or are there cases where evaluation is eager?</p></li>
</ul>
</div></div><div class="proof proof-type-exercise" id="id41">

    <div class="proof-title">
        <span class="proof-type">Exercise 17.30</span>
        
    </div><div class="proof-content">
<p>Given:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">test</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="o">=</span><span class="nf">deparse</span><span class="p">(</span><span class="nf">substitute</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span><span class="w"> </span><span class="n">force_first</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="nf">if </span><span class="p">(</span><span class="n">force_first</span><span class="p">)</span><span class="w"> </span><span class="n">y</span><span class="w">  </span><span class="c1"># just force the evaluation of y here</span>
<span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">x</span><span class="o">**</span><span class="m">2</span>
<span class="w">    </span><span class="nf">print</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Why the two following calls give different results?</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">test</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="m">5</span><span class="p">)</span>
<span class="c1">## [1] &quot;c(1, 4, 9, 16, 25)&quot;</span>
<span class="nf">test</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="m">5</span><span class="p">,</span><span class="w"> </span><span class="n">force_first</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span>
<span class="c1">## [1] &quot;1:5&quot;</span>
</pre></div>
</div>
</div></div></section>
<section id="outro">
<h2><span class="section-number">17.8. </span>Outro<a class="headerlink" href="#outro" title="Permalink to this heading">#</a></h2>
<p>Let us recall our first approximation to the classification
of R Data Types that we presented in the <a class="reference internal" href="000-preface.html#chap-preface"><span class="std std-ref">Preface</span></a>.
As a summary of what we have covered in this book, let us contemplate
upon <a class="reference internal" href="#fig-data-types-full"><span class="std std-numref">Figure 17.2</span></a>, which gives a much broader picture.</p>
<figure class="align-default" id="id42">
<span id="fig-data-types-full"></span><img alt="../_images/data-types-full.png" src="../_images/data-types-full.png" />
<figcaption>
<p><span class="caption-number">Figure 17.2 </span><span class="caption-text">R data types</span><a class="headerlink" href="#id42" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<p>If we omitted something, it was most likely on purpose –
either we can now study it on our own easily, it is not really
worth our attention, or it violates our <em>minimalist</em> design principles
that we explained in the <a class="reference internal" href="000-preface.html#chap-preface"><span class="std std-ref">Preface</span></a>.</p>
<p>Now that we have reached the end of this course,
we might be interested in reading the following materials:</p>
<ul class="simple">
<li><p><em>R Language Definition</em> <span id="id7">[<a class="reference internal" href="999-bibliography.html#id10" title="R Development Core Team. (2023).  R Language Definition. URL: https://CRAN.R-project.org/doc/manuals/r-release/R-lang.html.">55</a>]</span>,</p></li>
<li><p><em>R Internals</em> <span id="id8">[<a class="reference internal" href="999-bibliography.html#id12" title="R Development Core Team. (2023).  R Internals. URL: https://CRAN.R-project.org/doc/manuals/r-release/R-ints.html.">54</a>]</span>,</p></li>
<li><p><em>Writing R Extensions</em> <span id="id9">[<a class="reference internal" href="999-bibliography.html#id14" title="R Development Core Team. (2023).  Writing R Extensions. URL: https://CRAN.R-project.org/doc/manuals/r-release/R-exts.html.">51</a>]</span>,</p></li>
<li><p>R’s source code available at <a class="reference external" href="https://cran.r-project.org/src/base/">https://cran.r-project.org/src/base/</a>,</p></li>
<li><p>The open-access
<a class="reference external" href="https://datawranglingpy.gagolewski.com/"><em>Minimalist data wrangling with Python</em></a> <span id="id10">[<a class="reference internal" href="999-bibliography.html#id3" title="Gagolewski, M. (2022).  Minimalist Data Wrangling with Python. Zenodo, Melbourne. URL: https://datawranglingpy.gagolewski.com/, DOI: 10.5281/zenodo.6451068.">25</a>]</span> by yours truly.</p></li>
</ul>
<p>Also, the <code class="docutils literal notranslate"><span class="pre">NEWS</span></code> files available at
<a class="reference external" href="https://cran.r-project.org/doc/manuals/r-release/">https://cran.r-project.org/doc/manuals/r-release/</a>
will keep us up to date with new features, bug fixes,
and deprecated functionality; see also the <strong class="command">news</strong> function.</p>
<p>Good luck!</p>
<hr class="footnotes docutils" />
<aside class="footnote-list brackets">
<aside class="footnote brackets" id="footnomemoisation" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id2">1</a><span class="fn-bracket">]</span></span>
<p>But without the memoisation of results generated by
expressions, which is available, e.g., in Haskell.
In other words, in an expression like
<strong class="command">c</strong><code class="code docutils literal notranslate"><span class="pre">(</span></code><strong class="command">f</strong><code class="code docutils literal notranslate"><span class="pre">(x),</span> </code><strong class="command">f</strong><code class="code docutils literal notranslate"><span class="pre">(x))</span></code>,
the call <strong class="command">f</strong><code class="code docutils literal notranslate"><span class="pre">(x)</span></code> will still be performed twice.</p>
</aside>
<aside class="footnote brackets" id="footconfuse" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id5">2</a><span class="fn-bracket">]</span></span>
<p>Novices are prone to overgeneralising when they learn new
material that they are still far from comfortable with,
so such exceptions go against this natural coping strategy of theirs.</p>
</aside>
</aside>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="998-changelog.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Changelog</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="330-environment.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title"><span class="section-number">16. </span>🚧 Environments and evaluation (*)</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
              
              
              Copyright &#169; 2022–2023 by <a href="https://www.gagolewski.com">Marek Gagolewski</a>.
              Some rights reserved. Licensed under <a href='https://creativecommons.org/licenses/by-nc-nd/4.0/'>CC BY-NC-ND 4.0</a>.
              Built with <a href="https://sphinx-doc.org/">Sphinx</a>
              and a customised <a href="https://github.com/pradyunsg/furo">Furo</a> theme.
              Last updated on 2023-04-08T18:12:50+1000.
              This site will never display any ads: it is a non-profit project.
              It does not collect any data.
            </div>
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            In this chapter
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">17. 🚧 Lazy evaluation (**)</a><ul>
<li><a class="reference internal" href="#evaluation-of-function-arguments">17.1. Evaluation of function arguments</a></li>
<li><a class="reference internal" href="#evaluation-of-default-arguments">17.2. Evaluation of default arguments</a></li>
<li><a class="reference internal" href="#ellipsis-revisited">17.3. Ellipsis, `<code class="code docutils literal notranslate"><span class="pre">...</span></code>`,  revisited</a></li>
<li><a class="reference internal" href="#on-exit">17.4. <strong class="command">on.exit</strong> (*)</a></li>
<li><a class="reference internal" href="#metaprogramming-in-action-examples">17.5. Metaprogramming in action: Examples (*)</a><ul>
<li><a class="reference internal" href="#match-arg">17.5.1. <strong class="command">match.arg</strong></a></li>
<li><a class="reference internal" href="#curve">17.5.2. <strong class="command">curve</strong></a></li>
<li><a class="reference internal" href="#with-and-within">17.5.3. <strong class="command">with</strong> and <strong class="command">within</strong></a></li>
<li><a class="reference internal" href="#transform">17.5.4. <strong class="command">transform</strong></a></li>
<li><a class="reference internal" href="#subset">17.5.5. <strong class="command">subset</strong></a></li>
<li><a class="reference internal" href="#a-forward-pipe-operator">17.5.6. A forward-pipe operator</a></li>
<li><a class="reference internal" href="#other-ideas">17.5.7. Other ideas (**)</a></li>
</ul>
</li>
<li><a class="reference internal" href="#processing-formulae">17.6. Processing formulae, `<strong class="command">~</strong>` (*)</a></li>
<li><a class="reference internal" href="#exercises">17.7. Exercises</a></li>
<li><a class="reference internal" href="#outro">17.8. Outro</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/scripts/furo.js"></script>
    <script src="../_static/proof.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    </body>
</html>